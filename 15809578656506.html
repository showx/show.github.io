

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    --- - shengsheng的博客
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="shengsheng的博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">---</h1>
        <p class="post-date">
                <span>Posted <time datetime="2020/02/06" itemprop="datePublished">2020/02/06</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<p>layout: post<br/>
title: nginx rewrite 的语法<br/>
date: 2014-09-08 19:58<br/>
author: admin<br/>
comments: true</p>

<h2 id="toc_0">categories: []</h2>

<p>Nginx Rewrite规则相关指令 <br/>
Nginx Rewrite规则相关指令有if、rewrite、set、return、break等，其中rewrite是最关键的指令。</p>

<p>rewrite 的语法</p>

<p>语法: rewrite regex replacement flag</p>

<p>默认: none</p>

<p>作用域: server, location, if</p>

<p>This directive changes URI in accordance with the regular expression and the replacement string. Directives are carried out in order of appearance in the configuration file.</p>

<p>这个指令根据表达式来更改URI，或者修改字符串。指令根据配置文件中的顺序来执行。</p>

<p>Be aware that the rewrite regex only matches the relative path instead of the absolute URL. If you want to match the hostname, you should use an if condition, like so:</p>

<p>注意重写表达式只对相对路径有效。如果你想配对主机名，你应该使用if语句。</p>

<p>rewrite只是会改写路径部分的东东，不会改动用户的输入参数，因此这里的if规则里面，你无需关心用户在浏览器里输入的参数，rewrite后会自动添加的，因此，我们只是加上了一个？号和后面我们想要的一个小小的参数 ***https=1就可以了。</p>

<p>nginx的rewrite规则参考：</p>

<p>~ 为区分大小写匹配<br/>
~* 为不区分大小写匹配<br/>
!~和!~*分别为区分大小写不匹配及不区分大小写不匹<br/>
-f和!-f用来判断是否存在文件<br/>
-d和!-d用来判断是否存在目录<br/>
-e和!-e用来判断是否存在文件或目录<br/>
-x和!-x用来判断文件是否可执行<br/>
last 相当于Apache里的[L]标记，表示完成rewrite，呵呵这应该是最常用的<br/>
break 终止匹配, 不再匹配后面的规则<br/>
redirect 返回302临时重定向 地址栏会显示跳转后的地址<br/>
permanent 返回301永久重定向 地址栏会显示跳转后的地址<br/>
nginx有以下内置变量<br/>
$args, 请求中的参数;</p>

<p>$content_length, HTTP请求信息里的&quot;Content-Length&quot;;</p>

<p>$content_type, 请求信息里的&quot;Content-Type&quot;;</p>

<p>$document_root, 针对当前请求的根路径设置值;</p>

<p>\(document_uri, 与\)uri相同;</p>

<p>$host, 请求信息中的&quot;Host&quot;，如果请求中没有Host行，则等于设置的服务器名;</p>

<p>$limit_rate, 对连接速率的限制;</p>

<p>$request_method, 请求的方法，比如&quot;GET&quot;、&quot;POST&quot;等;</p>

<p>$remote_addr, 客户端地址;</p>

<p>$remote_port, 客户端端口号;</p>

<p>$remote_user, 客户端用户名，认证用;</p>

<p>$request_filename, 当前请求的文件路径名</p>

<p>$request_body_file</p>

<p>$request_uri, 请求的URI，带查询字符串;</p>

<p>\(query_string, 与\)args相同;</p>

<p>\(scheme, 所用的协议，比如http或者是https，比如rewrite  ^(.+)\)  \(scheme://example.com\)1  redirect;</p>

<p>$server_protocol, 请求的协议版本，&quot;HTTP/1.0&quot;或&quot;HTTP/1.1&quot;;</p>

<p>$server_addr, 服务器地址，如果没有用listen指明服务器地址，使用这个变量将发起一次系统调用以取得地址(造成资源浪费);</p>

<p>$server_name, 请求到达的服务器名;</p>

<p>$server_port, 请求到达的服务器端口号;</p>

<p>$uri, 请求的URI，可能和最初的值有不同，比如经过重定向之类的。</p>

<p>这些变量可以用在rewrite规则里，也可以打印日志的时候用<br/>
nginx 日志<br/>
nginx 日志相关指令主要有两条，一条是log_format，用来设置日志格式，另外一条是access_log，用来指定日志文件的存放路径、格式和缓存大 小，通俗的理解就是先用log_format来决定把哪些信息打印到日志里，然后在用zccess_log定义虚拟主机时或全局日志时 在把定义的log_format 跟在后面；<br/>
log_format 格式:<br/>
log_format     main        &#39;\(remote_addr - \)remote_user [\(time_local] &quot;\)request&quot; &#39;<br/>
                                          &#39;\(status \)body_bytes_s ent &quot;\(http_referer&quot; &#39;   <br/>
                                          &#39;&quot;\)http_user_agent&quot; &quot;\(http_x_forwarded_for&quot;&#39;;<br/>
main表示给后面定义的日志个数取了个名为main的名称，便于在access_log指令中引用<br/>
上面的log_format打印出来的日志形如<br/>
 111.22.33.44 - - [10/Jan/2001:02:14:14 +0200] &quot;GET / HTTP/1.1&quot; 200 1234 &quot;http://www.xxx.com/from.htm&quot; &quot;Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)&quot;<br/>
对比日志格式和输出的结果可以发现，日志格式用一对单引号包起来，多个日志格式段用可以放在不同的行，最后用分号(;)结尾<br/>
单引号中的双引号(&quot;),空白符，中括号([)等字符原样输出，比较长的字符串通常用双引号(&quot;)包起来，看起来不容易更加清楚，\)开始的变量会替换为真实的值</p>

<p>$remote_user 为-表示没有值<br/>
access_log 指令示例<br/>
access_log  /home/example/nginx/logs/access.log  main;<br/>
/home/example/nginx/logs/access.log表示nginx日志将输出到该文件，每条日志内容如main定义</p>

<p>多目录转成参数<br/>
abc.domian.com/sort/2 =&gt; abc.domian.com/index.php?act=sort&amp;name=abc&amp;id=2</p>

<p>if ($host ~* (.*).domain.com) {</p>

<h1 id="toc_1">~*不区分大小写匹配，</h1>

<h1 id="toc_2">&#39;.&#39; 匹配任意单个字符</h1>

<h1 id="toc_3">()表示将()里面的匹配结果保存到变量中，第一个括号中匹配的放在\(1变量，第二个括号中匹配的值放在\)2中，依此类推</h1>

<h1 id="toc_4">开始一个新的匹配，会把\(1等变量的值替换为新的匹配的值，这里\)1的值为abc</h1>

<h1 id="toc_5">为了保存匹配结果，可以像下面的行那样，将匹配的结果放在一个新的变量中</h1>

<p>set \(sub_name \)1;</p>

<h1 id="toc_6">这里开始一次新的匹配，$1的值变成了新的值2</h1>

<h1 id="toc_7">每一次rewrite的第一个参数对应的是host后面的字符串，这里表示/sort/2</h1>

<h1 id="toc_8">这个也有待验证，还有就是如果第二次只有两个括号，第一次有三个，则 $3的值是多少？</h1>

<h1 id="toc_9">rewrite 第一个参数最后的\/? 表示最后可以带/也可以不带/</h1>

<p>rewrite <sup>/sort\/(\d+)\/?$</sup> /index.php?act=sort&amp;name=\(sub_name&amp;id=\)1 last;<br/>
}<br/>
待验证问题：</p>

<p>if (\(host ~* (.*)\.domain\.co) <br/>
是说 不区分大小写的情况下，\)host中是否包含(.*).domain.co模式，因此$host=abc.domain.com也算匹配模式</p>

<p>要排除.com需要在模式后加\(符号，即修改为if (\)host ~* (.*).domain.co$) <br/>
目录对换<br/>
/123456/xxxx -&gt; /xxxx?id=123456</p>

<p>rewrite <sup>/(\d+)/(.+)/</sup> /\(2?id=\)1 last;<br/>
我自己写的是这样的</p>

<pre><code class="language-text">    rewrite ^/\/(\d+)\/(\w+)\/? /$2?id=$1 last;
</code></pre>

<p>‘.’匹配任意单个字符，.+则匹配至少包含一个字符的任意字符串，给出的结果其实是将第一级目录放到之后目录的后面</p>

<p>/123456/abc/def/ rewrite后结果为/abc/def?id=123456</p>

<p>注意：/123456/abc/def/最后一个/都被去掉了</p>

<p>例如下面设定nginx在用户使用ie浏览器访问的时候，重定向到/nginx-ie目录下：</p>

<p>if ($http_user_agent ~ MSIE) {</p>

<h1 id="toc_10">~ 区分大小写匹配</h1>

<p>rewrite <sup>.*</sup>\( /nginx-ie/\)1 break;<br/>
}<br/>
下面是 \(http_user_agent取值的一个例子<br/>
&quot;\)http_user_agent&quot; &quot;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; InfoPath.3; .NET4.0E)&quot;</p>

<p>上面的例子是用Mozilla浏览器访问，但是仍然包含MSIE子串，因此，上面的rewrite规则应该是不严格的，应该用if ($http_user_agent ~ <sup>MSIE)，限定以</sup> MSIE开头更加严格<br/>
目录自动加“/”</p>

<p>if (-d \(request_filename){<br/>
rewrite ^/(.*)([^/])\) http://\(host/\)1\(2/ permanent;<br/>
}<br/>
用([^/])匹配最后一个非&#39;/&#39;的字符,然后自己强行再添加一个&#39;/&#39;(\)2变量后的那个）</p>

<p>Location 指令</p>

<p>是用来为匹配的 URI 进行配置，URI 即语法中的&quot;/uri/&quot;，可以是字符串或正则表达式。但如果要使用正则表达式，则必须指定前缀。</p>

<p>我的理解是：如果URI中包含某个模式，则进行后面的处理。<br/>
基本语法<br/>
location [ =|~|~<em>|<sup>~|@</sup> ] /uri/ { … }<br/>
〖=〗 表示精确匹配，如果找到，立即停止搜索并立即处理此请求。<br/>
〖~ 〗 表示区分大小写匹配<br/>
〖~</em>〗 表示不区分大小写匹配<br/>
〖<sup>~</sup> 〗 表示只匹配字符串,不查询正则表达式。<br/>
〖@〗 指定一个命名的location，一般只用于内部重定向请求。<br/>
匹配过程<br/>
首先对字符串进行匹配查询，最确切的匹配将被使用。然后，正则表达式的匹配查询开始，匹配第一个结果后会停止搜索，如果没有找到正则表达式，将使用字符串的搜索结果，如果字符串和正则都匹配，那么正则优先级较高。<br/>
配置实例<br/>
location  = / {<br/>
  # 只匹配对 / 目录的查询.<br/>
  [ config A ]<br/>
}<br/>
location  / {<br/>
  # 匹配以 / 开始的查询，即所有查询都匹配。<br/>
  [ config B ]<br/>
}<br/>
location <sup>~</sup> /images/ {<br/>
  # 匹配以 /images/ 开始的查询，不再检查正则表达式。<br/>
  [ config C ]<br/>
}<br/>
location ~* .(gif|jpg|jpeg)$ {<br/>
  # 匹配以gif, jpg, or jpeg结尾的文件，但优先级低于config C。<br/>
  [ config D ]<br/>
}<br/>
禁止ht access</p>

<p>location ~/.ht {</p>

<h1 id="toc_11">ht是一个文件或目录,无论ht在哪一级，都禁止访问）</h1>

<p>deny all;<br/>
}<br/>
禁止多个目录</p>

<p>location ~ <sup>/(cron|templates)/</sup> {</p>

<h1 id="toc_12">禁止访问第一级目录中名为cron或templates的目录</h1>

<p>deny all;<br/>
break;<br/>
}<br/>
禁止以/data开头的文件<br/>
可以禁止/data目录下所有文件的访问;</p>

<p>location ~ <sup>/data</sup> {<br/>
deny all;<br/>
}<br/>
禁止单个文件</p>

<p>location ~ /data/sql/data.sql {<br/>
deny all;<br/>
}<br/>
expires<br/>
语法： expires [time|epoch|max|off]<br/>
默认值： expires off<br/>
作用域： http, server, location<br/>
该指令可以控制HTTP应答中的“Expires”和“Cache-Control”的头标，（起到控制页面缓存的作用）。可以在time值中使用正数或负数。“Expires”头标的值将通过当前系统时间加上设定的 time 值来获得。<br/>
epoch 指定“Expires”的值为 1 January, 1970, 00:00:01 GMT。<br/>
max 指定“Expires”的值为 31 December 2037 23:59:59 GMT，“Cache-Control”的值为10年。<br/>
-1 指定“Expires”的值为 服务器当前时间 -1s,即永远过期<br/>
“Cache-Control”头标的值由指定的时间来决定：<br/>
    负数：Cache-Control: no-cache<br/>
    正数或零：Cache-Control: max-age = #, # 为指定时间的秒数s。其他的单位有d（天），h（小时）</p>

<p>&quot;off&quot; 表示不修改“Expires”和“Cache-Control”的值<br/>
控制图片等过期时间为30天，这个时间可以设置的更长。具体视情况而定<br/>
location ~ .(gif|jpg|jpeg|png|bmp|ico)$ {</p>

<pre><code class="language-text">       log_not_found off;  #不记录404 not  found 错误日志
       expires 30d;

       break;
   }
</code></pre>

<p>控制匹配/resource/或者/mediatorModule/里所有的文件缓存设置到最长时间<br/>
        location ~ /(resource|mediatorModule)/ {<br/>
                root    /opt/demo;<br/>
                expires max;<br/>
        }</p>

<p>设定某个文件的过期时间;这里为600秒，并不记录访问日志</p>

<p>location <sup>~</sup> /html/scripts/loadhead_1.js {<br/>
access_log   off;<br/>
root /opt/lampp/htdocs/web;<br/>
expires 600;<br/>
break;<br/>
}<br/>
文件反盗链并设置过期时间<br/>
这里的return 412 为自定义的http状态码，默认为403，方便找出正确的盗链的请求<br/>
“rewrite <sup>/</sup> <a href="http://xx.xx.com/leech.gif;%E2%80%9D%E6%98%BE%E7%A4%BA%E4%B8%80%E5%BC%A0%E9%98%B2%E7%9B%97%E9%93%BE%E5%9B%BE%E7%89%87">http://xx.xx.com/leech.gif;”显示一张防盗链图片</a><br/>
“access_log off;”不记录访问日志，减轻压力<br/>
“expires 3d”所有文件3天的浏览器缓存</p>

<p>location ~* <sup>.+.(jpg|jpeg|gif|png|swf|rar|zip|css|js)$</sup> {<br/>
valid_referers none blocked *.xx.com *.xx.net localhost 208.97.167.194;<br/>
if ($invalid_referer) {<br/>
rewrite <sup>/</sup> <a href="http://xx.xx.com/leech.gif">http://xx.xx.com/leech.gif</a>;<br/>
return 412;<br/>
break;<br/>
}<br/>
access_log   off;<br/>
root /opt/lampp/htdocs/web;<br/>
expires 3d;<br/>
break;<br/>
}<br/>
设置GZIP<br/>
一般情况下压缩后的html、css、js、php、jhtml等文件，大小能降至原来的25%，也就是说，原本一个100k的html，压缩后只剩下25k。这无疑能节省很多带宽，也能降低服务器的负载。<br/>
在nginx中配置gzip比较简单<br/>
具体可见<a href="http://wiki.codemongers.com/NginxChsHttpGzipModule">http://wiki.codemongers.com/NginxChsHttpGzipModule</a><br/>
一般情况下只要在nginx.conf的http段中加入下面几行配置即可<br/>
   gzip  on;<br/>
   gzip_min_length  1000;<br/>
   gzip_buffers     4 8k;<br/>
   gzip_types       text/plain application/x-javascript text/css text/html application/xml;</p>

<p>可以通过网页gzip检测工具来检测网页是否启用了gzip<br/>
只充许固定ip访问网站，并加上密码</p>

<p>root  /opt/htdocs/www;<br/>
allow   208.97.167.194;<br/>
allow   222.33.1.2;<br/>
allow   231.152.49.4;<br/>
deny    all;<br/>
auth_basic “C1G_ADMIN”;<br/>
auth_basic_user_file htpasswd;<br/>
将多级目录下的文件转成一个文件，增强seo效果<br/>
/job-123-456-789.html 指向/job/123/456/789.html</p>

<p>rewrite <sup>/job-([0-9]+)-([0-9]+)-([0-9]+).html$</sup> /job/\(1/\)2/jobshow_$3.html last;<br/>
将根目录下某个文件夹指向2级目录<br/>
如/shanghaijob/ 指向 /area/shanghai/<br/>
如果你将last改成permanent，那么浏览器地址栏显是/location/shanghai/</p>

<p>rewrite <sup>/([0-9a-z]+)job/(.*)$</sup> /area/\(1/\)2 last;<br/>
上面例子有个问题是访问/shanghai 时将不会匹配</p>

<p>rewrite <sup>/([0-9a-z]+)job$</sup> /area/\(1/ last;<br/>
rewrite ^/([0-9a-z]+)job/(.*)\) /area/\(1/\)2 last;<br/>
这样/shanghai 也可以访问了，但页面中的相对链接无法使用，<br/>
如./list_1.html真实地址是/area/shanghia/list_1.html会变成/list_1.html,导至无法访问。</p>

<p>那我加上自动跳转也是不行咯<br/>
(-d $request_filename)它有个条件是必需为真实目录，而我的rewrite不是的，所以没有效果</p>

<p>if (-d \(request_filename){<br/>
rewrite ^/(.*)([^/])\) http://\(host/\)1$2/ permanent;<br/>
}<br/>
知道原因后就好办了，让我手动跳转吧</p>

<p>rewrite <sup>/([0-9a-z]+)job$</sup> /\(1job/ permanent;<br/>
rewrite ^/([0-9a-z]+)job/(.*)\) /area/\(1/\)2 last;<br/>
文件和目录不存在的时候重定向：</p>

<p>if (!-e $request_filename) {<br/>
proxy_pass <a href="http://127.0.0.1">http://127.0.0.1</a>;<br/>
}<br/>
域名跳转</p>

<p>server<br/>
{<br/>
listen       80;<br/>
server_name  jump.xx.com;<br/>
index index.html index.htm index.php;<br/>
root  /opt/lampp/htdocs/www;<br/>
rewrite <sup>/</sup> <a href="http://www.xx.com/">http://www.xx.com/</a>;<br/>
access_log  off;<br/>
}<br/>
多域名转向</p>

<p>server_name  <a href="http://www.xx.com/">www.xx.com/</a>  <a href="http://www.xx.com/">www.xx.com/</a>;<br/>
index index.html index.htm index.php;<br/>
root  /opt/lampp/htdocs;<br/>
if (\(host ~ “c1gstudio\.net”) {<br/>
rewrite ^(.*) http://www.xx.com\)1/ permanent;<br/>
}<br/>
三级域名跳转</p>

<p>if (\(http_host ~* “^(.*)\.i\.xx\.com\)”) {<br/>
rewrite <sup>.*</sup> <a href="http://top.xx.com$1/">http://top.xx.com$1/</a>;<br/>
break;<br/>
}<br/>
域名镜向</p>

<p>server<br/>
{<br/>
listen       80;<br/>
server_name  mirror.xx.com;<br/>
index index.html index.htm index.php;<br/>
root  /opt/lampp/htdocs/www;<br/>
rewrite <sup>/(.*)</sup> <a href="http://www.xx.com/$1">http://www.xx.com/$1</a> last;<br/>
access_log  off;<br/>
}<br/>
某个子目录作镜向</p>

<p>location <sup>~</sup> /zhaopinhui {<br/>
rewrite <sup>.+</sup> <a href="http://zph.xx.com/">http://zph.xx.com/</a> last;<br/>
break;<br/>
}<br/>
discuz ucenter home (uchome) rewrite</p>

<p>rewrite <sup>/(space|network)-(.+).html$</sup> /\(1.php?rewrite=\)2 last;<br/>
rewrite <sup>/(space|network).html$</sup> /\(1.php last;<br/>
rewrite ^/([0-9]+)\) /space.php?uid=$1 last;<br/>
discuz 7 rewrite</p>

<p>rewrite <sup>.*</sup>/archiver/((fid|tid)-[\w-]+.html)\( \)1/archiver/index.php?\(2 last;<br/>
rewrite ^(.*)/forum-([0-9]+)-([0-9]+)\.html\) \(1/forumdisplay.php?fid=\)2&amp;page=\(3 last;<br/>
rewrite ^(.*)/thread-([0-9]+)-([0-9]+)-([0-9]+)\.html\) \(1/viewthread.php?tid=\)2&amp;extra=page\%3D\(4&amp;page=\)3 last;<br/>
rewrite <sup>.*</sup>/profile-(username|uid)-(.+).html\( \)1/viewpro.php?\(2=\)3 last;<br/>
rewrite <sup>.*</sup>/space-(username|uid)-(.+).html\( \)1/space.php?\(2=\)3 last;<br/>
rewrite <sup>.*</sup>/tag-(.+).html\( \)1/tag.php?name=$2 last;<br/>
给discuz某版块单独配置域名</p>

<p>server_name  bbs.xx.com news.xx.com;</p>

<p>location = / {<br/>
if (\(http_host ~ news\.xx.com\)) {<br/>
rewrite <sup>.+</sup> <a href="http://news.xx.com/forum-831-1.html">http://news.xx.com/forum-831-1.html</a> last;<br/>
break;<br/>
}<br/>
}<br/>
discuz ucenter 头像 rewrite 优化</p>

<p>location <sup>~</sup> /ucenter {<br/>
location ~ .*.php?$<br/>
{</p>

<h1 id="toc_13">fastcgi_pass  unix:/tmp/php-cgi.sock;</h1>

<p>fastcgi_pass  127.0.0.1:9000;<br/>
fastcgi_index index.php;<br/>
include fcgi.conf;<br/>
}</p>

<p>location /ucenter/data/avatar {<br/>
log_not_found off;<br/>
access_log   off;<br/>
location ~ /(.<em>)_big.jpg$ {<br/>
error_page 404 /ucenter/images/noavatar_big.gif;<br/>
}<br/>
location ~ /(.</em>)_middle.jpg\( {<br/>
error_page 404 /ucenter/images/noavatar_middle.gif;<br/>
}<br/>
location ~ /(.*)_small\.jpg\) {<br/>
error_page 404 /ucenter/images/noavatar_small.gif;<br/>
}<br/>
expires 300;<br/>
break;<br/>
}<br/>
}<br/>
jspace rewrite</p>

<p>location ~ .*.php?$<br/>
{</p>

<h1 id="toc_14">fastcgi_pass  unix:/tmp/php-cgi.sock;</h1>

<p>fastcgi_pass  127.0.0.1:9000;<br/>
fastcgi_index index.php;<br/>
include fcgi.conf;<br/>
}</p>

<p>location ~* <sup>/index.php/</sup><br/>
{<br/>
rewrite <sup>/index.php/(.*)</sup> /index.php?$1 break;<br/>
fastcgi_pass  127.0.0.1:9000;<br/>
fastcgi_index index.php;<br/>
include fcgi.conf;<br/>
}</p>

<p>Nginx与Apache的Rewrite规则实例对比</p>

<p>简单的Nginx和Apache 重写规则区别不大，基本上能够完全兼容。例如：</p>

<p>Apache Rewrite 规则：</p>

<p>RewriteRule <sup>/(mianshi|xianjing)/$</sup> /zl/index.php?name=$1 [L]</p>

<p>RewriteRule <sup>/ceshi/$</sup> /zl/ceshi.php [L]</p>

<p>RewriteRule <sup>/(mianshi)_([a-zA-Z]+)/$</sup> /zl/index.php?name=\(1_\)2 [L]</p>

<p>RewriteRule <sup>/pingce([0-9]*)/$</sup> /zl/pingce.php?id=$1 [L]</p>

<p>Nginx Rewrite 规则：</p>

<p>rewrite <sup>/(mianshi|xianjing)/$</sup> /zl/index.php?name=$1 last;</p>

<p>rewrite <sup>/ceshi/$</sup> /zl/ceshi.php last;</p>

<p>rewrite <sup>/(mianshi)_([a-zA-Z]+)/$</sup> /zl/index.php?name=\(1_\)2 last;</p>

<p>rewrite <sup>/pingce([0-9]*)/$</sup> /zl/pingce.php?id=$1 last;</p>

<p>由以上示例可以看出，Apache的Rewrite规则改为Nginx的Rewrite规则，其实很简单：Apache的RewriteRule指令换成Nginx的rewrite指令，Apache的[L]标记换成Nginx的last标记，中间的内容不变。</p>

<p>如果Apache的Rewrite规则改为Nginx的Rewrite规则后，使用nginx -t命令检查发现nginx.conf配置文件有语法错误，那么可以尝试给条件加上引号。例如一下的Nginx Rewrite规则会报语法错误：</p>

<p>rewrite <sup>/([0-9]{5}).html$</sup> /x.jsp?id=$1 last;</p>

<p>加上引号就正确了：<br/>
rewrite “<sup>/([0-9]{5}).html$”</sup> /x.jsp?id=$1 last;</p>

<p>Apache与Nginx的Rewrite规则在URL跳转时有细微的区别：</p>

<p>Apache Rewrite 规则：<br/>
RewriteRule <sup>/html/tagindex/([a-zA-Z]+)/.*$</sup> /$1/ [R=301,L]</p>

<p>Nginx Rewrite 规则：<br/>
rewrite <sup>/html/tagindex/([a-zA-Z]+)/.*$</sup> http://\(host/\)1/ permanent;</p>

<p>以上示例中，我们注意到，Nginx Rewrite 规则的置换串中增加了“http://$host”，这是在Nginx中要求的。</p>

<p>另外，Apache与Nginx的Rewrite规则在变量名称方面也有区别，例如：</p>

<p>Apache Rewrite 规则：<br/>
RewriteRule <sup>/user/login/$</sup> /user/login.php?login=1&amp;forward=http://%{HTTP_HOST} [L]</p>

<p>Nginx Rewrite 规则：<br/>
rewrite <sup>/user/login/$</sup> /user/login.php?login=1&amp;forward=http://$host   last;</p>

<p>Apache与Nginx Rewrite 规则的一些功能相同或类似的指令、标记对应关系：</p>

<p>Apache的RewriteCond指令对应Nginx的if指令；<br/>
Apache的RewriteRule指令对应Nginx的rewrite指令；<br/>
Apache的[R]标记对应Nginx的redirect标记；<br/>
Apache的[P]标记对应Nginx的last标记；<br/>
Apache的[R,L]标记对应Nginx的redirect标记；<br/>
Apache的[P,L]标记对应Nginx的last标记；<br/>
Apache的[PT,L]标记对应Nginx的last标记；</p>

<p>允许指定的域名访问本站，其他域名一律跳转到<a href="http://www.aaa.com">http://www.aaa.com</a></p>

<p>Apache Rewrite 规则：<br/>
RewriteCond %{HTTP_HOST}    <sup>.*?</sup>.domain.com\(<br/>
RewriteCond %{HTTP_HOST}    !^qita\.domain\.com\)<br/>
RewriteCond %{DOCUMENT_ROOT}/market/%1/index.htm -f<br/>
RewriteRule <sup>/wu/$</sup> /market/%1/index.htm [L]</p>

<p>Nginx的if指令不支持嵌套，也不支持AND、OR等多条件匹配，相比于Apache的RewriteCond，显得麻烦一些，但是，我们可以通过下一页的Nginx配置写法来实现这个示例：</p>

<p>Nginx Rewrite 规则：<br/>
if (\(host ~* ^(.*?)\.domain\.com\)) set \(var_wupin_city \)1;<br/>
     set $var_wupin ‘1′;</p>

<p>if (\(host ~* ^qita\.domain\.com\))</p>

<pre><code class="language-text">set $var_wupin ‘0′;
</code></pre>

<p>if (!-f \(document_root/market/\)var_wupin_city/index.htm)</p>

<pre><code class="language-text"> set $var_wupin ‘0′;
</code></pre>

<p>if ($var_wupin ~ ‘1′)</p>

<pre><code class="language-text">rewrite ^/wu/$ /market/$var_wupin_city/index.htm last;
</code></pre>

<p>}</p>

<p>另外这里还有一个工具可以直接把apache规则转化为nginx规则</p>

<p><a href="http://www.anilcetin.com/convert-apache-htaccess-to-nginx/">http://www.anilcetin.com/convert-apache-htaccess-to-nginx/</a></p>

<p>参考：</p>

<p><a href="http://wiki.nginx.org/NginxChsHttpRewriteModule">http://wiki.nginx.org/NginxChsHttpRewriteModule</a></p>

    </div>
    <footer class="post-footer clearfix">
      
           
      
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  













<script src="asset/prism.js"></script>

        
      
  
    


    </body>
</html>

---
layout: post
title: 插件
date: 2012-02-21 02:27
author: admin
comments: true
categories: []
---
<?php
function getpics($params){
if(extension_loaded('curl')) {
include(AK_ROOT.'/configs/config.inc.php');
$whereid=$params["id"];
global $db;
$d=$db->query("select filename,id from {$tablepre}_attachments where itemid={$whereid}");
while($r=$db->fetch_array($d)){
$downurl=$r["filename"];
$wid=$r["id"];
$pic["filename"]="pic/".$whereid."_".$wid.".jpg";
$nam=$whereid."_".$wid.".jpg";
getpicdown($downurl,$nam);
$whe="id={$wid}";
$db->update("{$tablepre}_attachments",$pic,$whe);
}
$d=$db->query("select picture,id from {$tablepre}_items where id={$whereid}");
while($r=$db->fetch_array($d)){
$downurl=$r["picture"];
$pi["picture"]="pic/".$whereid.".jpg";
$nam=$whereid.".jpg";
getpicdown($downurl,$nam);
$whe="id={$whereid}";
$db->update("{$tablepre}_items",$pi,$whe);
}
}
}
function getpicdown($url,$id){
$dest='pic/';
$newpic=$dest.$id;
if (!is_dir("pic"))mkdir("pic",0777);
if(file_exists($newpic)){
$newpic="1";
}else{
$ch=curl_init();
$a_opt=array(CURLOPT_URL => $url,CURLOPT_HEADER => 0,CURLOPT_RETURNTRANSFER => 1,);
curl_setopt_array($ch,$a_opt);
$str=curl_exec($ch);
$f=fopen($newpic,'w');
fwrite($f,$str);
}
}
?>

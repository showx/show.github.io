---
layout: post
title: PHP中利用pcntl进行多进程并发控制
date: 2015-01-26 18:03
author: admin
comments: true
categories: []
---
pcntl_fork可以很方便的创建进程，对于一般的需要固定的多进程处理的应用场景来说，实现比较简单，但是，对于需要大量并发创建子进程的应用场景来说，主要的问题在于会产生大量的僵尸进程。。。

&nbsp;

我们的应用中，之前是采用将过程中产生的子进程pid收集起来， 间隔一定时间统一回收（pcntl_waitpid），这样带来的一个问题是：在大量并发情况下，服务器压力过大，会导致子进程“死掉”，这个时候，子进程不是僵尸，无法回收掉，主控进程就卡在那里不动了。。。

&nbsp;

今天借鉴了一下“http://www.perkiset.org/forum/php/forked_php_daemon_example-t474.0.html”文中的方式，用二次创建进程的方式（孙进程处理业务）来将子进程交给系统，达到了在父进程中不需要wait真正的业务子进程的目的，也更接近其他语言中的线程并发控制:

&nbsp;

我们原来的子进程创建接口：
<div class="dp-highlighter bg_php">
<div class="bar">
<div class="tools"><b>[php]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/lgg201/article/details/5996444#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/lgg201/article/details/5996444#">copy</a>
<div><embed id="ZeroClipboardMovie_1" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_1"></embed></div>
</div>
</div>
<ol class="dp-c" start="1">
	<li class="alt"></li>
	<li class=""><span class="keyword">function</span> new_child(<span class="vars">$func_name</span>) {</li>
	<li class="alt">    <span class="vars">$args</span> = func_get_args();</li>
	<li class="">    unset(<span class="vars">$args</span>[0]);</li>
	<li class="alt">    <span class="vars">$pid</span> = pcntl_fork();</li>
	<li class="">    <span class="keyword">if</span>(<span class="vars">$pid</span> == 0) {</li>
	<li class="alt">        function_exists(<span class="vars">$func_name</span>) <span class="keyword">and</span> <span class="func">exit</span>(call_user_func_array(<span class="vars">$func_name</span>, <span class="vars">$args</span>)) <span class="keyword">or</span> <span class="func">exit</span>(-1);</li>
	<li class="">    } <span class="keyword">else</span> <span class="keyword">if</span>(<span class="vars">$pid</span> == -1) {</li>
	<li class="alt">        <span class="func">echo</span> <span class="string">"Couldn’t create child process."</span>;</li>
	<li class="">    } <span class="keyword">else</span> {</li>
	<li class="alt">        <span class="keyword">return</span> <span class="vars">$pid</span>;</li>
	<li class="">    }</li>
	<li class="alt">}</li>
</ol>
</div>
&nbsp;

新的方式：
<div class="dp-highlighter bg_php">
<div class="bar">
<div class="tools"><b>[php]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/lgg201/article/details/5996444#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/lgg201/article/details/5996444#">copy</a>
<div><embed id="ZeroClipboardMovie_2" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_2"></embed></div>
</div>
</div>
<ol class="dp-c" start="1">
	<li class="alt">&lt;?php</li>
	<li class=""><span class="keyword">function</span> daemon(<span class="vars">$func_name</span>) {</li>
	<li class="">    <span class="vars">$args</span> = func_get_args();</li>
	<li class="alt">    unset(<span class="vars">$args</span>[0]);</li>
	<li class="">    <span class="vars">$pid</span> = pcntl_fork();</li>
	<li class="alt">    <span class="keyword">if</span>(<span class="vars">$pid</span>) {</li>
	<li class="">        pcntl_wait(<span class="vars">$status</span>);</li>
	<li class="alt">    } <span class="keyword">else</span> <span class="keyword">if</span>(<span class="vars">$pid</span> == -1) {</li>
	<li class="">        <span class="func">echo</span> <span class="string">"Couldn't create child process."</span>;</li>
	<li class="alt">    } <span class="keyword">else</span> {</li>
	<li class="">        <span class="vars">$pid</span> = pcntl_fork();</li>
	<li class="alt">        <span class="keyword">if</span>(<span class="vars">$pid</span> == 0) {</li>
	<li class="">            posix_setsid();</li>
	<li class="alt">            function_exists(<span class="vars">$func_name</span>) <span class="keyword">and</span> <span class="func">exit</span>(call_user_func_array(<span class="vars">$func_name</span>, <span class="vars">$args</span>)) <span class="keyword">or</span> <span class="func">exit</span>(-1);</li>
	<li class="">        } <span class="keyword">else</span> <span class="keyword">if</span>(<span class="vars">$pid</span> == -1) {</li>
	<li class="alt">            <span class="func">echo</span> <span class="string">"Couldn’t create child process."</span>;</li>
	<li class="">        } <span class="keyword">else</span> {</li>
	<li class="alt">            <span class="func">exit</span>;</li>
	<li class="">        }</li>
	<li class="alt">    }</li>
	<li class="">}</li>
	<li class="alt">?&gt;</li>
</ol>
</div>
&nbsp;

新方式的完整测试：

测试方法：cli模式下运行， ps -ef | grep php查看过程中的php进程情况
<div class="dp-highlighter bg_php">
<div class="bar">
<div class="tools"><b>[php]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/lgg201/article/details/5996444#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/lgg201/article/details/5996444#">copy</a>
<div><embed id="ZeroClipboardMovie_3" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_3"></embed></div>
</div>
</div>
<ol class="dp-c" start="1">
	<li class="alt">&lt;?php</li>
	<li class=""><span class="keyword">function</span> daemon(<span class="vars">$func_name</span>) {</li>
	<li class="">    <span class="vars">$args</span> = func_get_args();</li>
	<li class="alt">    unset(<span class="vars">$args</span>[0]);</li>
	<li class="">    <span class="vars">$pid</span> = pcntl_fork();</li>
	<li class="alt">    <span class="keyword">if</span>(<span class="vars">$pid</span>) {</li>
	<li class="">        pcntl_wait(<span class="vars">$status</span>);</li>
	<li class="alt">    } <span class="keyword">else</span> <span class="keyword">if</span>(<span class="vars">$pid</span> == -1) {</li>
	<li class="">        <span class="func">echo</span> <span class="string">"Couldn't create child process."</span>;</li>
	<li class="alt">    } <span class="keyword">else</span> {</li>
	<li class="">        <span class="vars">$pid</span> = pcntl_fork();</li>
	<li class="alt">        <span class="keyword">if</span>(<span class="vars">$pid</span> == 0) {</li>
	<li class="">            posix_setsid();</li>
	<li class="alt">            function_exists(<span class="vars">$func_name</span>) <span class="keyword">and</span> <span class="func">exit</span>(call_user_func_array(<span class="vars">$func_name</span>, <span class="vars">$args</span>)) <span class="keyword">or</span> <span class="func">exit</span>(-1);</li>
	<li class="">        } <span class="keyword">else</span> <span class="keyword">if</span>(<span class="vars">$pid</span> == -1) {</li>
	<li class="alt">            <span class="func">echo</span> <span class="string">"Couldn’t create child process."</span>;</li>
	<li class="">        } <span class="keyword">else</span> {</li>
	<li class="alt">            sleep(5);</li>
	<li class="">            <span class="func">exit</span>;</li>
	<li class="alt">        }</li>
	<li class="">    }</li>
	<li class="alt">}</li>
	<li class=""><span class="keyword">function</span> test() {</li>
	<li class="alt">    <span class="keyword">while</span>(<span class="vars">$i</span> ++ &lt; 10) {</li>
	<li class="">        <span class="func">echo</span> <span class="string">"child process $i/n"</span>;</li>
	<li class="alt">        sleep(1);</li>
	<li class="">    }</li>
	<li class="alt">}</li>
	<li class="">daemon(test);</li>
	<li class="alt"><span class="keyword">while</span>(++ <span class="vars">$j</span>) <span class="func">echo</span> <span class="string">"parent process $j/n"</span>;</li>
	<li class="">?&gt;</li>
</ol>
</div>

---
layout: post
title: 初步对消息队列RabbitMQ的了解[转]
date: 2015-08-06 16:46
author: admin
comments: true
categories: []
---
RabbitMQ是流行的开源消息队列系统，用erlang语言开发，完整的实现了AMPQ（高级消息队列协议）。网站： http://www.rabbitmq.com/
erlang网站：http://www.erlang.org/ 中文站：http://www.erlang-cn.com/
首先，先安装下RabbitMQ。
我们先来安装下erlang：
<code>
wget http://www.erlang.org/download/otp_src_17.5.tar.gz
tar -zxvf otp_src_17.5.tar.gz
cd otp_src_17.5
./configure --prefix=/lnmp/erlang
make &amp;&amp; make install
</code>
执行下/lnmp/erlang/bin/erl,结果如图，表示安装成功
<img src="http://www.bhqb.org/wp-content/uploads/2015/04/erlang-20150410123756.png" alt="erlang" />
接下来安装RabbitMQ（https://www.rabbitmq.com/install-generic-unix.html）：
<code>
wget https://www.rabbitmq.com/releases/rabbitmq-server/v3.5.1/rabbitmq-server-generic-unix-3.5.1.tar.gz
tar -zxvf rabbitmq-server-generic-unix-3.5.1.tar.gz
cp -r rabbitmq_server-3.5.1/ /lnmp/rabbitmq
</code>
修改下用户目录下.bash_profile，将/lnmp/erlang/bin加入到PATH里面
<code>
PATH=$PATH:$HOME/bin:/lnmp/php/bin:/lnmp/java/bin:/lnmp/imagemagick/bin:/lnmp/erlang/bin
</code>
然后重新调用一下，使其生效
<code>
source ~/.bash_profile
/lnmp/rabbitmq/sbin/rabbitmq-server -detached #启动rabbitmq
/lnmp/rabbitmq/sbin/rabbitmqctl status #查看状态
/lnmp/rabbitmq/sbin/rabbitmqctl stop #停止服务
</code>

接下来来安装php扩展AMQP,安装了它以后，才能用PHP操作rabbitmq。
<code>
wget https://pecl.php.net/get/amqp-1.4.0.tgz
tar -zxvf amqp-1.4.0.tgz
cd amqp-1.4.0
/lnmp/php/bin/phpize
./configure --with-php-config=/lnmp/php/bin/php-config
</code>
安装到这，就报了错：
checking for amqp files in default path… not found
configure: error: Please reinstall the librabbit-mq distribution

在网上搜了搜，找到了解决方法（http://www.cnphp6.com/archives/68356）：
需要安装rabbitmq-c，rabbitmq-c是一个用于C语言的，与AMQP server进行交互的client库。
下载地址：https://github.com/alanxz/rabbitmq-c
<code>
unzip rabbitmq-c-master.zip
cd rabbitmq-c-master
autoreconf -i
./configure --prefix=/lnmp/rabbitmq-c
make
make install
</code>
额，接着安装PHP扩展AMQP
<code>
./configure --with-php-config=/lnmp/php/bin/php-config --with-amqp --with-librabbitmq-dir=/lnmp/rabbitmq-c
make &amp;&amp; make install
</code>
草，又报错啦：
/software/amqp-1.4.0/amqp_exchange.c:515: error: incompatible type for argument 7 of ‘amqp_exchange_declare’
/lnmp/rabbitmq-c//include/amqp_framing.h:798: note: expected ‘amqp_boolean_t’ but argument is of type ‘amqp_table_t’
/software/amqp-1.4.0/amqp_exchange.c:515: error: too few arguments to function ‘amqp_exchange_declare’
make: *** [amqp_exchange.lo] Error 1
在https://github.com/pdezwart/php-amqp/issues/127找到了方法：
应该是安装的rabbitmq-c的版本太高了（安装的是 v0.6.0），下载了v0.5.2版本(https://github.com/alanxz/rabbitmq-c/releases/download/v0.5.2/rabbitmq-c-0.5.2.tar.gz)，重新安装rabbitmq-c,重新安装php扩展AMQP,终于可以啦。真是一波三折啊。

在php配置文件里将扩展加上，重启一下，看phpinfo，显示如下图即安装成功。
<img src="http://www.bhqb.org/wp-content/uploads/2015/04/php-amqp20150413103230.png" alt="php-amqp" />

用PHP写个hello world的例子：
生产者：发送消息（创建连接–&gt;创建channel–&gt;创建交换机对象–&gt;发送信息）
<code>
'127.0.0.1',
'port'=&gt;'5672',
'login'=&gt;'guest',
'password'=&gt;'guest',
'vhost'=&gt;'/'
);</code>

$e_name='e_yao';//交换机名
$k_route='key_1';//路由key

//创建连接和channel
$conn=new AMQPConnection($conn_args);
if(!$conn-&gt;connect()){
die("cannot connect to the broker!\n");
}
$channel=new AMQPChannel($conn);

//消息内容
$message="Hello World!!";

//创建交换机对象
$ex=new AMQPExchange($channel);
$ex-&gt;setName($e_name);

//发送消息
for($i=0;$i&lt;5;$i++){ echo "Send Message:".$ex-&gt;publish($message,$k_route)."\n";
}

<code>$conn-&gt;disconnect();
</code>

消费者：接收消息（创建连接–&gt;创建channel–&gt;创建交换机–&gt;创建队列–&gt;绑定交换机/队列/路由键–&gt;接收消息）
<code>
'127.0.0.1',
'port'=&gt;'5672',
'login'=&gt;'guest',
'password'=&gt;'guest',
'vhost'=&gt;'/'</code>

);
$e_name='e_yao';//交换机名
$q_name='q_yao';//队列名
$k_route='key_1';//路由key

//创建连接和channel
$conn=new AMQPConnection($conn_args);
if(!$conn-&gt;connect()){
die("cannot connect to the broker!\n");
}
$channel=new AMQPChannel($conn);

//创建交换机
$ex=new AMQPExchange($channel);
$ex-&gt;setName($e_name);
$ex-&gt;setType(AMQP_EX_TYPE_DIRECT); //direct类型
$ex-&gt;setFlags(AMQP_DURABLE);//持久化
echo "Exchange Status:".$ex-&gt;declare()."\n";

//创建队列
$q=new AMQPQueue($channel);
$q-&gt;setName($q_name);
$q-&gt;setFlags(AMQP_DURABLE);//持久化
echo "Message Total:".$q-&gt;declare()."\n";

//绑定交换机与队列，并指定路由键
echo 'Queue Bind:'.$q-&gt;bind($e_name,$k_route)."\n";

//阻塞模式接收信息
echo "Message:\n";
while(True){
$q-&gt;consume('processMessage');
}
$conn-&gt;disconnect();

//处理消息回调函数

<code>function processMessage($envelope,$queue){
$msg=$envelope-&gt;getBody();
echo $msg."\n";//处理消息
$queue-&gt;ack($envelope-&gt;getDeliveryTag());
}
</code>

在一个终端运行消费者consumer.php：
<img src="http://www.bhqb.org/wp-content/uploads/2015/04/consumer_20150413124142.png" alt="consumer" />
另一终端运行生产者producer.php:
<img src="http://www.bhqb.org/wp-content/uploads/2015/04/producer_20150413124225.png" alt="producer" />
消费者 接收到消息：
<img src="http://www.bhqb.org/wp-content/uploads/2015/04/consumer2_20150413124258.png" alt="" />

关于php的调用amqp的更多信息可以看参考链接。

参考：
<a title="用PHP尝试RabbitMQ（amqp扩展）" href="http://blog.csdn.net/linvo/article/details/7821395" target="_blank">用PHP尝试RabbitMQ（amqp扩展）</a>
<a title="RabbitMQ与PHP（一）" href="http://hi.baidu.com/cnjimmydong/item/4955163003b493a3124b14de" target="_blank">RabbitMQ与PHP（一）</a>
<a title="RabbitMQ官方中文入门教程(PHP版) 第一部分:Hello World" href="http://www.yuansir-web.com/2013/05/31/rabbitmq%E5%AE%98%E6%96%B9%E4%B8%AD%E6%96%87%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8Bphp%E7%89%88-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86hello-world/" target="_blank">RabbitMQ官方中文入门教程(PHP版) 第一部分:Hello World</a>

&nbsp;

&nbsp;

=======

&nbsp;

&nbsp;

在php扩展amqp的编译过程中，报错如下：
<pre>checking for amqp files in default path... not found
configure: error: Please reinstall the librabbit-mq distribution</pre>
解决办法:
<pre>git clone https://github.com/alanxz/rabbitmq-c rabbitmq-c
cd rabbitmq-c
git clone https://github.com/alanxz/rabbitmq-codegen codegen
cp ./librabbitmq/amqp_framing.h /usr/local/include/</pre>
再次执行configure后无错，但是make的时候还是报错：
<pre>make: *** [amqp.lo] Error 1</pre>
解决办法：
<pre>cp ./librabbitmq/amqp.h /usr/local/include/</pre>
还是报错：
<pre>sh: make: not found</pre>
解决办法：
<pre>apt-get install build-essential</pre>
还是报错：
<pre>make: *** [amqp.la] Error 1</pre>
解决办法：
<pre>apt-get install librabbitmq0
ln -s /usr/lib/librabbitmq.so.0 /usr/local/lib/librabbitmq.so</pre>
如果还有其他错误，可参考上述解决办法举一反三。

最后执行安装：
<pre>sudo make &amp; make install</pre>
应该就没有问题了。

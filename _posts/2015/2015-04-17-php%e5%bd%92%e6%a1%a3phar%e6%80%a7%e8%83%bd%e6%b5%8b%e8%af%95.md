---
layout: post
title: PHP归档phar性能测试
date: 2015-04-17 14:29
author: admin
comments: true
categories: []
---
PHP自从5.3后新增PHAR归档，Phar 归档的概念来自 Java™ 技术的 JAR 归档，它允许使用单个文件打包应用程序，这个文件中包含运行应用程序所需的所有东西。该文件不同于单个可执行文件，后者通常由编程语言生成，比如 C，因为该文件实际上是一个归档文件而非编译过的应用程序。因此 JAR 文件实际上包含组成应用程序的文件，但是考虑到安全性，不对这些文件进行仔细区分。Phar 扩展正是基于类似的理念，但是在设计时主要针对 PHP 的 Web 环境。同样，与 JAR 归档不同的是，Phar 归档可由 PHP 本身处理，因此不需要使用额外的工具来创建或使用。Phar 扩展对 PHP 来说并不是一个新鲜的概念。它最初使用 PHP 编写并被命名为 PHP_Archive，然后在 2005 年被添加到 PEAR 库。然而在实际中，解决这一问题的纯 PHP 解决方案非常缓慢，因此 2007 年重新编写为纯 C 语言扩展，同时添加了使用 SPL 的 ArrayAccess 对象遍历 Phar 归档的支持。自那时起，人们做了大量工作来改善 Phar 归档的性能，目前对Phar使用非常有限，而关于Phar的性能测试很少，到底Phar性能如何，通过一个简单实验检验下。

测试环境：
PHP：5.5.10
CPU：2GHz intel core i7
Mem：8GB
系统：Darwin 13.1.0

主要测试点：
1：Phar加载速度
1.1：文件大小多少的影响？
1.2:  include/require的影响？
1.3：Phar 存根(Stub)内容的影响？
2：Phar代码执行速度
2.1 全局函数对比
2.2 类对象
2.3 类方法
为了保证尽量保证测试准确，每种方式运行3次，去3次的平均值。同时作为对比，我们会直接采用代码方式，获得基准数据。
Phar 文件主要包含文件
<img src="http://img.blog.csdn.net/20140508223450250?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdWdn/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" />

phar-builder.php用于生成phar文件，执行test命令前，先执行此文件生成phar-test.phar文件。
test_load.php 测试加载phar文件速度
src目录内包含文件index.php文件是存根文件，包含dates.php,for.php,functions.php，dates测试文件类方法，for.php测试对象方法，functions.php测试函数方法。
具体附件代码。
第一：phar加载速度，采用include和require方式测试发现差异不大，只采用require方式。
<div class="dp-highlighter bg_php">
<div class="bar">
<div class="tools"><b>[php]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/ugg/article/details/25335079#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/ugg/article/details/25335079#">copy</a><a title="在CODE上查看代码片" href="https://code.csdn.net/snippets/335218" target="_blank"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" width="12" height="12" /></a><a title="派生到我的代码片" href="https://code.csdn.net/snippets/335218/fork" target="_blank"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" width="12" height="12" /></a>
<div><embed id="ZeroClipboardMovie_1" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_1"></embed></div>
</div>
</div>
<ol class="dp-c" start="1">
	<li class="alt"><span class="vars">$stime</span> = microtime(true);</li>
	<li class=""><span class="keyword">require</span> <span class="string">'./phar-test.phar'</span>;</li>
	<li class="alt"><span class="vars">$etime</span> = microtime(true);</li>
	<li class=""><span class="vars">$total</span> = <span class="vars">$etime</span> - <span class="vars">$stime</span>;</li>
	<li class="alt"><span class="func">echo</span> <span class="string">"phar total:"</span>.<span class="vars">$total</span>.<span class="string">"s"</span>;</li>
</ol>
</div>
执行后，效率如下
<div class="dp-highlighter bg_plain">
<div class="bar">
<div class="tools"><b>[plain]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/ugg/article/details/25335079#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/ugg/article/details/25335079#">copy</a><a title="在CODE上查看代码片" href="https://code.csdn.net/snippets/335218" target="_blank"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" width="12" height="12" /></a><a title="派生到我的代码片" href="https://code.csdn.net/snippets/335218/fork" target="_blank"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" width="12" height="12" /></a>
<div><embed id="ZeroClipboardMovie_2" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_2"></embed></div>
</div>
</div>
<ol start="1">
	<li class="alt">localhost:phar ugg$ php test_phar_load.php</li>
	<li class="">phar total:0.0044760704040527s</li>
	<li class="alt">localhost:phar ugg$ php test_phar_load.php</li>
	<li class="">phar total:0.0051448345184326s</li>
	<li class="alt">localhost:phar ugg$ php test_phar_load.php</li>
	<li class="">phar total:0.0043849945068359s</li>
	<li class="alt">localhost:phar ugg$ vim test_phar_load.php</li>
</ol>
</div>
<strong>平均加载4.7毫秒
</strong>

对比直接源代码引用方式。
<div class="dp-highlighter bg_php">
<div class="bar">
<div class="tools"><b>[php]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/ugg/article/details/25335079#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/ugg/article/details/25335079#">copy</a><a title="在CODE上查看代码片" href="https://code.csdn.net/snippets/335218" target="_blank"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" width="12" height="12" /></a><a title="派生到我的代码片" href="https://code.csdn.net/snippets/335218/fork" target="_blank"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" width="12" height="12" /></a>
<div><embed id="ZeroClipboardMovie_3" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_3"></embed></div>
</div>
</div>
<ol class="dp-c" start="1">
	<li class="alt"><span class="vars">$stime</span> = microtime(true);</li>
	<li class=""><span class="keyword">require</span> <span class="string">'./src/index.php'</span>;</li>
	<li class="alt"><span class="vars">$etime</span> = microtime(true);</li>
	<li class=""><span class="vars">$total</span> = <span class="vars">$etime</span> - <span class="vars">$stime</span>;</li>
	<li class="alt"><span class="func">echo</span> <span class="string">"src total:"</span>.<span class="vars">$total</span>.<span class="string">"s\n"</span>;</li>
</ol>
</div>
<p class="p1">执行后，效率如下</p>

<div class="dp-highlighter bg_plain">
<div class="bar">
<div class="tools"><b>[plain]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/ugg/article/details/25335079#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/ugg/article/details/25335079#">copy</a><a title="在CODE上查看代码片" href="https://code.csdn.net/snippets/335218" target="_blank"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" width="12" height="12" /></a><a title="派生到我的代码片" href="https://code.csdn.net/snippets/335218/fork" target="_blank"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" width="12" height="12" /></a>
<div><embed id="ZeroClipboardMovie_4" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_4"></embed></div>
</div>
</div>
<ol start="1">
	<li class="alt">localhost:phar ugg$ php test_src_load.phpsrc</li>
	<li class="">total:0.0026230812072754s</li>
	<li class="alt">localhost:phar ugg$ php test_src_load.phpsrc</li>
	<li class="">total:0.0026969909667969s</li>
	<li class="alt">localhost:phar ugg$ php test_src_load.phpsrc</li>
	<li class="">total:0.0025439262390137s</li>
</ol>
</div>
<p class="p1"><strong>平均加载2.6毫秒
结论：通过加载速度对比，phar加载方式比直接文件加载方式慢了不少，几乎直接引用文件所耗时间的两倍。同时我又在phar文件中加载一些干扰文件，使phar文件变大，发现在10k以内，这个load时间变化不大。当然我并没有把新增的文件放到存根内，这样做的目的，对于超过10K的目录，文件组织方式比如是autoload方式，而不会通过一个文件包含所有的文件。phar加载时间是src直接加载的1.8倍左右。</strong></p>
<p class="p1"><strong>第二：执行速度检验
phar方式，代码如下
</strong></p>

<div class="dp-highlighter bg_php">
<div class="bar">
<div class="tools"><b>[php]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/ugg/article/details/25335079#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/ugg/article/details/25335079#">copy</a><a title="在CODE上查看代码片" href="https://code.csdn.net/snippets/335218" target="_blank"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" width="12" height="12" /></a><a title="派生到我的代码片" href="https://code.csdn.net/snippets/335218/fork" target="_blank"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" width="12" height="12" /></a>
<div><embed id="ZeroClipboardMovie_5" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_5"></embed></div>
</div>
</div>
<ol class="dp-c" start="1">
	<li class="alt"><span class="vars">$stime</span> = microtime(true);</li>
	<li class=""><span class="comment">//require 'phar://phar-test.phar';</span></li>
	<li class="alt"><span class="keyword">require</span> <span class="string">'phar-test.phar'</span>;</li>
	<li class=""><span class="vars">$sstime</span> = microtime(true);</li>
	<li class="alt"><span class="keyword">for</span>(<span class="vars">$i</span> = 0; <span class="vars">$i</span>&lt;10000; ++<span class="vars">$i</span>){</li>
	<li class="">    <span class="vars">$date</span> = dates::next_week();</li>
	<li class="alt">    <span class="vars">$for</span> = <span class="keyword">new</span> fortest();</li>
	<li class="">    <span class="vars">$i</span> = <span class="vars">$for</span>-&gt;for1to10000();</li>
	<li class="alt">    <span class="vars">$number</span> = number2Chinese(<span class="string">'12345'</span>);</li>
	<li class="">}</li>
	<li class="alt"><span class="vars">$eetime</span> = microtime(true);</li>
	<li class=""><span class="vars">$etime</span> = microtime(true);</li>
	<li class="alt"><span class="vars">$total</span> = <span class="vars">$etime</span> - <span class="vars">$stime</span>;</li>
	<li class=""><span class="vars">$total2</span> = <span class="vars">$eetime</span> - <span class="vars">$sstime</span>;</li>
	<li class="alt"><span class="func">echo</span> <span class="string">"phar load total:"</span>.<span class="vars">$total</span>.<span class="string">"s\n"</span>;</li>
	<li class=""><span class="func">echo</span> <span class="string">"phar execution 10000 total:"</span>.<span class="vars">$total2</span>.<span class="string">"s"</span>;</li>
</ol>
</div>
执行效率如下
<div class="dp-highlighter bg_plain">
<div class="bar">
<div class="tools"><b>[plain]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/ugg/article/details/25335079#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/ugg/article/details/25335079#">copy</a><a title="在CODE上查看代码片" href="https://code.csdn.net/snippets/335218" target="_blank"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" width="12" height="12" /></a><a title="派生到我的代码片" href="https://code.csdn.net/snippets/335218/fork" target="_blank"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" width="12" height="12" /></a>
<div><embed id="ZeroClipboardMovie_6" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_6"></embed></div>
</div>
</div>
<ol start="1">
	<li class="alt">localhost:phar ugg$ php test_phar_functions.php</li>
	<li class="">phar load total:0.0047600269317627s</li>
	<li class="alt">phar execution 10000 total:0.00017499923706055s</li>
	<li class="">localhost:phar ugg$ php test_phar_functions.php</li>
	<li class="alt">phar load total:0.004863977432251s</li>
	<li class="">phar execution 10000 total:0.00017404556274414s</li>
	<li class="alt">localhost:phar ugg$ php test_phar_functions.php</li>
	<li class="">phar load total:0.004680871963501s</li>
	<li class="alt">phar execution 10000 total:0.00016689300537109s</li>
</ol>
</div>
执行10000次的类方法，对象实例和对象方法，以及函数方法，总共时间消耗为0.17毫秒。
src执行效率
<div class="dp-highlighter bg_plain">
<div class="bar">
<div class="tools"><b>[plain]</b> <a class="ViewSource" title="view plain" href="http://blog.csdn.net/ugg/article/details/25335079#">view plain</a><a class="CopyToClipboard" title="copy" href="http://blog.csdn.net/ugg/article/details/25335079#">copy</a><a title="在CODE上查看代码片" href="https://code.csdn.net/snippets/335218" target="_blank"><img src="https://code.csdn.net/assets/CODE_ico.png" alt="在CODE上查看代码片" width="12" height="12" /></a><a title="派生到我的代码片" href="https://code.csdn.net/snippets/335218/fork" target="_blank"><img src="https://code.csdn.net/assets/ico_fork.svg" alt="派生到我的代码片" width="12" height="12" /></a>
<div><embed id="ZeroClipboardMovie_7" src="http://static.blog.csdn.net/scripts/ZeroClipboard/ZeroClipboard.swf" type="application/x-shockwave-flash" width="18" height="18" align="middle" name="ZeroClipboardMovie_7"></embed></div>
</div>
</div>
<ol start="1">
	<li class="alt">localhost:phar ugg$ php test_src_functions.php</li>
	<li class="">phar load total:0.0029089450836182s</li>
	<li class="alt">phar execution 10000 total:0.00019693374633789s</li>
	<li class="">localhost:phar ugg$ php test_src_functions.php</li>
	<li class="alt">phar load total:0.0028579235076904s</li>
	<li class="">phar execution 10000 total:0.0002140998840332s</li>
	<li class="alt">localhost:phar ugg$ php test_src_functions.php</li>
	<li class="">phar load total:0.0029168128967285s</li>
	<li class="alt">phar execution 10000 total:0.00019478797912598s</li>
</ol>
</div>
<strong>执行10000次的类方法，对象实例和对象方法，以及函数方法，总共时间消耗为0.20毫秒。</strong>
小结：通过执行速度对比，发现是phar方式，执行速度，要比直接文件include方式，快了(0.20-0.17)/0.20*100=15%，phar方式执行速度快的具体原因没有找到，网上有份资料，apc+include_path设置 phar执行速度很快。https://github.com/ralphschindler/test-phar-performance-apc/。

总结：PHP归档phar方式，加载速度要慢于正常文件包含方式，但是执行速度要高于文件包含方式，如果配合include_path设置和APC或者OP方式，优化phar归档的加载速度，就能提升php的执行速度。下一步会做方面的尝试，1：构建大phar文件，实验加载速度，执行速度。2：了解phar加载原理和执行原理，3：包概念管理和依赖。
<p class="p1">
其他一些参考资料
PHP V5.3中新特性，创建并使用Phar归档。http://www.ibm.com/developerworks/cn/opensource/os-php-5.3new4/
test-phar-performance-apc https://github.com/ralphschindler/test-phar-performance-apc/</p>

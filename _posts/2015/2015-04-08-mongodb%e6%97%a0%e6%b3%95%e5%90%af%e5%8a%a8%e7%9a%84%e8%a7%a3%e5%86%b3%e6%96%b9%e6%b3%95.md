---
layout: post
title: MongoDB无法启动的解决方法
date: 2015-04-08 15:10
author: admin
comments: true
categories: []
---
遇到MongoDB突然无法启动，第一反应是删除mongod.lock。这个文件在MongoDB的数据库目录下，默认是/data/db。这是最常见的问题了，产生原因是MongoDB没有正常结束（比如被kill -9杀掉或是其他意外情况导致中断）。

还一些其他情况会导致MongoDB无法启动。本文讨论的<strong>无法启动</strong>，是指：使用<span class="com-inline">/etc/init.d/mongodb start</span>或是<span class="com-inline">sudo service mongdb start</span>，提示mongodb start/running，但查看status仍然是stop/waiting。

service SERVERNAME status有可能误报，先确认MongoDB的实际状态。主要是<span class="com-inline">ps axu|grep mongod</span>查看是否有相关进程，打开links或是直接用浏览器访问127.0.0.1:28017，看不到MongoDB的信息说明没有启动。
<span id="more-423"></span>
然后执行：
<div class="com">$ sudo mongod --repair --config /etc/mongodb.conf
$ sudo mongod --config /etc/mongodb.conf</div>
第一条命令是修复操作，第二条命令是手动指定MongoDB的配置文件，在终端中直接运行，这样输出错误时比较直观，不用去翻日志。如果能顺利运行mongod，说明配置文件和数据库都没有问题，是/usr/bin/mongodb权限不够，请参考本文结尾setcap方法。

如果不能运行，可以看到报错信息，分三种情况：配置文件错误，数据目录设置错误，/usr/bin/mongod文件错误。

配置文件错误比较明显，参数错误会明确提示<span class="com-inline">error command line: unknown option xxx</span>。第二条命令中明确指定使用的配置文件，也容易排错。所以除了之前配MongoDB主从修改配置文件弄坏过一次，很少遇到配置文件的问题。

其次是数据目录，主要是权限问题，可能的报错是：
<div class="com">Thu 22 11 10:03:30 [initandlisten] warning couldn’t write to / rename file /srv/mongodb/journal/prealloc.0
Thu 22 11 10:03:30 [initandlisten] couldn’t open /srv/mongodb/duoshuo.ns errno:1 Operation not permitted
Thu 22 11 10:03:30 [initandlisten] error couldn’t open file /srv/mongodb/duoshuo.ns terminating</div>
数据目录的owner应该是mongodb:mongodb。
<div class="com">$ sudo chown mongodb:mongodb mongodb
$ sudo vi /etc/passwd</div>
最后一种情况是/usr/bin/mongod的问题。它的报错和目录没有读写权限一样，但即使你把MongoDB的数据库目录设置成777，一样会有问题。因为mongod是以O_NOATIME标志来访问文件系统的，mongodb没有这个权限，用setcap设置：
<div class="com"># setcap cap_fowner+ep /usr/bin/mongod</div>
如果这样都不行…备份数据库然后apt-get purge 卸载重装吧。

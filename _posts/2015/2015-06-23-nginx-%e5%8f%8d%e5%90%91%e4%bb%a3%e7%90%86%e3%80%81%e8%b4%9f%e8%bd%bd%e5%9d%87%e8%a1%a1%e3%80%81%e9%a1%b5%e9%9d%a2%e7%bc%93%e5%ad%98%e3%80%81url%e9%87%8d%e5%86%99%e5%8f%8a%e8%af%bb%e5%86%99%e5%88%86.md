---
layout: post
title: Nginx 反向代理、负载均衡、页面缓存、URL重写及读写分离详解
date: 2015-06-23 10:15
author: admin
comments: true
categories: []
---
大纲
<blockquote>一、前言

二、环境准备

三、安装与配置Nginx

四、Nginx之反向代理

五、Nginx之负载均衡

六、Nginx之页面缓存

七、Nginx之URL重写

八、Nginx之读写分离</blockquote>
注，操作系统为 CentOS 6.4 x86_64 , Nginx 是版本是最新版的1.4.2，所以实验用到的软件请点击这里下载：<a title="http://yunpan.cn/QXIgqMmVmuZrm" href="http://yunpan.cn/QXIgqMmVmuZrm" target="\&quot;_blank\&quot;">http://yunpan.cn/QXIgqMmVmuZrm</a>

一、前言

在前面的几篇博文中我们主要讲解了Nginx作为Web服务器知识点，主要的知识点有nginx的理论详解、nginx作为web服务器的操作讲解、nginx作为LNMP架构的讲解，不清楚的博友可以回头看看，在这一篇博客中我们主要讲解， nginx的反向代理、负载均衡、缓存、URL重写以及读写分离详解。好了，下面我们来具体说一说。

二、环境准备

1. 操作系统
<ul class=" list-paddingleft-2">
	<li>CentOS 6.4 x86_64</li>
</ul>
2.软件版本
<ul class=" list-paddingleft-2">
	<li>Nginx 1.4.2</li>
</ul>
3.实验拓扑

<strong>注，实验拓扑见下文。</strong>

4.安装yum源
<div>
<div id="highlighter_360871" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
5.各节点时间同步
<div>
<div id="highlighter_623543" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># ntpdate 202.120.2.101</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># ntpdate 202.120.2.101</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># ntpdate 202.120.2.101</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
6.关闭防火墙与SELinux
<div>
<div id="highlighter_438146" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service iptables stop</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># chkconfig iptables off </code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># getenforce </code></div>
<div class="line number4 index3 alt1"><code class="bash plain">Disabled</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># service iptables stop</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># chkconfig iptables off </code></div>
<div class="line number7 index6 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># getenforce </code></div>
<div class="line number8 index7 alt1"><code class="bash plain">Disabled</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># service iptables stop</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># chkconfig iptables off </code></div>
<div class="line number11 index10 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># getenforce </code></div>
<div class="line number12 index11 alt1"><code class="bash plain">Disabled</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
三、安装Nginx

1.解压
<div>
<div id="highlighter_851425" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx src]</code><code class="bash comments"># tar xf nginx-1.4.2.tar.gz</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
2.新建nginx用户与组
<div>
<div id="highlighter_41248" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx src]</code><code class="bash comments"># groupadd -g 108  -r nginx</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx src]</code><code class="bash comments"># useradd -u 108 -r -g 108 nginx </code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@nginx src]</code><code class="bash comments"># id nginx </code></div>
<div class="line number4 index3 alt1"><code class="bash plain">uid=108(nginx) gid=108(nginx) 组=108(nginx)</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
3.准备编译配置文件
<div>
<div id="highlighter_872702" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx src]</code><code class="bash comments"># yum install -y pcre-devel openssl-devel</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx nginx-1.4.2]</code><code class="bash comments"># ./configure   --prefix=/usr   --sbin-path=/usr/sbin/nginx   --conf-path=/etc/nginx/nginx.conf   --error-log-path=/var/log/nginx/error.log   --http-log-path=/var/log/nginx/access.log   --pid-path=/var/run/nginx/nginx.pid    --lock-path=/var/lock/nginx.lock   --user=nginx   --group=nginx   --with-http_ssl_module   --with-http_flv_module   --with-http_stub_status_module   --with-http_gzip_static_module   --http-client-body-temp-path=/var/tmp/nginx/client/   --http-proxy-temp-path=/var/tmp/nginx/proxy/   --http-fastcgi-temp-path=/var/tmp/nginx/fcgi/   --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi   --http-scgi-temp-path=/var/tmp/nginx/scgi   --with-pcre</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
4.编译并安装
<div>
<div id="highlighter_718837" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx nginx-1.4.2]</code><code class="bash comments"># make &amp;&amp; make install</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
5.为nginx提供SysV init脚本
<div>
<div id="highlighter_678173" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div>
<div class="line number15 index14 alt2">15</div>
<div class="line number16 index15 alt1">16</div>
<div class="line number17 index16 alt2">17</div>
<div class="line number18 index17 alt1">18</div>
<div class="line number19 index18 alt2">19</div>
<div class="line number20 index19 alt1">20</div>
<div class="line number21 index20 alt2">21</div>
<div class="line number22 index21 alt1">22</div>
<div class="line number23 index22 alt2">23</div>
<div class="line number24 index23 alt1">24</div>
<div class="line number25 index24 alt2">25</div>
<div class="line number26 index25 alt1">26</div>
<div class="line number27 index26 alt2">27</div>
<div class="line number28 index27 alt1">28</div>
<div class="line number29 index28 alt2">29</div>
<div class="line number30 index29 alt1">30</div>
<div class="line number31 index30 alt2">31</div>
<div class="line number32 index31 alt1">32</div>
<div class="line number33 index32 alt2">33</div>
<div class="line number34 index33 alt1">34</div>
<div class="line number35 index34 alt2">35</div>
<div class="line number36 index35 alt1">36</div>
<div class="line number37 index36 alt2">37</div>
<div class="line number38 index37 alt1">38</div>
<div class="line number39 index38 alt2">39</div>
<div class="line number40 index39 alt1">40</div>
<div class="line number41 index40 alt2">41</div>
<div class="line number42 index41 alt1">42</div>
<div class="line number43 index42 alt2">43</div>
<div class="line number44 index43 alt1">44</div>
<div class="line number45 index44 alt2">45</div>
<div class="line number46 index45 alt1">46</div>
<div class="line number47 index46 alt2">47</div>
<div class="line number48 index47 alt1">48</div>
<div class="line number49 index48 alt2">49</div>
<div class="line number50 index49 alt1">50</div>
<div class="line number51 index50 alt2">51</div>
<div class="line number52 index51 alt1">52</div>
<div class="line number53 index52 alt2">53</div>
<div class="line number54 index53 alt1">54</div>
<div class="line number55 index54 alt2">55</div>
<div class="line number56 index55 alt1">56</div>
<div class="line number57 index56 alt2">57</div>
<div class="line number58 index57 alt1">58</div>
<div class="line number59 index58 alt2">59</div>
<div class="line number60 index59 alt1">60</div>
<div class="line number61 index60 alt2">61</div>
<div class="line number62 index61 alt1">62</div>
<div class="line number63 index62 alt2">63</div>
<div class="line number64 index63 alt1">64</div>
<div class="line number65 index64 alt2">65</div>
<div class="line number66 index65 alt1">66</div>
<div class="line number67 index66 alt2">67</div>
<div class="line number68 index67 alt1">68</div>
<div class="line number69 index68 alt2">69</div>
<div class="line number70 index69 alt1">70</div>
<div class="line number71 index70 alt2">71</div>
<div class="line number72 index71 alt1">72</div>
<div class="line number73 index72 alt2">73</div>
<div class="line number74 index73 alt1">74</div>
<div class="line number75 index74 alt2">75</div>
<div class="line number76 index75 alt1">76</div>
<div class="line number77 index76 alt2">77</div>
<div class="line number78 index77 alt1">78</div>
<div class="line number79 index78 alt2">79</div>
<div class="line number80 index79 alt1">80</div>
<div class="line number81 index80 alt2">81</div>
<div class="line number82 index81 alt1">82</div>
<div class="line number83 index82 alt2">83</div>
<div class="line number84 index83 alt1">84</div>
<div class="line number85 index84 alt2">85</div>
<div class="line number86 index85 alt1">86</div>
<div class="line number87 index86 alt2">87</div>
<div class="line number88 index87 alt1">88</div>
<div class="line number89 index88 alt2">89</div>
<div class="line number90 index89 alt1">90</div>
<div class="line number91 index90 alt2">91</div>
<div class="line number92 index91 alt1">92</div>
<div class="line number93 index92 alt2">93</div>
<div class="line number94 index93 alt1">94</div>
<div class="line number95 index94 alt2">95</div>
<div class="line number96 index95 alt1">96</div>
<div class="line number97 index96 alt2">97</div>
<div class="line number98 index97 alt1">98</div>
<div class="line number99 index98 alt2">99</div>
<div class="line number100 index99 alt1">100</div>
<div class="line number101 index100 alt2">101</div>
<div class="line number102 index101 alt1">102</div>
<div class="line number103 index102 alt2">103</div>
<div class="line number104 index103 alt1">104</div>
<div class="line number105 index104 alt2">105</div>
<div class="line number106 index105 alt1">106</div>
<div class="line number107 index106 alt2">107</div>
<div class="line number108 index107 alt1">108</div>
<div class="line number109 index108 alt2">109</div>
<div class="line number110 index109 alt1">110</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># cat /etc/init.d/nginx</code></div>
<div class="line number2 index1 alt1"><code class="bash comments">#!/bin/sh </code></div>
<div class="line number3 index2 alt2"><code class="bash comments"># </code></div>
<div class="line number4 index3 alt1"><code class="bash comments"># nginx - this script starts and stops the nginx daemon </code></div>
<div class="line number5 index4 alt2"><code class="bash comments"># </code></div>
<div class="line number6 index5 alt1"><code class="bash comments"># chkconfig:   - 85 15 </code></div>
<div class="line number7 index6 alt2"><code class="bash comments"># description:  Nginx is an HTTP(S) server, HTTP(S) reverse \ </code></div>
<div class="line number8 index7 alt1"><code class="bash comments">#               proxy and IMAP/POP3 proxy server </code></div>
<div class="line number9 index8 alt2"><code class="bash comments"># processname: nginx </code></div>
<div class="line number10 index9 alt1"><code class="bash comments"># config:      /etc/nginx/nginx.conf </code></div>
<div class="line number11 index10 alt2"><code class="bash comments"># config:      /etc/sysconfig/nginx </code></div>
<div class="line number12 index11 alt1"><code class="bash comments"># pidfile:     /var/run/nginx.pid </code></div>
<div class="line number13 index12 alt2"><code class="bash comments"># Source function library. </code></div>
<div class="line number14 index13 alt1"><code class="bash plain">. </code><code class="bash plain">/etc/rc</code><code class="bash plain">.d</code><code class="bash plain">/init</code><code class="bash plain">.d</code><code class="bash plain">/functions</code></div>
<div class="line number15 index14 alt2"><code class="bash comments"># Source networking configuration. </code></div>
<div class="line number16 index15 alt1"><code class="bash plain">. </code><code class="bash plain">/etc/sysconfig/network</code></div>
<div class="line number17 index16 alt2"><code class="bash comments"># Check that networking is up. </code></div>
<div class="line number18 index17 alt1"><code class="bash plain">[ </code><code class="bash string">"$NETWORKING"</code> <code class="bash plain">= </code><code class="bash string">"no"</code> <code class="bash plain">] &amp;&amp; </code><code class="bash functions">exit</code> <code class="bash plain">0 </code></div>
<div class="line number19 index18 alt2"><code class="bash plain">nginx=</code><code class="bash string">"/usr/sbin/nginx"</code></div>
<div class="line number20 index19 alt1"><code class="bash plain">prog=$(</code><code class="bash functions">basename</code> <code class="bash plain">$nginx) </code></div>
<div class="line number21 index20 alt2"><code class="bash plain">NGINX_CONF_FILE=</code><code class="bash string">"/etc/nginx/nginx.conf"</code></div>
<div class="line number22 index21 alt1"><code class="bash plain">[ -f </code><code class="bash plain">/etc/sysconfig/nginx</code> <code class="bash plain">] &amp;&amp; . </code><code class="bash plain">/etc/sysconfig/nginx</code></div>
<div class="line number23 index22 alt2"><code class="bash plain">lockfile=</code><code class="bash plain">/var/lock/subsys/nginx</code></div>
<div class="line number24 index23 alt1"><code class="bash plain">make_dirs() { </code></div>
<div class="line number25 index24 alt2"><code class="bash spaces">   </code><code class="bash comments"># make required directories </code></div>
<div class="line number26 index25 alt1"><code class="bash spaces">   </code><code class="bash plain">user=`nginx -V 2&gt;&amp;1 | </code><code class="bash functions">grep</code> <code class="bash string">"configure arguments:"</code> <code class="bash plain">| </code><code class="bash functions">sed</code> <code class="bash string">'s/[^*]*--user=\([^ ]*\).*/\1/g'</code> <code class="bash plain">-` </code></div>
<div class="line number27 index26 alt2"><code class="bash spaces">   </code><code class="bash plain">options=`$nginx -V 2&gt;&amp;1 | </code><code class="bash functions">grep</code> <code class="bash string">'configure arguments:'</code><code class="bash plain">` </code></div>
<div class="line number28 index27 alt1"><code class="bash spaces">   </code><code class="bash keyword">for</code> <code class="bash plain">opt </code><code class="bash keyword">in</code> <code class="bash plain">$options; </code><code class="bash keyword">do</code></div>
<div class="line number29 index28 alt2"><code class="bash spaces">       </code><code class="bash keyword">if</code> <code class="bash plain">[ `</code><code class="bash functions">echo</code> <code class="bash plain">$opt | </code><code class="bash functions">grep</code> <code class="bash string">'.*-temp-path'</code><code class="bash plain">` ]; </code><code class="bash keyword">then</code></div>
<div class="line number30 index29 alt1"><code class="bash spaces">           </code><code class="bash plain">value=`</code><code class="bash functions">echo</code> <code class="bash plain">$opt | </code><code class="bash functions">cut</code> <code class="bash plain">-d </code><code class="bash string">"="</code> <code class="bash plain">-f 2` </code></div>
<div class="line number31 index30 alt2"><code class="bash spaces">           </code><code class="bash keyword">if</code> <code class="bash plain">[ ! -d </code><code class="bash string">"$value"</code> <code class="bash plain">]; </code><code class="bash keyword">then</code></div>
<div class="line number32 index31 alt1"><code class="bash spaces">               </code><code class="bash comments"># echo "creating" $value </code></div>
<div class="line number33 index32 alt2"><code class="bash spaces">               </code><code class="bash functions">mkdir</code> <code class="bash plain">-p $value &amp;&amp; </code><code class="bash functions">chown</code> <code class="bash plain">-R $user $value </code></div>
<div class="line number34 index33 alt1"><code class="bash spaces">           </code><code class="bash keyword">fi</code></div>
<div class="line number35 index34 alt2"><code class="bash spaces">       </code><code class="bash keyword">fi</code></div>
<div class="line number36 index35 alt1"><code class="bash spaces">   </code><code class="bash keyword">done</code></div>
<div class="line number37 index36 alt2"><code class="bash plain">} </code></div>
<div class="line number38 index37 alt1"><code class="bash plain">start() { </code></div>
<div class="line number39 index38 alt2"><code class="bash spaces">    </code><code class="bash plain">[ -x $nginx ] || </code><code class="bash functions">exit</code> <code class="bash plain">5 </code></div>
<div class="line number40 index39 alt1"><code class="bash spaces">    </code><code class="bash plain">[ -f $NGINX_CONF_FILE ] || </code><code class="bash functions">exit</code> <code class="bash plain">6 </code></div>
<div class="line number41 index40 alt2"><code class="bash spaces">    </code><code class="bash plain">make_dirs </code></div>
<div class="line number42 index41 alt1"><code class="bash spaces">    </code><code class="bash functions">echo</code> <code class="bash plain">-n $</code><code class="bash string">"Starting $prog: "</code></div>
<div class="line number43 index42 alt2"><code class="bash spaces">    </code><code class="bash plain">daemon $nginx -c $NGINX_CONF_FILE </code></div>
<div class="line number44 index43 alt1"><code class="bash spaces">    </code><code class="bash plain">retval=$? </code></div>
<div class="line number45 index44 alt2"><code class="bash spaces">    </code><code class="bash functions">echo</code></div>
<div class="line number46 index45 alt1"><code class="bash spaces">    </code><code class="bash plain">[ $retval -</code><code class="bash keyword">eq</code> <code class="bash plain">0 ] &amp;&amp; </code><code class="bash functions">touch</code> <code class="bash plain">$lockfile </code></div>
<div class="line number47 index46 alt2"><code class="bash spaces">    </code><code class="bash keyword">return</code> <code class="bash plain">$retval </code></div>
<div class="line number48 index47 alt1"><code class="bash plain">} </code></div>
<div class="line number49 index48 alt2"><code class="bash plain">stop() { </code></div>
<div class="line number50 index49 alt1"><code class="bash spaces">    </code><code class="bash functions">echo</code> <code class="bash plain">-n $</code><code class="bash string">"Stopping $prog: "</code></div>
<div class="line number51 index50 alt2"><code class="bash spaces">    </code><code class="bash plain">killproc $prog -QUIT </code></div>
<div class="line number52 index51 alt1"><code class="bash spaces">    </code><code class="bash plain">retval=$? </code></div>
<div class="line number53 index52 alt2"><code class="bash spaces">    </code><code class="bash functions">echo</code></div>
<div class="line number54 index53 alt1"><code class="bash spaces">    </code><code class="bash plain">[ $retval -</code><code class="bash keyword">eq</code> <code class="bash plain">0 ] &amp;&amp; </code><code class="bash functions">rm</code> <code class="bash plain">-f $lockfile </code></div>
<div class="line number55 index54 alt2"><code class="bash spaces">    </code><code class="bash keyword">return</code> <code class="bash plain">$retval </code></div>
<div class="line number56 index55 alt1"><code class="bash plain">} </code></div>
<div class="line number57 index56 alt2"><code class="bash plain">restart() { </code></div>
<div class="line number58 index57 alt1"><code class="bash spaces">    </code><code class="bash plain">configtest || </code><code class="bash keyword">return</code> <code class="bash plain">$? </code></div>
<div class="line number59 index58 alt2"><code class="bash spaces">    </code><code class="bash plain">stop </code></div>
<div class="line number60 index59 alt1"><code class="bash spaces">    </code><code class="bash functions">sleep</code> <code class="bash plain">1 </code></div>
<div class="line number61 index60 alt2"><code class="bash spaces">    </code><code class="bash plain">start </code></div>
<div class="line number62 index61 alt1"><code class="bash plain">} </code></div>
<div class="line number63 index62 alt2"><code class="bash plain">reload() { </code></div>
<div class="line number64 index63 alt1"><code class="bash spaces">    </code><code class="bash plain">configtest || </code><code class="bash keyword">return</code> <code class="bash plain">$? </code></div>
<div class="line number65 index64 alt2"><code class="bash spaces">    </code><code class="bash functions">echo</code> <code class="bash plain">-n $</code><code class="bash string">"Reloading $prog: "</code></div>
<div class="line number66 index65 alt1"><code class="bash spaces">    </code><code class="bash plain">killproc $nginx -HUP </code></div>
<div class="line number67 index66 alt2"><code class="bash spaces">    </code><code class="bash plain">RETVAL=$? </code></div>
<div class="line number68 index67 alt1"><code class="bash spaces">    </code><code class="bash functions">echo</code></div>
<div class="line number69 index68 alt2"><code class="bash plain">} </code></div>
<div class="line number70 index69 alt1"><code class="bash plain">force_reload() { </code></div>
<div class="line number71 index70 alt2"><code class="bash spaces">    </code><code class="bash plain">restart </code></div>
<div class="line number72 index71 alt1"><code class="bash plain">} </code></div>
<div class="line number73 index72 alt2"><code class="bash plain">configtest() { </code></div>
<div class="line number74 index73 alt1"><code class="bash spaces">  </code><code class="bash plain">$nginx -t -c $NGINX_CONF_FILE </code></div>
<div class="line number75 index74 alt2"><code class="bash plain">} </code></div>
<div class="line number76 index75 alt1"><code class="bash plain">rh_status() { </code></div>
<div class="line number77 index76 alt2"><code class="bash spaces">    </code><code class="bash plain">status $prog </code></div>
<div class="line number78 index77 alt1"><code class="bash plain">} </code></div>
<div class="line number79 index78 alt2"><code class="bash plain">rh_status_q() { </code></div>
<div class="line number80 index79 alt1"><code class="bash spaces">    </code><code class="bash plain">rh_status &gt;</code><code class="bash plain">/dev/null</code> <code class="bash plain">2&gt;&amp;1 </code></div>
<div class="line number81 index80 alt2"><code class="bash plain">} </code></div>
<div class="line number82 index81 alt1"><code class="bash keyword">case</code> <code class="bash string">"$1"</code> <code class="bash keyword">in</code></div>
<div class="line number83 index82 alt2"><code class="bash spaces">    </code><code class="bash plain">start) </code></div>
<div class="line number84 index83 alt1"><code class="bash spaces">        </code><code class="bash plain">rh_status_q &amp;&amp; </code><code class="bash functions">exit</code> <code class="bash plain">0 </code></div>
<div class="line number85 index84 alt2"><code class="bash spaces">        </code><code class="bash plain">$1 </code></div>
<div class="line number86 index85 alt1"><code class="bash spaces">        </code><code class="bash plain">;; </code></div>
<div class="line number87 index86 alt2"><code class="bash spaces">    </code><code class="bash plain">stop) </code></div>
<div class="line number88 index87 alt1"><code class="bash spaces">        </code><code class="bash plain">rh_status_q || </code><code class="bash functions">exit</code> <code class="bash plain">0 </code></div>
<div class="line number89 index88 alt2"><code class="bash spaces">        </code><code class="bash plain">$1 </code></div>
<div class="line number90 index89 alt1"><code class="bash spaces">        </code><code class="bash plain">;; </code></div>
<div class="line number91 index90 alt2"><code class="bash spaces">    </code><code class="bash plain">restart|configtest) </code></div>
<div class="line number92 index91 alt1"><code class="bash spaces">        </code><code class="bash plain">$1 </code></div>
<div class="line number93 index92 alt2"><code class="bash spaces">        </code><code class="bash plain">;; </code></div>
<div class="line number94 index93 alt1"><code class="bash spaces">    </code><code class="bash plain">reload) </code></div>
<div class="line number95 index94 alt2"><code class="bash spaces">        </code><code class="bash plain">rh_status_q || </code><code class="bash functions">exit</code> <code class="bash plain">7 </code></div>
<div class="line number96 index95 alt1"><code class="bash spaces">        </code><code class="bash plain">$1 </code></div>
<div class="line number97 index96 alt2"><code class="bash spaces">        </code><code class="bash plain">;; </code></div>
<div class="line number98 index97 alt1"><code class="bash spaces">    </code><code class="bash plain">force-reload) </code></div>
<div class="line number99 index98 alt2"><code class="bash spaces">        </code><code class="bash plain">force_reload </code></div>
<div class="line number100 index99 alt1"><code class="bash spaces">        </code><code class="bash plain">;; </code></div>
<div class="line number101 index100 alt2"><code class="bash spaces">    </code><code class="bash plain">status) </code></div>
<div class="line number102 index101 alt1"><code class="bash spaces">        </code><code class="bash plain">rh_status </code></div>
<div class="line number103 index102 alt2"><code class="bash spaces">        </code><code class="bash plain">;; </code></div>
<div class="line number104 index103 alt1"><code class="bash spaces">    </code><code class="bash plain">condrestart|try-restart) </code></div>
<div class="line number105 index104 alt2"><code class="bash spaces">        </code><code class="bash plain">rh_status_q || </code><code class="bash functions">exit</code> <code class="bash plain">0 </code></div>
<div class="line number106 index105 alt1"><code class="bash spaces">            </code><code class="bash plain">;; </code></div>
<div class="line number107 index106 alt2"><code class="bash spaces">    </code><code class="bash plain">*) </code></div>
<div class="line number108 index107 alt1"><code class="bash spaces">        </code><code class="bash functions">echo</code> <code class="bash plain">$</code><code class="bash string">"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload|configtest}"</code></div>
<div class="line number109 index108 alt2"><code class="bash spaces">        </code><code class="bash functions">exit</code> <code class="bash plain">2 </code></div>
<div class="line number110 index109 alt1"><code class="bash keyword">esac</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
6.为此脚本赋予执行权限
<div>
<div id="highlighter_451788" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># chmod +x /etc/init.d/nginx</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
7.添加至服务管理列表，并让其开机自动启动
<div>
<div id="highlighter_820124" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># chkconfig --add nginx</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># chkconfig nginx on </code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># chkconfig nginx --list </code></div>
<div class="line number4 index3 alt1"><code class="bash plain">nginx              0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
8.启动nginx
<div>
<div id="highlighter_782163" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx start</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">正在启动 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
9.查看一下端口
<div>
<div id="highlighter_394960" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># netstat -ntlp | grep :80</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">tcp        0      0 0.0.0.0:80                  0.0.0.0:*                   LISTEN      3889</code><code class="bash plain">/nginx</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
10.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277128Edo2.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-style: none; border-color: initial; background-image: none;" title="t1" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277128W8iY.png" alt="t1" width="650" height="371" border="0" /></a>

好了，Nginx安装与配置就到这里，下面我们来说一说Nginx的反向代理。

四、Nginx之反向代理

在配置nginx反向代理之间我们得先准备两台测试服务器，Web1与Web2。

1.安装httpd
<div>
<div id="highlighter_316872" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># yum install -y httpd</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># yum install -y httpd</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
2.提供测试页面
<div>
<div id="highlighter_166833" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># echo "&lt;h1&gt;web1.test.com&lt;/h1&gt;" &gt; /var/www/html/index.html</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># echo "&lt;h1&gt;web2.test.com&lt;/h1&gt;" &gt; /var/www/html/index.html</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
3.启动httpd服务
<div>
<div id="highlighter_930041" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># service httpd start</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">正在启动 httpd：                                           [确定]</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># service httpd start</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">正在启动 httpd：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
4.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_13782771281xo5.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-style: none; border-color: initial; background-image: none;" title="t2" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277129oCPY.png" alt="t2" width="650" height="171" border="0" /></a>

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277129GRzO.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-style: none; border-color: initial; background-image: none;" title="t3" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277129zdMr.png" alt="t3" width="650" height="170" border="0" /></a>

5.简单说一下，正向代理与反向代理
<h4>(1).正向代理的概念</h4>
<h4>       正向代理，也就是传说中的代理,他的工作原理就像一个跳板，简单的说，我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。从网站的角度，只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求，也隐藏了用户的资料，这取决于代理告不告诉网站。</h4>
结论就是，正向代理 是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。
<h4>(2).反向代理的概念</h4>
继续举例:
例用户访问 <a href="http://www.test.com/readme" target="\&quot;_blank\&quot;">http://www.test.com/readme</a>，但<a href="http://www.test.com/" target="\&quot;_blank\&quot;">www.test.com</a>上并不存在readme页面，他是偷偷从另外一台服务器上取回来，然后作为自己的内容返回用户，但用户并不知情。这里所提到的 <a href="http://www.test.com/" target="\&quot;_blank\&quot;">www.test.com</a> 这个域名对应的服务器就设置了反向代理功能。

结论就是，反向代理正好相反，对于客户端而言它就像是原始服务器，并且客户端不需要进行任何特别的设置。客户端向反向代理的命名空间(name-space)中的内容发送普通请求，接着反向代理将判断向何处(原始服务器)转交请求，并将获得的内容返回给客户端，就像这些内容原本就是它自己的一样。
<h4>(3).两者区别</h4>
从<strong>用途</strong>上来讲：

正向代理的典型用途是为在防火墙内的局域网客户端提供访问Internet的途径。正向代理还可以使用缓冲特性减少网络使用率。反向代理的典型用途是将防火墙后面的服务器提供给Internet用户访问。反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。另外，反向代理还可以启用高级URL策略和管理技术，从而使处于不同web服务器系统的web页面同时存在于同一个URL空间下。

从<strong>安全性</strong>来讲：

正向代理允许客户端通过它访问任意网站并且隐藏客户端自身，因此你必须采取安全措施以确保仅为经过授权的客户端提供服务。反向代理对外都是透明的，访问者并不知道自己访问的是一个代理。

6.nginx 代理模块

<strong>http 代理官方中文文档</strong>：<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpproxy" target="\&quot;_blank\&quot;">http://www.howtocn.org/nginx:nginx%E6%A8%A1%</a><a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpproxy" target="\&quot;_blank\&quot;">E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpproxy</a>

说明：代理模块的指令有很多我这里只讲解重要的proxy_pass，想了解更多代理指令请参考官方中文文档。

这个模块可以转发请求到其他的服务器。<a target="\&quot;_blank\&quot;cronym">HTTP/1.0无法使用keepalive（后端服务器将为每个请求创建并且删除连接）。nginx为浏览器发送HTTP/1.1并为后端服务器发送HTTP/1.0，这样浏览器就可以为浏览器处理keepalive。
如下例：</a>
<div>
<div id="highlighter_639180" class="syntaxhighlighter  bash ">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">location / {</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">  </code><code class="bash plain">proxy_pass        http:</code><code class="bash plain">//localhost</code><code class="bash plain">:8000;</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">  </code><code class="bash plain">proxy_set_header  X-Real-IP  $remote_addr;</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注意，当使用http proxy模块（甚至FastCGI），所有的连接请求在发送到后端服务器之前nginx将缓存它们，因此，在测量从后端传送的数据时，它的进度显示可能不正确。

实验拓扑：

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277129R8hx.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="nginx4" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277130kMpI.png" alt="nginx4" height="461" border="0" /></a>

7.配置http反向代理
<div>
<div id="highlighter_588594" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># cd /etc/nginx/</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx nginx]</code><code class="bash comments"># cp nginx.conf nginx.conf.bak #备份一个原配置文件</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@nginx nginx]</code><code class="bash comments"># vim nginx.conf</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">location / {</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">               </code><code class="bash plain">proxy_pass      http:</code><code class="bash plain">//192</code><code class="bash plain">.168.18.201;</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">       </code><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
指令说明：<a target="\&quot;_blank\&quot;" name="proxy_pass"></a>proxy_pass

<strong>语法</strong>：proxy_pass <a target="\&quot;_blank\&quot;cronym">URL
<strong>默认值</strong>：no
<strong>使用字段</strong>：location, location中的if字段
这个指令设置被代理服务器的地址和被映射的URI，地址可以使用主机名或IP加端口号的形式，例如：</a>proxy_pass <a href="http://localhost:8000/uri/" target="\&quot;_blank\&quot;">http://localhost:8000/uri/</a>;

8.重新加载一下配置文件
<div>
<div id="highlighter_499153" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
9.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277130FG7E.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-style: none; border-color: initial; background-image: none;" title="t4" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277130d1m6.png" alt="t4" width="650" height="238" border="0" /></a>

注，大家可以看到，当我们访问192.168.18.208时，被代理重新定向到Web1上。

10.查看一下Web服务器日志
<div>
<div id="highlighter_755447" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># tail /var/log/httpd/access_log</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:14:20 +0800] </code><code class="bash string">"GET /favicon.ico HTTP/1.0"</code> <code class="bash plain">404 289 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:14:20 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:14:20 +0800] </code><code class="bash string">"GET /favicon.ico HTTP/1.0"</code> <code class="bash plain">404 289 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:14:45 +0800] </code><code class="bash string">"GET / HTTP/1.1"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:14:48 +0800] </code><code class="bash string">"GET /favicon.ico HTTP/1.1"</code> <code class="bash plain">404 289 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:14:55 +0800] </code><code class="bash string">"GET /favicon.ico HTTP/1.0"</code> <code class="bash plain">404 289 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:15:05 +0800] </code><code class="bash string">"GET /favicon.ico HTTP/1.0"</code> <code class="bash plain">404 289 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:15:13 +0800] </code><code class="bash string">"GET /favicon.ico HTTP/1.0"</code> <code class="bash plain">404 289 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:15:16 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">192.168.18.208 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:00:15:16 +0800] </code><code class="bash string">"GET /favicon.ico HTTP/1.0"</code> <code class="bash plain">404 289 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，大家可以看到我们这里的客户的IP全是，nginx代理服务器的IP，并不是真实客户端的IP。下面我们修改一下，让日志的IP显示真实的客户端的IP。

11.修改nginx配置文件
<div>
<div id="highlighter_578607" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">location / {</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">        </code><code class="bash plain">proxy_pass      http:</code><code class="bash plain">//192</code><code class="bash plain">.168.18.201;</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">        </code><code class="bash plain">proxy_set_header  X-Real-IP  $remote_addr; </code><code class="bash comments">#加上这一行</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<strong>指令说明</strong>：<a target="\&quot;_blank\&quot;" name="proxy_set_header"></a>proxy_set_header

<strong>语法</strong>：proxy_set_header header value
<strong>默认值</strong>： Host and Connection
<strong>使用字段</strong>：http, server, location
这个指令允许将发送到被代理服务器的请求头重新定义或者增加一些字段。这个值可以是一个文本，变量或者它们的组合。proxy_set_header在指定的字段中没有定义时会从它的上级字段继承。

12.重新加载一下配置文件
<div>
<div id="highlighter_330175" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
13.测试并查看日志
<div>
<div id="highlighter_118481" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># tail /var/log/httpd/access_log</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">192.168.18.208 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:16:26:18 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，大家可以看到日志记录的还是代理的IP，没有显示真实客户端的IP，为什么呢？我们来看一下httpd的配置文件。

14.查看并修改httpd配置文件

[root@web1 ~]# vim /etc/httpd/conf/httpd.conf

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277131PzsJ.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-style: none; border-color: initial; background-image: none;" title="t5" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277131UTCv.png" alt="t5" width="650" height="93" border="0" /></a>

注，大家可以这里记录日志的参数还是%h，下面我们修改一下参数。

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277131KI4g.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-style: none; border-color: initial; background-image: none;" title="t6" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277131Ug5u.png" alt="t6" width="650" height="93" border="0" /></a>

注，这是修改后的参数，将h%修改为%{X-Real-IP}i，好的下面我们再来测试一下。

15.重启并测试
<div>
<div id="highlighter_91208" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># service httpd restart</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">停止 httpd：                                               [确定]</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">正在启动 httpd：                                           [确定]</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># tail /var/log/httpd/access_log</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:14 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:14 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number12 index11 alt1"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number13 index12 alt2"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number14 index13 alt1"><code class="bash plain">192.168.18.138 - - [03</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:17:09:15 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，大家可以看到现在的日志里记录的IP地址就是真实的客户端地址了。好了，到这里Nginx代理后端一台服务器就演示到这里，下面我们继续说。

五、Nginx之负载均衡

注，大家可以看到，由于我们网站是发展初期，nginx只代理了后端一台服务器，但由于我们网站名气大涨访问的人越来越多一台服务器实在是顶不住，于是我们加了多台服务器，那么多台服务器又怎么配置代理呢，我们这里以两台服务器为案例，为大家做演示。

1.upstream 负载均衡模块说明

案例：

下面设定负载均衡的服务器列表。
<div>
<div id="highlighter_400728" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">upstream </code><code class="bash functions">test</code><code class="bash plain">.net{</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">ip_hash;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">server 192.168.10.13:80;</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">server 192.168.10.14:80  down;</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">server 192.168.10.15:8009  max_fails=3  fail_timeout=20s;</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">server 192.168.10.16:8080;</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">}</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">server {</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">  </code><code class="bash plain">location / {</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">    </code><code class="bash plain">proxy_pass  http:</code><code class="bash plain">//test</code><code class="bash plain">.net;</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">  </code><code class="bash plain">}</code></div>
<div class="line number12 index11 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
upstream是Nginx的HTTP Upstream模块，这个模块通过一个简单的调度算法来实现客户端IP到后端服务器的负载均衡。在上面的设定中，通过upstream指令指定了一个负载均衡器的名称test.net。这个名称可以任意指定，在后面需要用到的地方直接调用即可。

2.upstream 支持的负载均衡算法

Nginx的负载均衡模块目前支持4种调度算法，下面进行分别介绍，其中后两项属于第三方调度算法。
<ul class=" list-paddingleft-2">
	<li>轮询（默认）。每个请求按时间顺序逐一分配到不同的后端服务器，如果后端某台服务器宕机，故障系统被自动剔除，使用户访问不受影响。Weight 指定轮询权值，Weight值越大，分配到的访问机率越高，主要用于后端每个服务器性能不均的情况下。</li>
	<li>ip_hash。每个请求按访问IP的hash结果分配，这样来自同一个IP的访客固定访问一个后端服务器，有效解决了动态网页存在的session共享问题。</li>
	<li>fair。这是比上面两个更加智能的负载均衡算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx本身是不支持fair的，如果需要使用这种调度算法，必须下载Nginx的upstream_fair模块。</li>
	<li>url_hash。此方法按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，可以进一步提高后端缓存服务器的效率。Nginx本身是不支持url_hash的，如果需要使用这种调度算法，必须安装Nginx 的hash软件包。</li>
</ul>
3.upstream 支持的状态参数

在HTTP Upstream模块中，可以通过server指令指定后端服务器的IP地址和端口，同时还可以设定每个后端服务器在负载均衡调度中的状态。常用的状态有：
<ul class=" list-paddingleft-2">
	<li>down，表示当前的server暂时不参与负载均衡。</li>
	<li>backup，预留的备份机器。当其他所有的非backup机器出现故障或者忙的时候，才会请求backup机器，因此这台机器的压力最轻。</li>
	<li>max_fails，允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误。</li>
	<li>fail_timeout，在经历了max_fails次失败后，暂停服务的时间。max_fails可以和fail_timeout一起使用。</li>
</ul>
注，当负载调度算法为ip_hash时，后端服务器在负载均衡调度中的状态不能是weight和backup。

4.实验拓扑

<a href="http://img1.51cto.com/attachment/201309/4/2033581_13782771327ebc.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="nginx3" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277132ARIU.png" alt="nginx3" height="442" border="0" /></a>

5.配置nginx负载均衡
<div>
<div id="highlighter_120619" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div>
<div class="line number15 index14 alt2">15</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">upstream webservers {</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">      </code><code class="bash plain">server 192.168.18.201 weight=1;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">      </code><code class="bash plain">server 192.168.18.202 weight=1;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">  </code><code class="bash plain">}</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">  </code><code class="bash plain">server {</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">      </code><code class="bash plain">listen       80;</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">      </code><code class="bash plain">server_name  localhost;</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">      </code><code class="bash comments">#charset koi8-r;</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">      </code><code class="bash comments">#access_log  logs/host.access.log  main;</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">      </code><code class="bash plain">location / {</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">              </code><code class="bash plain">proxy_pass      http:</code><code class="bash plain">//webservers</code><code class="bash plain">;</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">              </code><code class="bash plain">proxy_set_header  X-Real-IP  $remote_addr;</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">      </code><code class="bash plain">}</code></div>
<div class="line number15 index14 alt2"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，upstream是定义在server{ }之外的，不能定义在server{ }内部。定义好upstream之后，用proxy_pass引用一下即可。

6.重新加载一下配置文件
<div>
<div id="highlighter_626857" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
7.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277132Agjr.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t7" src="http://img1.51cto.com/attachment/201309/4/2033581_13782771331DV5.png" alt="t7" width="650" height="243" border="0" /></a>

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277133ASIL.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t8" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277133iCzt.png" alt="t8" width="650" height="249" border="0" /></a>

注，大家可以不断的刷新浏览的内容，可以发现web1与web2是交替出现的，达到了负载均衡的效果。

8.查看一下Web访问服务器日志

Web1:
<div>
<div id="highlighter_72208" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># tail /var/log/httpd/access_log</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:41:58 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:41:58 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:41:59 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:41:59 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:42:00 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:42:00 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:42:00 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:44:21 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:44:22 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:44:22 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
Web2:

先修改一下，Web服务器记录日志的格式。
<div>
<div id="highlighter_21221" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># vim /etc/httpd/conf/httpd.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">LogFormat </code><code class="bash string">"%{X-Real-IP}i %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</code> <code class="bash plain">combined</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># service httpd restart</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">停止 httpd：                                               [确定]</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">正在启动 httpd：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
接着，再访问多次，继续查看日志。
<div>
<div id="highlighter_431074" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># tail /var/log/httpd/access_log</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:28 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:29 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">192.168.18.138 - - [04</code><code class="bash plain">/Sep/2013</code><code class="bash plain">:09:50:29 +0800] </code><code class="bash string">"GET / HTTP/1.0"</code> <code class="bash plain">200 23 </code><code class="bash string">"-"</code> <code class="bash string">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.1; WOW64; Trident/6.0)"</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，大家可以看到，两台服务器日志都记录是192.168.18.138访问的日志，也说明了负载均衡配置成功。

9.配置nginx进行健康状态检查
<ul class=" list-paddingleft-2">
	<li>max_fails，允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误。</li>
	<li>fail_timeout，在经历了max_fails次失败后，暂停服务的时间。max_fails可以和fail_timeout一起使用，进行健康状态检查。</li>
</ul>
<div>
<div id="highlighter_31899" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">upstream webservers {</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">        </code><code class="bash plain">server 192.168.18.201 weight=1 max_fails=2 fail_timeout=2;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">        </code><code class="bash plain">server 192.168.18.202 weight=1 max_fails=2 fail_timeout=2;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">    </code><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
10.重新加载一下配置文件
<div>
<div id="highlighter_110967" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
11.停止服务器并测试
<div>
<div id="highlighter_652086" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">先停止Web1，进行测试。</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># service httpd stop</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">停止 httpd：                                               [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277134foMO.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t8" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277134jg08.png" alt="t8" width="650" height="249" border="0" /></a>

注，大家可以看到，现在只能访问Web2，再重新启动Web1，再次访问一下。
<div>
<div id="highlighter_111372" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># service httpd start</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">正在启动 httpd：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277134rE2d.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t7" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277135pRL2.png" alt="t7" width="650" height="243" border="0" /></a>

<a href="http://img1.51cto.com/attachment/201309/4/2033581_13782771357X8P.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t8" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277135HnX8.png" alt="t8" width="650" height="249" border="0" /></a>

注，大家可以看到，现在又可以重新访问，说明nginx的健康状态查检配置成功。但大家想一下，如果不幸的是所有服务器都不能提供服务了怎么办，用户打开页面就会出现出错页面，那么会带来用户体验的降低，所以我们能不能像配置LVS是配置sorry_server呢，答案是可以的，但这里不是配置sorry_server而是配置backup。

12.配置backup服务器
<div>
<div id="highlighter_975724" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div>
<div class="line number15 index14 alt2">15</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">server {</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">                </code><code class="bash plain">listen 8080;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">                </code><code class="bash plain">server_name localhost;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">                </code><code class="bash plain">root </code><code class="bash plain">/data/www/errorpage</code><code class="bash plain">;</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">                </code><code class="bash plain">index index.html;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">        </code><code class="bash plain">}</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">upstream webservers {</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">        </code><code class="bash plain">server 192.168.18.201 weight=1 max_fails=2 fail_timeout=2;</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">        </code><code class="bash plain">server 192.168.18.202 weight=1 max_fails=2 fail_timeout=2;</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">        </code><code class="bash plain">server 127.0.0.1:8080 backup;</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">    </code><code class="bash plain">}</code></div>
<div class="line number13 index12 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># mkdir -pv /data/www/errorpage</code></div>
<div class="line number14 index13 alt1"><code class="bash plain">[root@nginx errorpage]</code><code class="bash comments"># cat index.html</code></div>
<div class="line number15 index14 alt2"><code class="bash plain">&lt;h1&gt;Sorry......&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
13.重新加载配置文件
<div>
<div id="highlighter_321133" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx errorpage]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
14.关闭Web服务器并进行测试
<div>
<div id="highlighter_83961" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># service httpd stop</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">停止 httpd：                                               [确定]</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># service httpd stop</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">停止 httpd：                                               [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277136O5jD.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t9" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277136aoPm.png" alt="t9" width="650" height="243" border="0" /></a>

注，大家可以看到，当所有服务器都不能工作时，就会启动备份服务器。好了，backup服务器就配置到这里，下面我们来配置ip_hash负载均衡。

15.配置ip_hash负载均衡
<ul class=" list-paddingleft-2">
	<li>ip_hash，每个请求按访问IP的hash结果分配，这样来自同一个IP的访客固定访问一个后端服务器，有效解决了动态网页存在的session共享问题。（一般电子商务网站用的比较多）</li>
</ul>
<div>
<div id="highlighter_776401" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">upstream webservers {</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">        </code><code class="bash plain">ip_hash;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">        </code><code class="bash plain">server 192.168.18.201 weight=1 max_fails=2 fail_timeout=2;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">        </code><code class="bash plain">server 192.168.18.202 weight=1 max_fails=2 fail_timeout=2;</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">        </code><code class="bash comments">#server 127.0.0.1:8080 backup;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">    </code><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，当负载调度算法为ip_hash时，后端服务器在负载均衡调度中的状态不能有backup。（有人可能会问，为什么呢？大家想啊，如果负载均衡把你分配到backup服务器上，你能访问到页面吗？不能，所以了不能配置backup服务器）

16.重新加载一下服务器
<div>
<div id="highlighter_473719" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
17.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277136mMbM.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t10" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277137krp2.png" alt="t10" width="650" height="240" border="0" /></a>

注，大家可以看到，你不断的刷新页面一直会显示的民Web2，说明ip_hash负载均衡配置成功。下面我们来统计一下Web2的访问连接数。

18.统计Web2的访问连接数
<div>
<div id="highlighter_188783" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web2 ~]</code><code class="bash comments"># netstat -an | grep :80 | wc -l</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">304</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，你不断的刷新，连接数会越来越多。好了，nginx的负载均衡就全部演示到这里下面我们来说一说，页面缓存。

六、Nginx之页面缓存

1.指令说明
<h5><a target="\&quot;_blank\&quot;" name="proxy_cache_path"></a>proxy_cache_path</h5>
<strong>语法</strong>：proxy_cache_path path [levels=number] keys_zone=zone_name:zone_size [inactive=time] [max_size=size];
<strong>默认值</strong>：None
<strong>使用字段</strong>：http
指令指定缓存的路径和一些其他参数，缓存的数据存储在文件中，并且使用代理url的哈希值作为关键字与文件名。levels参数指定缓存的子目录数，例如：
<div>
<div id="highlighter_865067" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">proxy_cache_path  </code><code class="bash plain">/data/nginx/cache</code>  <code class="bash plain">levels=1:2   keys_zone=one:10m;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
文件名类似于：
<div>
<div id="highlighter_201432" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">/data/nginx/cache/c/29/b7f54b2df7773722d382f4809d65029c</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
levels指定目录结构，可以使用任意的1位或2位数字作为目录结构，如 X, X:X,或X:X:X 例如: “2”, “2:2”, “1:1:2“，但是最多只能是三级目录。
所有活动的key和元数据存储在共享的内存池中，这个区域用keys_zone参数指定。one指的是共享池的名称，10m指的是共享池的大小。
注意每一个定义的内存池必须是不重复的路径，例如：
<div>
<div id="highlighter_43884" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">proxy_cache_path  </code><code class="bash plain">/data/nginx/cache/one</code>    <code class="bash plain">levels=1      keys_zone=one:10m;</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">proxy_cache_path  </code><code class="bash plain">/data/nginx/cache/two</code>    <code class="bash plain">levels=2:2    keys_zone=two:100m;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">proxy_cache_path  </code><code class="bash plain">/data/nginx/cache/three</code>  <code class="bash plain">levels=1:1:2  keys_zone=three:1000m;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
如果在inactive参数指定的时间内缓存的数据没有被请求则被删除，默认inactive为10分钟。一个名为cache manager的进程控制磁盘的缓存大小，它被用来删除不活动的缓存和控制缓存大小，这些都在max_size参数中定义，当目前缓存的值超出max_size指定的值之后，超过其大小后最少使用数据（LRU替换算法）将被删除。内存池的大小按照缓存页面数的比例进行设置，一个页面（文件）的元数据大小按照操作系统来定，如FreeBSD/i386下为64字节，FreeBSD/amd64下为128字节。
<h5><a target="\&quot;_blank\&quot;" name="proxy_cache"></a>proxy_cache</h5>
<strong>语法</strong>：proxy_cache zone_name;
<strong>默认值</strong>：None
<strong>使用字段</strong>：http, server, location
设置一个缓存区域的名称，一个相同的区域可以在不同的地方使用。
在0.7.48后，缓存遵循后端的”Expires”, “Cache-Control: no-cache”, “Cache-Control: max-age=XXX”头部字段，0.7.66版本以后，”Cache-Control:“private”和”no-store”头同样被遵循。nginx在缓存过程中不会处理”Vary”头，为了确保一些私有数据不被所有的用户看到，后端必须设置 “no-cache”或者”max-age=0”头，或者proxy_cache_key包含用户指定的数据如$cookie_xxx，使用cookie的值作为proxy_cache_key的一部分可以防止缓存私有数据，所以可以在不同的location中分别指定proxy_cache_key的值以便分开私有数据和公有数据。
缓存指令依赖代理缓冲区(buffers)，如果proxy_buffers设置为off，缓存不会生效。
<h5><a target="\&quot;_blank\&quot;" name="proxy_cache_valid"></a>proxy_cache_valid</h5>
<strong>语法</strong>：proxy_cache_valid reply_code [reply_code …] time;
<strong>默认值</strong>：None
<strong>使用字段</strong>：http, server, location
为不同的应答设置不同的缓存时间，例如：
<div>
<div id="highlighter_13825" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">proxy_cache_valid  200 302  10m;</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">proxy_cache_valid  404      1m;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
为应答代码为200和302的设置缓存时间为10分钟，404代码缓存1分钟。
如果只定义时间：
<div>
<div id="highlighter_267144" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">proxy_cache_valid 5m;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
那么只对代码为200, 301和302的应答进行缓存。
同样可以使用any参数任何应答。
<div>
<div id="highlighter_459032" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">proxy_cache_valid  200 302 10m;</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">proxy_cache_valid  301 1h;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">proxy_cache_valid  any 1m;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
2.定义一个简单nginx缓存服务器
<div>
<div id="highlighter_387125" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">proxy_cache_path </code><code class="bash plain">/data/nginx/cache/webserver</code> <code class="bash plain">levels=1:2 keys_zone=webserver:20m max_size=1g;</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">   </code><code class="bash plain">server {</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">       </code><code class="bash plain">listen       80;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">       </code><code class="bash plain">server_name  localhost;</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">       </code><code class="bash comments">#charset koi8-r;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">       </code><code class="bash comments">#access_log  logs/host.access.log  main;</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">       </code><code class="bash plain">location / {</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">               </code><code class="bash plain">proxy_pass      http:</code><code class="bash plain">//webservers</code><code class="bash plain">;</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">               </code><code class="bash plain">proxy_set_header  X-Real-IP  $remote_addr;</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">               </code><code class="bash plain">proxy_cache webserver;</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">               </code><code class="bash plain">proxy_cache_valid 200 10m;</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">       </code><code class="bash plain">}</code></div>
<div class="line number14 index13 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
3.新建缓存目录
<div>
<div id="highlighter_818365" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># mkdir -pv /data/nginx/cache/webserver</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
4.重新加载一下配置文件
<div>
<div id="highlighter_126032" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx webserver]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
5.下面我们来测试一下（谷歌浏览器）

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277137HA0v.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t11" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277138abuG.png" alt="t11" width="650" height="673" border="0" /></a>

注，大家用谷歌浏览器测试的时候，可以按F12调用开发工具，选择Network选项，我们可以看到，Response Headers，在这里我们可以看到，我们请求的是否是缓存，但现在还看不到，下面我们来配置一下，再来测试。

6. 缓存变量说明
<h5><a target="\&quot;_blank\&quot;" name="server_addr"></a>$server_addr</h5>
服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用bind参数。
<h5><a target="\&quot;_blank\&quot;" name="upstream_cache_status"></a>$upstream_cache_status</h5>
0.8.3版本中其值可能为：
<ul class=" list-paddingleft-2">
	<li>MISS 未命中</li>
	<li>EXPIRED - expired。请求被传送到后端。</li>
	<li>UPDATING - expired。由于proxy/fastcgi_cache_use_stale正在更新，将使用旧的应答。</li>
	<li>STALE - expired。由于proxy/fastcgi_cache_use_stale，后端将得到过期的应答。</li>
	<li>HIT 命中</li>
</ul>
<div>
<div id="highlighter_407920" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div>
<div class="line number15 index14 alt2">15</div>
<div class="line number16 index15 alt1">16</div>
<div class="line number17 index16 alt2">17</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">proxy_cache_path </code><code class="bash plain">/data/nginx/cache/webserver</code> <code class="bash plain">levels=1:2 keys_zone=webserver:20m max_size=1g;</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">    </code><code class="bash plain">server {</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">        </code><code class="bash plain">listen       80;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">        </code><code class="bash plain">server_name  localhost;</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">        </code><code class="bash comments">#charset koi8-r;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">        </code><code class="bash comments">#access_log  logs/host.access.log  main;</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">       </code><code class="bash comments">#增加两头部</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">        </code><code class="bash plain">add_header X-Via $server_addr;</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">        </code><code class="bash plain">add_header X-Cache $upstream_cache_status;</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">        </code><code class="bash plain">location / {</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">                </code><code class="bash plain">proxy_pass      http:</code><code class="bash plain">//webservers</code><code class="bash plain">;</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">                </code><code class="bash plain">proxy_set_header  X-Real-IP  $remote_addr;</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">                </code><code class="bash plain">proxy_cache webserver;</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">                </code><code class="bash plain">proxy_cache_valid 200 10m;</code></div>
<div class="line number16 index15 alt1"><code class="bash spaces">        </code><code class="bash plain">}</code></div>
<div class="line number17 index16 alt2"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
7.重新加载一下配置文件
<div>
<div id="highlighter_709812" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
8.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277138fvON.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t12" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277139SRvW.png" alt="t12" width="650" height="677" border="0" /></a>

注，从图中我们可以看到，我们访问的服务器是192.168.18.208，缓存命中。大家可以看到是不是很直观啊。下面我们看一下缓存目录。

9.查看一下缓存目录
<div>
<div id="highlighter_956759" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># cd /data/nginx/cache/webserver/f/63/</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx 63]</code><code class="bash comments"># ls</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">681ad4c77694b65d61c9985553a2763f</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，缓存目录里确实有缓存文件。好了，nginx缓存配置就到这边了，更多配置请根据需要看配置文档。下面我们来说一下，URL重写。

七、Nginx之URL重写
<h3>1.<a target="\&quot;_blank\&quot;" name="url重写模块_rewrite"></a>URL重写模块（Rewrite）</h3>
<a target="\&quot;_blank\&quot;" name="摘要"></a>摘要

这个模块允许使用正则表达式重写URI（需PCRE库），并且可以根据相关变量重定向和选择不同的配置。如果这个指令在server字段中指定，那么将在被请求的location确定之前执行，如果在指令执行后所选择的location中有其他的重写规则，那么它们也被执行。如果在location中执行这个指令产生了新的URI，那么location又一次确定了新的URI。这样的循环可以最多执行10次，超过以后nginx将返回500错误。
<h4><a target="\&quot;_blank\&quot;" name="指令"></a>指令</h4>
<h5><a target="\&quot;_blank\&quot;" name="break"></a>break</h5>
<strong>语法</strong>：break
<strong>默认值</strong>：none
<strong>使用字段</strong>：server, location, if
完成当前设置的规则，停止执行其他的重写指令。
示例：
<div>
<div id="highlighter_516632" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash keyword">if</code> <code class="bash plain">($slow) {</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">  </code><code class="bash plain">limit_rate  10k;</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">  </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<h5><a target="\&quot;_blank\&quot;" name="if"></a>if</h5>
<strong>语法</strong>：if (condition) { … }
<strong>默认值</strong>：none
<strong>使用字段</strong>：server, location
<strong>注意</strong>：在使用if指令之前请查看<a href="http://wiki.nginx.org/IfIsEvil" target="\&quot;_blank\&quot;">if is evil page</a>并且尽量考虑用<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpcore#try_files" target="\&quot;_blank\&quot;">try_files</a>代替。
判断一个条件，如果条件成立，则后面的大括号内的语句将执行，相关配置从上级继承。
可以在判断语句中指定下列值：
<ul class=" list-paddingleft-2">
	<li>一个变量的名称；不成立的值为：空字符传”“或者一些用“0”开始的字符串。</li>
	<li>一个使用=或者!=运算符的比较语句。</li>
	<li>使用符号~*和~模式匹配的正则表达式：</li>
	<li>~为区分大小写的匹配。</li>
	<li>~*不区分大小写的匹配（firefox匹配FireFox）。</li>
	<li>!~和!~*意为“不匹配的”。</li>
	<li>使用-f和!-f检查一个文件是否存在。</li>
	<li>使用-d和!-d检查一个目录是否存在。</li>
	<li>使用-e和!-e检查一个文件，目录或者软链接是否存在。</li>
	<li>使用-x和!-x检查一个文件是否为可执行文件。</li>
</ul>
正则表达式的一部分可以用圆括号，方便之后按照顺序用$1-$9来引用。
示例配置：
<div>
<div id="highlighter_864508" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div>
<div class="line number15 index14 alt2">15</div>
<div class="line number16 index15 alt1">16</div>
<div class="line number17 index16 alt2">17</div>
<div class="line number18 index17 alt1">18</div>
<div class="line number19 index18 alt2">19</div>
<div class="line number20 index19 alt1">20</div>
<div class="line number21 index20 alt2">21</div>
<div class="line number22 index21 alt1">22</div>
<div class="line number23 index22 alt2">23</div>
<div class="line number24 index23 alt1">24</div>
<div class="line number25 index24 alt2">25</div>
<div class="line number26 index25 alt1">26</div>
<div class="line number27 index26 alt2">27</div>
<div class="line number28 index27 alt1">28</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash keyword">if</code> <code class="bash plain">($http_user_agent ~ MSIE) {</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">  </code><code class="bash plain">rewrite  ^(.*)$  </code><code class="bash plain">/msie/</code><code class="bash plain">$1  </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">}</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">                                                                                                                                                       </code></div>
<div class="line number5 index4 alt2"><code class="bash keyword">if</code> <code class="bash plain">($http_cookie ~* </code><code class="bash string">"id=([^;] +)(?:;|$)"</code> <code class="bash plain">) {</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">  </code><code class="bash functions">set</code>  <code class="bash plain">$</code><code class="bash functions">id</code>  <code class="bash plain">$1;</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">}</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">                                                                                                                                                       </code></div>
<div class="line number9 index8 alt2"><code class="bash keyword">if</code> <code class="bash plain">($request_method = POST ) {</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">  </code><code class="bash keyword">return</code> <code class="bash plain">405;</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">}</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">                                                                                                                                                       </code></div>
<div class="line number13 index12 alt2"><code class="bash keyword">if</code> <code class="bash plain">(!-f $request_filename) {</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">  </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
<div class="line number15 index14 alt2"><code class="bash spaces">  </code><code class="bash plain">proxy_pass  http:</code><code class="bash plain">//127</code><code class="bash plain">.0.0.1;</code></div>
<div class="line number16 index15 alt1"><code class="bash plain">}</code></div>
<div class="line number17 index16 alt2"><code class="bash spaces">                                                                                                                                                       </code></div>
<div class="line number18 index17 alt1"><code class="bash keyword">if</code> <code class="bash plain">($slow) {</code></div>
<div class="line number19 index18 alt2"><code class="bash spaces">  </code><code class="bash plain">limit_rate  10k;</code></div>
<div class="line number20 index19 alt1"><code class="bash plain">}</code></div>
<div class="line number21 index20 alt2"><code class="bash spaces">                                                                                                                                                       </code></div>
<div class="line number22 index21 alt1"><code class="bash keyword">if</code> <code class="bash plain">($invalid_referer) {</code></div>
<div class="line number23 index22 alt2"><code class="bash spaces">  </code><code class="bash keyword">return</code>   <code class="bash plain">403;</code></div>
<div class="line number24 index23 alt1"><code class="bash plain">}</code></div>
<div class="line number25 index24 alt2"><code class="bash spaces">                                                                                                                                                       </code></div>
<div class="line number26 index25 alt1"><code class="bash keyword">if</code> <code class="bash plain">($args ~ post=140){</code></div>
<div class="line number27 index26 alt2"><code class="bash spaces">  </code><code class="bash plain">rewrite ^ http:</code><code class="bash plain">//example</code><code class="bash plain">.com/ permanent;</code></div>
<div class="line number28 index27 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
内置变量$invalid_referer用指令valid_referers指定。
<h5><a target="\&quot;_blank\&quot;" name="return"></a>return</h5>
<strong>语法</strong>：return code
<strong>默认值</strong>：none
<strong>使用字段</strong>：server, location, if
这个指令结束执行配置语句并为客户端返回状态代码，可以使用下列的值：204，400，402-406，408，410, 411, 413, 416与500-504。此外，非标准代码444将关闭连接并且不发送任何的头部。
<h5><a target="\&quot;_blank\&quot;" name="rewrite"></a>rewrite</h5>
<strong>语法</strong>：rewrite regex replacement flag
<strong>默认值</strong>：none
<strong>使用字段</strong>：server, location, if
按照相关的正则表达式与字符串修改URI，指令按照在配置文件中出现的顺序执行。
可以在重写指令后面添加标记。
如果替换的字符串以http://开头，请求将被重定向，并且不再执行多余的rewrite指令。
尾部的标记(flag)可以是以下的值：
<ul class=" list-paddingleft-2">
	<li>last - 完成重写指令，之后搜索相应的URI或location。</li>
	<li>break - 完成重写指令。</li>
	<li>redirect - 返回302临时重定向，如果替换字段用http://开头则被使用。</li>
	<li>permanent - 返回301永久重定向。</li>
</ul>
注意如果一个重定向是相对的（没有主机名部分），nginx将在重定向的过程中使用匹配server_name指令的“Host”头或者server_name指令指定的第一个名称，如果头不匹配或不存在，如果没有设置server_name，将使用本地主机名，如果你总是想让nginx使用“Host”头，可以在server_name使用“*”通配符（查看http核心模块中的<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpcore#server_name" target="\&quot;_blank\&quot;">server_name</a>）。例如：
<div>
<div id="highlighter_112348" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">rewrite  ^(</code><code class="bash plain">/download/</code><code class="bash plain">.*)</code><code class="bash plain">/media/</code><code class="bash plain">(.*)\..*$  $1</code><code class="bash plain">/mp3/</code><code class="bash plain">$2.mp3  last;</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">rewrite  ^(</code><code class="bash plain">/download/</code><code class="bash plain">.*)</code><code class="bash plain">/audio/</code><code class="bash plain">(.*)\..*$  $1</code><code class="bash plain">/mp3/</code><code class="bash plain">$2.ra   last;</code></div>
<div class="line number3 index2 alt2"><code class="bash keyword">return</code>   <code class="bash plain">403;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
但是如果我们将其放入一个名为/download/的location中，则需要将last标记改为break，否则nginx将执行10次循环并返回500错误。
<div>
<div id="highlighter_641594" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">location </code><code class="bash plain">/download/</code> <code class="bash plain">{</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">  </code><code class="bash plain">rewrite  ^(</code><code class="bash plain">/download/</code><code class="bash plain">.*)</code><code class="bash plain">/media/</code><code class="bash plain">(.*)\..*$  $1</code><code class="bash plain">/mp3/</code><code class="bash plain">$2.mp3  </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">  </code><code class="bash plain">rewrite  ^(</code><code class="bash plain">/download/</code><code class="bash plain">.*)</code><code class="bash plain">/audio/</code><code class="bash plain">(.*)\..*$  $1</code><code class="bash plain">/mp3/</code><code class="bash plain">$2.ra   </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">  </code><code class="bash keyword">return</code>   <code class="bash plain">403;</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
如果替换字段中包含参数，那么其余的请求参数将附加到后面，为了防止附加，可以在最后一个字符后面跟一个问号：
<div>
<div id="highlighter_831966" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">rewrite  ^</code><code class="bash plain">/users/</code><code class="bash plain">(.*)$  </code><code class="bash plain">/show</code><code class="bash plain">?user=$1?  last;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注意：大括号（{和}），可以同时用在正则表达式和配置块中，为了防止冲突，正则表达式使用大括号需要用双引号（或者单引号）。例如要重写以下的URL：
<div>
<div id="highlighter_324366" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">/photos/123456</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
为:
<div>
<div id="highlighter_369000" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">/path/to/photos/12/1234/123456</code><code class="bash plain">.png</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
则使用以下正则表达式（注意引号）：
<div>
<div id="highlighter_943543" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">rewrite  </code><code class="bash string">"/photos/([0-9] {2})([0-9] {2})([0-9] {2})"</code> <code class="bash plain">/path/to/photos/</code><code class="bash plain">$1/$1$2/$1$2$3.png;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
如果指定一个“？”在重写的结尾，Nginx将丢弃请求中的参数，即变量<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpcore#args" target="\&quot;_blank\&quot;">$args</a>，当使用<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpcore#request_uri" target="\&quot;_blank\&quot;">$request_uri</a>或<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpcore#uri" target="\&quot;_blank\&quot;">$uri</a>&amp;<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpcore#args" target="\&quot;_blank\&quot;">$args</a>时可以在rewrite结尾使用“？”以避免nginx处理两次参数串。
在rewrite中使用$request_uri将www.example.com重写到example.com：
<div>
<div id="highlighter_172428" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">server {</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">   </code><code class="bash plain">server_name www.example.com;</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">   </code><code class="bash plain">rewrite ^ http:</code><code class="bash plain">//example</code><code class="bash plain">.com$request_uri? permanent;</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
同样，重写只对路径进行操作，而不是参数，如果要重写一个带参数的URL，可以使用以下代替：
<div>
<div id="highlighter_70010" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash keyword">if</code> <code class="bash plain">($args ^~ post=100){</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">  </code><code class="bash plain">rewrite ^ http:</code><code class="bash plain">//example</code><code class="bash plain">.com</code><code class="bash plain">/new-address</code><code class="bash plain">.html? permanent;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注意$args变量不会被编译，与location过程中的URI不同（参考http核心模块中的<a href="http://www.howtocn.org/nginx:nginx%E6%A8%A1%E5%9D%97%E5%8F%82%E8%80%83%E6%89%8B%E5%86%8C%E4%B8%AD%E6%96%87%E7%89%88:standardhttpmodules:httpcore#location" target="\&quot;_blank\&quot;">location</a>）。
<h5><a target="\&quot;_blank\&quot;" name="rewrite_log"></a>rewrite_log</h5>
<strong>语法</strong>：rewrite_log on | off
<strong>默认值</strong>：rewrite_log off
<strong>使用字段</strong>：server, location, if
<strong>变量</strong>：无
启用时将在error log中记录notice 标记的重写日志。
<h5><a target="\&quot;_blank\&quot;" name="set"></a>set</h5>
<strong>语法</strong>：set variable value
<strong>默认值</strong>：none
<strong>使用字段</strong>：server, location, if
指令设置一个变量并为其赋值，其值可以是文本，变量和它们的组合。
你可以使用set定义一个新的变量，但是不能使用set设置$http_xxx头部变量的值。
<h5><a target="\&quot;_blank\&quot;" name="uninitialized_variable_warn"></a>uninitialized_variable_warn</h5>
<strong>语法</strong>：uninitialized_variable_warn on|off
<strong>默认值</strong>：uninitialized_variable_warn on
<strong>使用字段</strong>：http, server, location, if
开启或关闭在未初始化变量中记录警告日志。
事实上，rewrite指令在配置文件加载时已经编译到内部代码中，在解释器产生请求时使用。
这个解释器是一个简单的堆栈虚拟机，如下列指令：
<div>
<div id="highlighter_279500" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">location </code><code class="bash plain">/download/</code> <code class="bash plain">{</code></div>
<div class="line number2 index1 alt1"><code class="bash spaces">  </code><code class="bash keyword">if</code> <code class="bash plain">($forbidden) {</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">    </code><code class="bash keyword">return</code>   <code class="bash plain">403;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">  </code><code class="bash plain">}</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">  </code><code class="bash keyword">if</code> <code class="bash plain">($slow) {</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">    </code><code class="bash plain">limit_rate  10k;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">  </code><code class="bash plain">}</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">  </code><code class="bash plain">rewrite  ^/(download/.*)</code><code class="bash plain">/media/</code><code class="bash plain">(.*)\..*$  /$1</code><code class="bash plain">/mp3/</code><code class="bash plain">$2.mp3  </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
将被编译成以下顺序：
<div>
<div id="highlighter_318432" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">variable $forbidden</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">checking to zero</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">recovery 403</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">completion of entire code</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">variable $slow</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">checking to zero</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">checkings of regular excodession</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">copying </code><code class="bash string">"/"</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">copying $1</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">copying </code><code class="bash string">"/mp3/"</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">copying $2</code></div>
<div class="line number12 index11 alt1"><code class="bash plain">copying </code><code class="bash string">".mp3"</code></div>
<div class="line number13 index12 alt2"><code class="bash plain">completion of regular excodession</code></div>
<div class="line number14 index13 alt1"><code class="bash plain">completion of entire sequence</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注意并没有关于limit_rate的代码，因为它没有提及ngx_http_rewrite_module模块，“if”块可以类似”location”指令在配置文件的相同部分同时存在。
如果$slow为真，对应的if块将生效，在这个配置中limit_rate的值为10k。
指令：
<div>
<div id="highlighter_196885" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">rewrite  ^/(download/.*)</code><code class="bash plain">/media/</code><code class="bash plain">(.*)\..*$  /$1</code><code class="bash plain">/mp3/</code><code class="bash plain">$2.mp3  </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
如果我们将第一个斜杠括入圆括号，则可以减少执行顺序：
<div>
<div id="highlighter_908931" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">rewrite  ^(</code><code class="bash plain">/download/</code><code class="bash plain">.*)</code><code class="bash plain">/media/</code><code class="bash plain">(.*)\..*$  $1</code><code class="bash plain">/mp3/</code><code class="bash plain">$2.mp3  </code><code class="bash keyword">break</code><code class="bash plain">;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
之后的顺序类似如下：
<div>
<div id="highlighter_886960" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">checking regular excodession</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">copying $1</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">copying </code><code class="bash string">"/mp3/"</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">copying $2</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">copying </code><code class="bash string">".mp3"</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">completion of regular excodession</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">completion of entire code</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<pre>2.简单案例</pre>
<pre>注，由于配置文件内容较多，为了让大家看着方便，我们备份一下配置文件，打开一个新的配置文件。</pre>
<div>
<div id="highlighter_915849" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div>
<div class="line number14 index13 alt1">14</div>
<div class="line number15 index14 alt2">15</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># cd /etc/nginx/</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx nginx]</code><code class="bash comments"># mv nginx.conf nginx.conf.proxy</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@nginx nginx]</code><code class="bash comments"># cp nginx.conf.bak nginx.conf</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">[root@nginx nginx]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">server {</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">      </code><code class="bash plain">listen       80;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">      </code><code class="bash plain">server_name  localhost;</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">      </code><code class="bash comments">#charset koi8-r;</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">      </code><code class="bash comments">#access_log  logs/host.access.log  main;</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">      </code><code class="bash plain">location / {</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">          </code><code class="bash plain">root   html;</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">          </code><code class="bash plain">index  index.html index.htm;</code></div>
<div class="line number13 index12 alt2"><code class="bash spaces">          </code><code class="bash plain">rewrite ^</code><code class="bash plain">/bbs/</code><code class="bash plain">(.*)$ http:</code><code class="bash plain">//192</code><code class="bash plain">.168.18.201</code><code class="bash plain">/forum/</code><code class="bash plain">$1;</code></div>
<div class="line number14 index13 alt1"><code class="bash spaces">      </code><code class="bash plain">}</code></div>
<div class="line number15 index14 alt2"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<pre>准备forum目录与测试文件</pre>
<div>
<div id="highlighter_979449" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># cd /var/www/html/</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@web1 html]</code><code class="bash comments"># ls</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">index.html</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">[root@web1 html]</code><code class="bash comments"># mkdir forum</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">[root@web1 html]</code><code class="bash comments"># cd forum/</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">[root@web1 forum]</code><code class="bash comments"># vim index.html</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">&lt;h1&gt;forum page!&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277139Z0NA.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t13" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277140b7uz.png" alt="t13" width="650" height="239" border="0" /></a>

好了，下面我们来测试一下rewrite重写。
<pre>3.重新加载一下配置文件</pre>
<div>
<div id="highlighter_670755" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx 63]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
4.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277140aPFs.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t14" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277140HxGb.png" alt="t14" width="650" height="577" border="0" /></a>

注，大家可以从图中看出，status code 302指的是临时重定向，那就说明我们rewrite重写配置成功。大家知道302是临时重定向而301是永久重定向，那么怎么实现永久重定向呢。一般服务器与服务器之间是临时重定向，服务器内部是永久重定向。下面我们来演示一下永久重定向。

5.配置永久重定向
<div>
<div id="highlighter_817136" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx nginx]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">server {</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">        </code><code class="bash plain">listen       80;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">        </code><code class="bash plain">server_name  localhost;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">        </code><code class="bash comments">#charset koi8-r;</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">        </code><code class="bash comments">#access_log  logs/host.access.log  main;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">        </code><code class="bash plain">location / {</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">            </code><code class="bash plain">root   html;</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">            </code><code class="bash plain">index  index.html index.htm;</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">            </code><code class="bash plain">rewrite ^</code><code class="bash plain">/bbs/</code><code class="bash plain">(.*)$ </code><code class="bash plain">/forum/</code><code class="bash plain">$1;</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">        </code><code class="bash plain">}</code></div>
<div class="line number12 index11 alt1"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<pre>准备forum目录与测试文件</pre>
<div>
<div id="highlighter_919664" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># cd /usr/html/</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@nginx html]</code><code class="bash comments"># ls</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">50x.html  index.html</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">[root@nginx html]</code><code class="bash comments"># mkdir forum</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">[root@nginx html]</code><code class="bash comments"># cd forum/</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">[root@nginx forum]</code><code class="bash comments"># vim index.html</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">&lt;h1&gt;192.168.18.208 forum page&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
6.重新加载一下配置文件
<div>
<div id="highlighter_739240" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
7.测试一下

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277141NTPi.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t16" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277141QQbY.png" alt="t16" width="650" height="615" border="0" /></a>

注，大家从图中可以看到，我们访问bbs/是直接帮我们跳转到forum/下，这种本机的跳转就是永久重定向也叫隐式重定向。好了，rewrite重定向我们就说到这里了，想要查询更多关于重定向的指令请参考官方文档。最后，我们来说一下读写分离。

八、Nginx之读写分离

1.实验拓扑

<a href="http://img1.51cto.com/attachment/201309/4/2033581_1378277142SiBu.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="nginx3" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277142c7NS.png" alt="nginx3" height="442" border="0" /></a>

需求分析，前端一台nginx做负载均衡反向代理，后面两台httpd服务器。整个架构是提供BBS(论坛)服务，有一需求得实现读写分离，就是上传附件的功能，我们上传的附件只能上传到Web1，然后在Web1上利用rsync+inotify实现附件同步，大家都知道rsync+inotify只能是主向从同步，不能双向同步。所以Web1可进行写操作，而Web2只能进行读操作，这就带来读写分离的需求，下面我们就来说一下，读写分离怎么实现。

2.WebDAV功能说明

WebDAV （Web-based Distributed Authoring and Versioning） 一种基于 HTTP 1.1协议的通信协议。它扩展了HTTP 1.1，在GET、POST、HEAD等几个HTTP标准方法以外添加了一些新的方法，使应用程序可直接对Web Server直接读写，并支持写文件锁定(Locking)及解锁(Unlock)，还可以支持文件的版本控制。这样我们就能配置读写分离功能了，下面我们来具体配置一下。

3.修改配置文件
<div>
<div id="highlighter_521135" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div>
<div class="line number12 index11 alt1">12</div>
<div class="line number13 index12 alt2">13</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx nginx]</code><code class="bash comments"># vim /etc/nginx/nginx.conf</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">server {</code></div>
<div class="line number3 index2 alt2"><code class="bash spaces">        </code><code class="bash plain">listen       80;</code></div>
<div class="line number4 index3 alt1"><code class="bash spaces">        </code><code class="bash plain">server_name  localhost;</code></div>
<div class="line number5 index4 alt2"><code class="bash spaces">        </code><code class="bash comments">#charset koi8-r;</code></div>
<div class="line number6 index5 alt1"><code class="bash spaces">        </code><code class="bash comments">#access_log  logs/host.access.log  main;</code></div>
<div class="line number7 index6 alt2"><code class="bash spaces">        </code><code class="bash plain">location / {</code></div>
<div class="line number8 index7 alt1"><code class="bash spaces">                </code><code class="bash plain">proxy_pass http:</code><code class="bash plain">//192</code><code class="bash plain">.168.18.202;</code></div>
<div class="line number9 index8 alt2"><code class="bash spaces">                </code><code class="bash keyword">if</code> <code class="bash plain">($request_method = </code><code class="bash string">"PUT"</code><code class="bash plain">){</code></div>
<div class="line number10 index9 alt1"><code class="bash spaces">                        </code><code class="bash plain">proxy_pass http:</code><code class="bash plain">//192</code><code class="bash plain">.168.18.201;</code></div>
<div class="line number11 index10 alt2"><code class="bash spaces">                </code><code class="bash plain">}</code></div>
<div class="line number12 index11 alt1"><code class="bash spaces">        </code><code class="bash plain">}</code></div>
<div class="line number13 index12 alt2"><code class="bash plain">}</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
4.重新加载一下配置文件
<div>
<div id="highlighter_238992" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># service nginx reload</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">nginx: the configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf syntax is ok</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">nginx: configuration </code><code class="bash functions">file</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash functions">test</code> <code class="bash plain">is successful</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">重新载入 nginx：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
5.配置httpd的WebDAV功能
<div>
<div id="highlighter_9645" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># vim /etc/httpd/conf/httpd.conf</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
<a href="http://img1.51cto.com/attachment/201309/4/2033581_13782771439FlB.png" target="\&quot;_blank\&quot;"><img style="padding: 0px; margin: 0px; vertical-align: top; border: 0px; background-image: none;" title="t17" src="http://img1.51cto.com/attachment/201309/4/2033581_1378277143SBSg.png" alt="t17" height="80" border="0" /></a>

注，在&lt;Directory "/var/www/html"&gt;下启用就行。

6.重新启动一下httpd
<div>
<div id="highlighter_939048" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># service httpd restart</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">停止 httpd：                                               [确定]</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">正在启动 httpd：                                           [确定]</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
7.测试一下
<div>
<div id="highlighter_914362" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># curl http://192.168.18.201</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">&lt;h1&gt;web1.</code><code class="bash functions">test</code><code class="bash plain">.com&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># curl http://192.168.18.202</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">&lt;h1&gt;web2.</code><code class="bash functions">test</code><code class="bash plain">.com&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，web1与web2访问都没问题。
<div>
<div id="highlighter_32411" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># curl -T /etc/issue  http://192.168.18.202</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">&lt;!DOCTYPE HTML PUBLIC </code><code class="bash string">"-//IETF//DTD HTML 2.0//EN"</code><code class="bash plain">&gt;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">&lt;html&gt;&lt;</code><code class="bash functions">head</code><code class="bash plain">&gt;</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">&lt;title&gt;405 Method Not Allowed&lt;</code><code class="bash plain">/title</code><code class="bash plain">&gt;</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">&lt;</code><code class="bash plain">/head</code><code class="bash plain">&gt;&lt;body&gt;</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">&lt;h1&gt;Method Not Allowed&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">The requested method PUT is not allowed </code><code class="bash keyword">for</code> <code class="bash plain">the URL </code><code class="bash plain">/issue</code><code class="bash plain">.</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">&lt;hr&gt;</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">&lt;address&gt;Apache</code><code class="bash plain">/2</code><code class="bash plain">.2.15 (CentOS) Server at 192.168.18.202 Port 80&lt;</code><code class="bash plain">/address</code><code class="bash plain">&gt;</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">&lt;</code><code class="bash plain">/body</code><code class="bash plain">&gt;&lt;</code><code class="bash plain">/html</code><code class="bash plain">&gt;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，我们上传文件到，web2上时，因为web2只人读功能，所以没有开户WebDAV功能，所以显示是405 Method Not Allowed。
<div>
<div id="highlighter_597873" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div>
<div class="line number11 index10 alt2">11</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># curl -T /etc/issue  http://192.168.18.201</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">&lt;!DOCTYPE HTML PUBLIC </code><code class="bash string">"-//IETF//DTD HTML 2.0//EN"</code><code class="bash plain">&gt;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">&lt;html&gt;&lt;</code><code class="bash functions">head</code><code class="bash plain">&gt;</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">&lt;title&gt;403 Forbidden&lt;</code><code class="bash plain">/title</code><code class="bash plain">&gt;</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">&lt;</code><code class="bash plain">/head</code><code class="bash plain">&gt;&lt;body&gt;</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">&lt;h1&gt;Forbidden&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">You don't have permission to access </code><code class="bash plain">/issue</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">on this server.</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">&lt;hr&gt;</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">&lt;address&gt;Apache</code><code class="bash plain">/2</code><code class="bash plain">.2.15 (CentOS) Server at 192.168.18.201 Port 80&lt;</code><code class="bash plain">/address</code><code class="bash plain">&gt;</code></div>
<div class="line number11 index10 alt2"><code class="bash plain">&lt;</code><code class="bash plain">/body</code><code class="bash plain">&gt;&lt;</code><code class="bash plain">/html</code><code class="bash plain">&gt;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，我们在Web1开启了WebDAV功能，但我们目录是root目录是不允许apache用户上传的，所以显示的是403 Forbidden。下面我们给apache授权，允许上传。
<div>
<div id="highlighter_602732" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># setfacl -m u:apache:rwx /var/www/html/</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
下面我们再来测试一下，
<div>
<div id="highlighter_245174" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div>
<div class="line number7 index6 alt2">7</div>
<div class="line number8 index7 alt1">8</div>
<div class="line number9 index8 alt2">9</div>
<div class="line number10 index9 alt1">10</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@nginx ~]</code><code class="bash comments"># curl -T /etc/issue  http://192.168.18.201</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">&lt;!DOCTYPE HTML PUBLIC </code><code class="bash string">"-//IETF//DTD HTML 2.0//EN"</code><code class="bash plain">&gt;</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">&lt;html&gt;&lt;</code><code class="bash functions">head</code><code class="bash plain">&gt;</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">&lt;title&gt;201 Created&lt;</code><code class="bash plain">/title</code><code class="bash plain">&gt;</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">&lt;</code><code class="bash plain">/head</code><code class="bash plain">&gt;&lt;body&gt;</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">&lt;h1&gt;Created&lt;</code><code class="bash plain">/h1</code><code class="bash plain">&gt;</code></div>
<div class="line number7 index6 alt2"><code class="bash plain">Resource </code><code class="bash plain">/issue</code> <code class="bash plain">has been created.</code></div>
<div class="line number8 index7 alt1"><code class="bash plain">&lt;hr /&gt;</code></div>
<div class="line number9 index8 alt2"><code class="bash plain">&lt;address&gt;Apache</code><code class="bash plain">/2</code><code class="bash plain">.2.15 (CentOS) Server at 192.168.18.201 Port 80&lt;</code><code class="bash plain">/address</code><code class="bash plain">&gt;</code></div>
<div class="line number10 index9 alt1"><code class="bash plain">&lt;</code><code class="bash plain">/body</code><code class="bash plain">&gt;&lt;</code><code class="bash plain">/html</code><code class="bash plain">&gt;</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
注，大家可以看到我们成功的上传了文件，说明nginx读写分离功能配置完成。最后，我们来查看一下上传的文件。
<div>
<div id="highlighter_454060" class="syntaxhighlighter  bash">
<table border="0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td class="gutter">
<div class="line number1 index0 alt2">1</div>
<div class="line number2 index1 alt1">2</div>
<div class="line number3 index2 alt2">3</div>
<div class="line number4 index3 alt1">4</div>
<div class="line number5 index4 alt2">5</div>
<div class="line number6 index5 alt1">6</div></td>
<td class="code">
<div class="container">
<div class="line number1 index0 alt2"><code class="bash plain">[root@web1 ~]</code><code class="bash comments"># cd /var/www/html/</code></div>
<div class="line number2 index1 alt1"><code class="bash plain">[root@web1 html]</code><code class="bash comments"># ll</code></div>
<div class="line number3 index2 alt2"><code class="bash plain">总用量 12</code></div>
<div class="line number4 index3 alt1"><code class="bash plain">drwxr-xr-x 2 root   root   4096 9月   4 13:16 forum</code></div>
<div class="line number5 index4 alt2"><code class="bash plain">-rw-r--r-- 1 root   root     23 9月   3 23:37 index.html</code></div>
<div class="line number6 index5 alt1"><code class="bash plain">-rw-r--r-- 1 apache apache   47 9月   4 14:06 issue</code></div>
</div></td>
</tr>
</tbody>
</table>
</div>
</div>
好了，到这里nginx的反向代理、负载均衡、页面缓存、URL重写及读写分离就全部讲解完成。希望大家有所收获，^_^……

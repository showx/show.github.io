---
layout: post
title: OProfile分析服务的瓶颈和CPU100%问题的利器
date: 2015-07-09 11:06
author: admin
comments: true
categories: []
---
<span style="font-family: 微软雅黑;">OProfile是一个非常好的工具，在Linux下分析一个软件或者服务的系统消耗和占用，进而辅助我们找到系统的瓶颈。例如，我们开启Oprofile在redis服务中，然后找到结果中redis耗时最多的几个函数，然后去了解这些函数是用在了什么地方，是否可以优化或者避免。

Oprofile的安装流程网上很多，就不写了哈。我写了一个方面测试的shell脚本，在安装好Oprofile后，可以很方便地用来测试这些系统服务。
简单的用法是：
</span>
<pre class="prettyprint"><span style="font-family: 微软雅黑;"><span class="pln">oprofile</span><span class="pun">.</span><span class="pln">sh </span><span class="str">"php test.php"</span></span></pre>
<span style="font-family: 微软雅黑;">当然，也可以只做sleep，不执行具体命令。直接休眠100s，抓取系统执行中的各种系统消耗。
</span>
<pre class="prettyprint"><span style="font-family: 微软雅黑;"><span class="pln">oprofile</span><span class="pun">.</span><span class="pln">sh </span><span class="str">"sleep 100"</span></span></pre>
<span style="font-family: 微软雅黑;">
shell的脚本代码如下：
</span>
<div>
<div><span style="font-family: 微软雅黑;"><span class="com">#部分系统不支持time interrupt，会导致抓不到数据，可使用modprobe oprofile timer=1</span></span></div>
<div><span style="font-family: 微软雅黑;"><span class="com">#查看状态：dmesg|grep oprofile，会追加多一行</span></span></div>
<div><span style="font-family: 微软雅黑;"> </span></div>
<div><span style="font-family: 微软雅黑;"><span class="com">#!/bin/bash</span>

<span class="kwd">if</span> <span class="pun">[</span><span class="pln"> $</span><span class="com"># -ne 1 ];then</span>
<span class="pln">        echo </span><span class="str">"Usage: oprofile.sh command"</span>
<span class="pln">        echo </span><span class="str">'Example: /root/oprofile/oprofile.sh "php test.php"'</span>
<span class="pln">        </span><span class="kwd">exit</span> <span class="lit">2</span><span class="pun">;</span>
<span class="kwd">fi</span>

<span class="pln">echo </span><span class="str">`date -d "today" +%Y%m%d%H%M%S`</span>

<span class="pln">opcontrol </span><span class="pun">--</span><span class="pln">start  </span><span class="pun">--</span><span class="kwd">no</span><span class="pun">-</span><span class="pln">vmlinux</span>
<span class="pln">opcontrol </span><span class="pun">--</span><span class="pln">reset</span>
<span class="pln">$1</span>
<span class="pln">opcontrol </span><span class="pun">--</span><span class="kwd">dump</span>
<span class="pln">opreport </span><span class="pun">-</span><span class="pln">l</span>
<span class="pln">opcontrol </span><span class="pun">--</span><span class="pln">stop</span>
<span class="pln">opcontrol </span><span class="pun">--</span><span class="pln">shutdown</span></span></div>
</div>
<span style="font-family: 微软雅黑;">系统如果支持time interrupt的话，执行命令
</span>
<pre class="prettyprint"><span style="font-family: 微软雅黑;"><span class="pln">dmesg</span><span class="pun">|</span><span class="pln">grep oprofile</span></span></pre>
<span style="font-family: 微软雅黑;"> </span>
<div><span style="font-family: 微软雅黑;"><img src="http://img0.ph.126.net/U97D19phikWYWpp3YSeodw==/6619431634142533332.png" alt="OProfile分析服务的性能和瓶颈 - 徐汉彬Hansion - 技术行者" /></span></div>
<span style="font-family: 微软雅黑;"> 否则的话，直接追加：
</span>
<pre class="prettyprint"><span style="font-family: 微软雅黑;"><span class="pln">modprobe oprofile timer</span><span class="pun">=</span><span class="lit">1</span></span></pre>
<span style="font-family: 微软雅黑;">
我使用上述脚本来分析过一次Nginx的执行结果（通过http_load工具来跑nginx的压力测试）：
</span>
<div><span style="font-family: 微软雅黑;"><img src="http://img1.ph.126.net/EhPrFPhmwK500YGP22F60A==/6619069894816997398.png" alt="OProfile分析服务的性能和瓶颈 - 徐汉彬Hansion - 技术行者" /></span></div>
<span style="font-family: 微软雅黑;">
我们也曾经遇到过Web服务器莫名其妙CPU100%的奇怪问题，也是通过oprofile分析后才发现一些可疑的函数库调用，反过来分析代码，找到问题原因。
下面这个图片，就是发现libxml大量占用CPU，让我们发现代码中解析xml的相关代码使用不当导致的。
</span>
<div><span style="font-family: 微软雅黑;"><img src="http://img2.ph.126.net/bHd8XD0eB5MCq_e5cE_NpA==/2407736950800558779.png" alt="OProfile分析服务的瓶颈和CPU100问题的利器 - 徐汉彬Hansion - 技术行者" /></span></div>
<span style="font-family: 微软雅黑;"> </span>

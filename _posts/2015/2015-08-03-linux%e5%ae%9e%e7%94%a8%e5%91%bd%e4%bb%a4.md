---
layout: post
title: linux实用命令
date: 2015-08-03 14:35
author: admin
comments: true
categories: []
---

硬件/系统基本操作
dmesg 系统信息(包括启动时相关的信息和警告等)

//查看系统所有硬件信息
lshw > sys.txt


检查服务状态：
service --status-all
service --status-all | less
service httpd status

列出所有服务启动级别：
chkconfig --list
(ubunut使用 sysv-rc-conf 需安装)

列出服务和他们对应的端口：
netstat -tulpn

查看版本
cat /etc/redhat-release
cat /etc/issue

设置服务器语言
vi /etc/profile
add:
export LC_ALL="zh_CN.UTF-8"   (或zh_CN.GB18030)

显示硬盘状态(普通raid0/1)
//最后一个参数为 0-n(raid组)
/usr/sbin/mpt-status --autoload  -s -i 2 -i 0
//通用
/usr/sbin/mpt-status --autoload  -s
megacli -LDInfo -Lall -aALL 查raid级别
megacli -AdpAllInfo -aALL 查raid卡信息
megacli -PDList -aALL 查看硬盘信息
megacli -LDInfo -LALL -aAll 显示所有逻辑磁盘组信息

//ubuntu10.04对Dell PERC 6/i Adapter阵列卡监控问题
http://hwraid.le-vert.net/wiki/DebianPackages
echo -e "\ndeb http://hwraid.le-vert.net/debian squeeze main" >> /etc/apt/sources.list
并更新, 安装
apt-get install megaclisas-status
运行 megaclisas-status 即可获得raid状态

//用户与权限
创建用户
useradd -d /www -g www-data -s /bin/sh www-data
#useradd -d /www/webhome -g www-data -s /bin/bash wwwftp
查看所有用户
vi /etc/passwd
修改主目录
usermod -d /usr/newfolder 用户名
(修改用户相关的其它参数[非密码]也使用这命令)
chgrp gname file 改变文件组
chown uname file 改变文件拥有人

创建文件链接
ln -s 文件名 链接文件名(可以为具体文件名, 也可以为目录名)
如果是建立目录的硬连接则用 -d

禁用shell，先 /etc/shells 增加 /bin/false 然后指定这个shell

检测网络缓慢或不通的原因(路由追踪)
tracert ip或域名

系统性能查看(sysstat 包)

cat /proc/meminfo

1. vmstat   //查看综合情况，包括CPU、Memory、I/O

2. iostat -x 1   //看看是谁发出的I/O请求（这里参考以前用bonie在干净系统测试的硬件能力）
iostat -d 2 5

3. top   //查看系统最活跃的应用程序

4. strace -p xxx   //跟踪这个进程都读了那些文件

5. dmesg 查看系统启动日志

sar -n DEV -u 1 10
看看当前网络流量

lftp多线程下载
lftp -c "pget -n 50 http://xxx"

网络状态
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}';
netstat -nat | wc -l
netstat -anp | wc -l

php-cgi连接状态
netstat -anp | grep php-cgi | wc -l
netstat -anp | grep :9000 | wc -l

php-cgi总线程
ps aux | grep php-cgi | wc -l

//捕获所有连接源
netstat -an -t tcp | grep ":80" | grep TIME_WAIT | awk '{printf "%s %s\n",$5,$6}' | sort >> /home/ylmfbbs/wait.txt

//使用虚拟用户的vsftpd密码生成
db_load -T -t hash -f user_pwds.txt /etc/vsftpd/vsftpd_login.db

//普通用户不启用shell无法登录
vi /etc/shells 增加 /bin/false


//安装服务自启动(必须init.d有这文件)
update-rc.d nginx defaults
update-rc.d vsftpd defaults
update-rc.d mysql defaults

//移除(移除自启动链接, 但不会删除 init.d的文件)
update-rc.d -f lighttpd remove

//查看链接数
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'

mysql默认安装
apt-get install mysql-server mysql-client

shutdown -h now  真正关机
shutdown -r now 重启 ( reboot )


Ubuntu下无法使用root登录Mysql的解决办法 

mysqldump -u 115search -h 192.168.5.205 -p 115_search > /home/ylmf/115_search.sql

2011-01-29 10:13:08|  分类： Hack |  标签：mysql  root  密码  ubuntu  debian   |字号 订阅
解决方法如下：
打开/etc/mysql/debian.cnf文件，记录下文件中［client］节提供的用户名和密码:

mysql -u debian-sys-maint -p
Enter password:<输入［client］节的密码>
mysql>use mysql;
mysql>UPDATE user SET Password= PASSWORD('密码')  where user='root';
mysql>quit

update user set Host = '192.168.5.%' where Host <> 'localhost' ;

select host, user from user;

flush privileges;

CREATE USER '115tool'@'192.168.5.%' IDENTIFIED BY '5H9BH7xnBJf4fH4Y';

GRANT USAGE ON * . * TO '115tool'@'192.168.5.%' IDENTIFIED BY '5H9BH7xnBJf4fH4Y' WITH MAX_QUERIES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_USER_CONNECTIONS 0 ;

GRANT ALL PRIVILEGES ON `115\_tool2` . * TO '115tool'@'192.168.5.%' WITH GRANT OPTION ;

GRANT ALL PRIVILEGES ON `dzbbs_utf8` . * TO 'dzbbs'@'192.168.5.%' WITH GRANT OPTION ;


//全权限用户
CREATE USER 'root'@'119.145.100.138' IDENTIFIED BY 'pwd';
GRANT ALL PRIVILEGES ON * . * TO 'root'@'119.145.100.138' IDENTIFIED BY 'pwd' WITH GRANT OPTION MAX_QUERIES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_USER_CONNECTIONS 0 ;

//查看mysql进程
show processlist;
显示运行状态
SHOW STATUS;
显示变量
Show Variables;
显示引擎
show engines;


//压缩/解压
tar cvf filename.tar source
tar xvf source_filename
tar zcvf filename.tar.gz source
tar zxvf source_filename

//基本开发环境
apt-get install build-essential


//防火墙设置
增加项目
iptables -A INPUT -s 0.0.0.0/0 -p tcp -m tcp --dport 873 -j ACCEPT

iptables -A INPUT -s 0.0.0.0/0 -p tcp -m tcp --dport 3306 -j ACCEPT

//保存
iptables-save > /etc/iptables.up.rules

//加载
iptables-restore < /etc/iptables.up.rules


SVN
//创建
svnadmin create web/union.demo.116.com
同步: 修改hooks文件
权限: 修改passwd文件

取出
svn co svn://xxx --username xxx --password xxx  target_dir

更新
svn update [-r] [m] path

删除
svn delete path -m "delete xxx"

/usr/bin/svnserve -d -r /www/svn/

解决冲突
svn resolved

//10.04 crond
crontab -e 生成一个文件(也可以直接编辑)
crontab -u root /var/spool/cron/crontabs/root
vi /var/spool/cron/crontabs/root
增加任务后
service cron restart

crontab文件格式:
* * * * * 命令
分 时 日 月 星期0～6(0表示星期天)  命令(允许有空格如 ls >> t.txt)

其中可数字表示格式有:

*/n 每间隔多少, 其中 */1 == * 本身
n1,n2,n3 指定时间是  n1 n2 n3
n1-n2    指定 n1 - n2 这个时间区间

这些格式可以混合使用, 如:
10-30/5 * * * * 表示 10-30分钟期间每隔5分钟


//tool.114la.com fast-cgi

/usr/local/spawn-fcgi/bin/spawn-fcgi -a 127.0.0.1 -p 9000 -C 4 -F 50 -u www-data -f /usr/bin/php-cgi


//格式化磁盘与挂载
查看分区
fdisk -l
fdisk /具体盘(对具体盘进行分区)
参数: p 查看已分区  n 创建新分区 d 删除分区

格式化:
mkfs -t ext3/4  /已分好的区

挂载:
mount -t ext4 /已分好的区 /挂载目录

自动加载:
/etc/fstab
UUID=abc22332-8e95-488d-a0a1-fa25e157b9ce   /挂载目录    ext4    defaults    0   2
UUID方式表示指定磁盘的第一个分区

指定挂载方式:
/已分好的区 /挂载目录 ext4 defaults 0 0


//查看某文件夹子目录文件大小
du -sm * | sort -n

//安装innodb
edit /etc/apparmor.d/usr.sbin.mysqld
add:
/usr/lib/mysql/plugin/ r,
/usr/lib/mysql/plugin/* mr,
reload apparmor and restart the MySQL service.

show variables like 'plugin_dir';
INSTALL PLUGIN InnoDB SONAME 'ha_innodb_plugin.so.0.0.0';



//时间设置
直接修改时间
date --set="07/17/13 11:31:00"
hwclock --systohc
//设置时间同步
rm /etc/localtime
ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
apt-get install ntp ntpupdate
/etc/init.d/ntp start

apt-get 查找包
apt-cache search 包名

//web服务器常用lib
apt-get install build-essential libxml2 libxml2-dev libevent-1.4-2 libevent-dev libcurl4-openssl-dev libgd2-xpm libgd2-xpm-dev libjpeg62 libjpeg62-dev libpng12-0 libpng12-dev  libgif4 libgift-dev libfreetype6 libfreetype6-dev  zlib1g zlib1g-dev libbz2-1.0 libbz2-dev libtool libmcrypt4 libmcrypt-dev libmysqlclient-dev libpcre3 libpcre3-dev autoconf

//12.04
apt-get install build-essential libxml2 libxml2-dev libevent-1.4-2 libevent-dev libcurl4-openssl-dev libgd2-xpm libjpeg62 libjpeg62-dev libpng12-0 libpng12-dev  libgif4 libfreetype6 libfreetype6-dev  zlib1g zlib1g-dev libbz2-1.0 libbz2-dev libtool libmcrypt4 libmcrypt-dev libmysqlclient-dev libpcre3 libpcre3-dev autoconf
* 14.04 没有 libgd2-xpm
* 8.04 用 libmysqlclient15-dev

//nginx编译

apt-get install libpcre3 libpcre3-dev zlib1g-dev

mkdir /var/tmp/nginx

./configure --prefix=/usr --sbin-path=/usr/sbin --conf-path=/etc/nginx/nginx.conf --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx.lock --error-log-path=/var/log/nginx/main_error.log --http-log-path=/var/log/nginx/ --http-client-body-temp-path=/var/tmp/nginx/client_body/ --http-proxy-temp-path=/var/tmp/nginx/proxy/ --http-fastcgi-temp-path=/var/tmp/nginx/fcgi/ --with-http_stub_status_module

--add-module=../ngx_cache_purge-1.2

//假如找不到libpcre
ln -s libpcre.so.3.12.1 libpcre.so.0

//php5.2编译
patch -d php-5.2.17 -p1 < php-5.2.13-fpm-0.5.14.diff
(如果没有打fpm补丁的包才用这个， 不装fpm可不必理会--enable-fpm后面相关参数)

./configure --prefix=/usr --with-config-file-path=/etc/php  --with-mysql --with-mysqli --with-pdo-mysql --with-gd --with-freetype-dir=/usr --with-jpeg-dir=/usr --with-png-dir=/usr --with-libxml-dir=/usr --with-zlib --enable-exif --enable-xml --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-bz2 --with-curl --with-curlwrappers --with-mcrypt --with-openssl --with-gettext --enable-filter --enable-simplexml --enable-mbstring --enable-soap --enable-discard-path --enable-fastcgi --enable-dba --enable-force-cgi-redirect --enable-ftp --enable-fpm --with-fpm-conf=/etc/php/php-fpm.conf --with-fpm-log=/var/log/php-fpm.log --with-fpm-pid=/var/run/php-fpm.pid

64位系统需加上：--with-libdir=lib/x86_64-linux-gnu  (php5.2x ubuntu)


//php5.3编译

./configure --prefix=/usr --with-config-file-path=/etc/php  --with-mysql --with-mysqli --with-pdo-mysql --with-gd --with-freetype-dir=/usr --with-jpeg-dir=/usr --with-png-dir=/usr --with-libxml-dir=/usr --with-zlib --enable-exif --enable-xml --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-bz2 --with-curl --with-curlwrappers --with-mcrypt --with-openssl --with-gettext --enable-filter --enable-simplexml --enable-mbstring --enable-soap --enable-dba --enable-ftp --enable-fpm

支持mysqlnd版本注意这个选项（使用mysqlnd本地化类，提升数据库处理性能）:
--enable-mysqlnd  --with-mysql=mysqlnd  --with-mysqli=mysqlnd  --with-pdo-mysql=mysqlnd

./configure --prefix=/usr --with-config-file-path=/etc/php  --enable-mysqlnd  --with-mysql=mysqlnd --with-mysqli=mysqlnd  --with-pdo-mysql=mysqlnd --with-gd --with-freetype-dir=/usr --with-jpeg-dir=/usr --with-png-dir=/usr --with-libxml-dir=/usr --with-zlib --enable-exif --enable-xml --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-bz2 --with-curl --with-curlwrappers --with-mcrypt --with-openssl --with-gettext --enable-filter --enable-simplexml --enable-mbstring --enable-soap --enable-dba --enable-ftp --enable-fpm

php-fpm配置默认在：
/usr/etc
兼容性选项
--enable-mbregex(ereg支持)
--enable-magic-quotes (支持magic-quotes)

php5可加上
--enable-opcache
参数

//编译扩展
/usr/bin/phpize

//茂名联通网关：
route add -net 125.211.218.82/32 dev eth0:0
route add -net 125.211.218.82/32 gw 58.253.70.1

//删除后台挂起的线程
kill -s 9 进程id


//NFS安装
apt-get install nfs-kernel-server nfs-common portmap
apt-get install nfs-common(客户机必须安装这个)
dpkg-reconfigure portmap (选择'no')
#注册服务自启动
sysv-rc-conf portmap on
sudo sysv-rc-conf nfs-kernel-server on
#设置共享目录和参数
vi /etc/exports
exportfs -rv(重新加载配置)
exportfs -au(卸载)
//防火墙设置
1、对访问host的限制
/etc/hosts.deny
### NFS DAEMONS
portmap:ALL
lockd:ALL
mountd:ALL
rquotad:ALL
statd:ALL
/etc/hosts.allow
### NFS DAEMONS
portmap: 192.168.5.
lockd: 192.168.5.
rquotad: 192.168.5.
mountd: 192.168.5.
statd: 192.168.5.

portmap restart

防火墙默认需要开放端口：



#启动服务
/etc/init.d/portmap start
/etc/init.d/nfs-kernel-server restart

mount -t nfs 192.168.5.209:/var/www/bbs/bbs.ylmf.net /www/bbs.ylmf.net
mount -t nfs 192.168.5.209:/www/pw /www/pw


//iptables启动关闭
//启动iptables
modprobe ip_tables

//关闭iptables(关闭命令要比启动复杂)
iptalbes -F
iptables -X
iptables -Z
iptables -P INPUT ACCEPUT
iptables -P OUTPUT ACCEPUT
iptables -P FORWARD ACCEPUT
modprobe -r ip_tables

VI技巧

替换行首为特定内容
:g/^/s//替换后的内容 /g
如: :g/^/s//rm -r /g

普通替换
:%s/源内容/替换后的内容/g

g 放在命令末尾，表示对搜索字符串的每次出现进行替换
不加 g，表示只对搜索字符串的首次出现进行替换
g 放在命令开头，表示对正文中所有包含搜索字符串的行进行替换操作


//时间修正
cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

ntpdate stdtime.gov.hk | ntp.ubuntu.com | time.nist.gov

安装 ntp 服务 修改 /etc/ntp.conf 加入
server stdtime.gov.hk
server ntp.ubuntu.com
server time.nist.gov

//查找文件进行删除
find ./ -type d ! -name . | xargs rm -r
find ./ -name . | xargs rm
例: 删除WEB上面含有的SVN信息
find -type d -name ".svn" | xargs rm -rf

//处理apt-get安装出错
mv /var/lib/dpkg/info /var/lib/dpkg/info_old
mkdir /var/lib/dpkg/info
apt-get update
apt-get -f install
mv /var/lib/dpkg/info/* /var/lib/dpkg/info_old
rm -rf /var/lib/dpkg/info
mv /var/lib/dpkg/info_old /var/lib/dpkg/info

压力测试软件
webbench -c 25000 -t 300 http://www.test.com/index.php

wget http://server-admin.114la.com/tmp/maxfile.sh

#提高并发支持数
ulimit -SHn 65535

蓝汛机房路由设置
在
/etc/iproute2/rt_tables
增加
252 tel
251 cnc
执行(x表示实际要处理的IP)
#! /bin/bash
TEL_IP=121.14.148.x
CNC_IP=112.90.217.x

ip route flush table tel
ip route add default via 121.14.148.1 dev eth0 src $TEL_IP table tel
ip rule add from $TEL_IP table tel

ip route flush table cnc
ip route add default via 112.90.217.254 dev eth1 src $CNC_IP table cnc
ip rule add from $CNC_IP table cnc

统计某文件夹下文件的个数
ls -l |grep "^-"|wc -l

统计某文件夹下目录的个数
ls -l |grep "^d"|wc -l

统计文件夹下文件的个数，包括子文件夹里的
ls -lR |grep "^-"|wc -l

#把centos命令行提示设置成和ubuntu一致
vi ~/.bashrc
在结尾加入
PS1="\u@\h:\w\$"

#列出进程包含进程详细信息
ps -ef

#线程调试跟踪
strace -p id

#定位lib文件位置
locate name

#列出全部uuid
blkid

#网卡实时流量监控
iftop -i eth0

#查看所有进程的文件打开数
lsof | wc -l
#查看某个进程打开的文件数
lsof -p pid |wc -l

重新配置服务器时区
dpkg-reconfigure tzdata

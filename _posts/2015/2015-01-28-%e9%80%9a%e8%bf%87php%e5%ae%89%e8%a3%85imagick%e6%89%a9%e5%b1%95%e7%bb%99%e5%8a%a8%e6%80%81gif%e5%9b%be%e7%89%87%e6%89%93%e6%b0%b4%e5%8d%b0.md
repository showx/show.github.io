---
layout: post
title: 通过php安装Imagick扩展给动态gif图片打水印
date: 2015-01-28 14:18
author: admin
comments: true
categories: []
---
一直以来php处理图片都是以gd为主流，直到近些年Imagick的使用才渐渐变多。

gd通常用来缩放图片，给图片打水印等基本功能，对于复杂效果如制作图标按钮、图倒影等滤镜功能就会力不从心。

尤其对于有多帧图片的动态gif图打水印，如果使用gd像处理普通jpg那样去打水印，打完水印后的图片只剩下第一帧，没有动态效果。

Imagick就能很好的胜任这一点，使得php给动态gif图片打水印成为可能，而且它还具有内存占用小，画质高的特点。

下面是分别使用gd(左图)和imagick(右图)把图片缩放到256px效果，请注意查看图片的细节。

<a href="http://www.nginx.cn/wp-content/uploads/2013/09/256-photo-gd.png"><img class="alignnone size-full wp-image-1176" src="http://www.nginx.cn/wp-content/uploads/2013/09/256-photo-gd.png" alt="256-photo-gd" width="201" height="286" /></a><a href="http://www.nginx.cn/wp-content/uploads/2013/09/256-photo-imagick.png"><img class="alignnone size-full wp-image-1177" src="http://www.nginx.cn/wp-content/uploads/2013/09/256-photo-imagick.png" alt="256-photo-imagick" width="199" height="286" /></a>

下面我会详细介绍“php怎么安装Imagick扩展”并实例说明如何給动态gif图片打水印。

&nbsp;

imagick有两种使用方式：

1.命令行下调用convert命令

2.php调用函数库Imagick(需要1作为安装基础)

&nbsp;

安装前的准备工作（ImageMagick 6.2.4+ , PHP 5.1.3+.），先安装需要的库文件
<pre class="prettyprint"><span class="pln">
yum install tcl</span><span class="pun">-</span><span class="pln">devel libpng</span><span class="pun">-</span><span class="pln">devel libjpeg</span><span class="pun">-</span><span class="pln">devel ghostscript</span><span class="pun">-</span><span class="pln">devel bzip2</span><span class="pun">-</span><span class="pln">devel freetype</span><span class="pun">-</span><span class="pln">devel libtiff</span><span class="pun">-</span><span class="pln">devel

yum install libjpeg</span><span class="pun">-</span><span class="pln">devel libpng</span><span class="pun">-</span><span class="pln">devel glib2</span><span class="pun">-</span><span class="pln">devel fontconfig</span><span class="pun">-</span><span class="pln">devel zlib</span><span class="pun">-</span><span class="pln">devel libwmf</span><span class="pun">-</span><span class="pln">devel freetype</span><span class="pun">-</span><span class="pln">devel libtiff</span><span class="pun">-</span><span class="pln">devel
</span></pre>
下载imagemagick并编译安装
<pre class="prettyprint"><span class="pln">wget </span><span class="pun">-</span><span class="pln">c http</span><span class="pun">:</span><span class="com">//www.imagemagick.org/download/ImageMagick.tar.gz</span><span class="pln">

tar </span><span class="pun">-</span><span class="pln">zxvf </span><span class="typ">ImageMagick</span><span class="pun">.</span><span class="pln">tar</span><span class="pun">.</span><span class="pln">gz

cd </span><span class="typ">ImageMagick</span><span class="pun">-</span><span class="lit">6.8</span><span class="pun">.</span><span class="lit">6</span><span class="pun">-</span><span class="lit">10</span>

<span class="pun">./</span><span class="pln">configure

make clean

make  </span><span class="pun">&amp;&amp;</span><span class="pln"> make install

sudo ldconfig </span><span class="pun">/</span><span class="pln">usr</span><span class="pun">/</span><span class="kwd">local</span><span class="pun">/</span><span class="pln">lib
</span></pre>
(编译安装过程时间比较长，请耐心等待。安装后 convert 的路径是 /usr/local/bin/convert，可以直接从命令行运行"convert -version"来看看版本。如果发现类似错误，convert: error while loading shared libraries: libMagickCore.so.3: cannot open shared object file: No such file or directory，可以执行"ldconfig /usr/"重新加载一下库文件的路径。)

到这里imagemagic命令行工具已经安装完成，也就是常说的convert命令，执行回下命令会生成logo.gif图片就表示命令行下的imagemagic安装完成了，快来体验一下吧。

cd /usr/local/nginx/html/
/usr/local/bin/convert logo: logo.gif

访问http://www.nginx.cn/logo.gif

如果你能看到这个图片就表示安装正确。
<a href="http://www.nginx.cn/wp-content/uploads/2013/09/imagic.gif"><img class="alignnone size-medium wp-image-1192" src="http://www.nginx.cn/wp-content/uploads/2013/09/imagic-300x289.gif" alt="image imagic" width="300" height="289" /></a>

高级命令令例子：

从中间裁切200x200正方形图片

convert 1.jpg -gravity center -extent 200x200 2.jpg

生成的图片最小的边要有500像素

convert 1.jpg -resize 500x500^ 2.jpg

合成一条，看看有多强大，你放张200x300左右的图片试下，这条命令将会将图片最小的边按比例强行扩大到500像素，再从正中央裁切200像素的正方式

convert 1.jpg -resize 500x500^ -gravity center -extent 200x200 2.jpg

给图片 base.jpg 在y100,x10的位置加上图片 sy.png 水印

composite -geometry +100+10 sy.png base.jpg finished.jpg

详细功能请参考官方手册

http://www.imagemagick.org/Usage/

php增加imagick扩展函数

1.译PHP原生库Imagick
wget http://pecl.php.net/get/imagick-3.1.1.tgz
tar zxvf imagick-3.1.1.tgz
cd imagick-3.1.1/
/usr/local/php/bin/phpize
ln -s /usr/local/include/ImageMagick-6 /usr/local/include/ImageMagick
./configure --with-php-config=/usr/local/php/bin/php-config
make
make install

/usr/local/php替换为你的php安装路径并确认bin目录下存在php-config文件

编译成功后会在php 扩展目录生成imagick.so
位置是
Installing shared extensions:
/usr/local/php/lib/php/extensions/no-debug-non-zts-20100525/
Installing header files:
/usr/local/php/include/php/

2.php加载Imagick库
修改php.ini，文件末尾加上一行
extension = "imagick.so"

如何查找php.ini的位置？
执行
/usr/local/php/bin/php --ini
会显示php.ini所在路径，路径下没有php.ini文件，
Configuration File (php.ini) Path: /usr/local/php/lib
Loaded Configuration File: (none)
Scan for additional .ini files in: (none)
Additional .ini files parsed: (none)

我们可以新建一个空的php.ini，并加入一行extension = "imagick.so"
vi /usr/local/php/lib
增加

extension = "imagick.so"

3.查看phpinfo，确认imagick是否加载成功

使用imagick库生产缩略图，logo.gif是前面用命令行生产的图片
[php]
&lt;?php
header('Content-type: image/jpeg');

$image = new Imagick('logo.gif');
$image-&gt;adaptiveResizeImage(1024,768);

echo $image;
?&gt;
[/php]

访问：htt://www.nginx.cn/p.php
<a href="http://www.nginx.cn/wp-content/uploads/2013/09/slt.gif"><img class="alignnone size-full wp-image-1196" src="http://www.nginx.cn/wp-content/uploads/2013/09/slt.gif" alt="slt" width="111" height="175" /></a>

[php]
&lt;?php
$image = new Imagick('old.gif');
$image = $image-&gt;coalesceImages();
foreach ($image as $frame) {
$frame-&gt;thumbnailImage(50, 50);
}
$image = $image-&gt;optimizeImageLayers();
$image-&gt;writeImages('new.gif', true);
?&gt;
[/php]

安装过程中遇到的错误：
magick/.libs/libMagickCore.so: undefined reference to `gzseek64'
magick/.libs/libMagickCore.so: undefined reference to `gztell64'
magick/.libs/libMagickCore.so: undefined reference to `gzopen64

从字面上看找不到64为的zlib，也就是说没能正确链接到64的zlib路径，我们可以安装64的zlib并把它的路径加到命令行(推荐方式)。

具体步骤

ldconfig -v |grep libz
显示，这个库是32位的所以连接失败
libz.so.1 -&gt; libz.so.1.2.3

wget http://zlib.net/zlib-1.2.8.tar.gz
tar -zxvf zlib-1.2.8.tar.gz
cd zlib-1.2.8

CFLAGS=-fPIC ./configure --libdir=/usr/lib64 --prefix=/usr
make
make install

cd ../ImageMagick-6.8.6-10/

./configure --with-zlib-dir=/usr/local/lib/

make

如果编译还是错误，可以把libz.so.1.2.3移动到其它位置

mv /usr/lib/libz.so.1.2.3 ~

ldconfig -v |grep libz
libz.so.1 -&gt; libz.so.1.2.8

再make就成功了。

checking for MagickWand.h header file... configure: error: Cannot locate header file MagickWand.h

新版的imagemagick路径修改了，需要建立到默认路径的软连接

ln -s /usr/local/include/ImageMagick-6 /usr/local/include/ImageMagick

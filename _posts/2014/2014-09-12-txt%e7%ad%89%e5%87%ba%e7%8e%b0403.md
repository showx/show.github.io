---
layout: post
title: txt等出现403
date: 2014-09-12 22:53
author: admin
comments: true
categories: []
---
访问txt等资源文件出现403,一般是权限问题。

把文件上传的权限默认设置644或700等即可。

===========
nginx deny txt, but allow robots.txt
Posted by cj-a-min on December 7, 2011 at 4:40am

Thanks for the module - Works great for multi-site setup.

My dilemma, which I googled and searched drupal; it seems like everyone forgot about robots.txt when they deny txt. - Don't know how this got pass everyone, but anyways. I need to allow robots.txt, and deny all txt.

Here is my nginx 1.0.5 config:
#www.xx.org redirect www to no www
server {
  server_name www.xx.org;
  access_log off;
  rewrite ^ $scheme://xx.org$request_uri permanent;
}
#mysite.org
server {
        server_name mysite.org;
## Deny certain agents or referer http://groups.drupal.org/node/39944
        if ($http_user_agent ~* (HTTrack|HTMLParser|libwww) ) {
        return 444;
}
if ($http_referer ~* (poker|sex) ) {
  return 444;
}
        location / {
                root   /srv/www/sites/pressflow6;
                index  index.html index.htm index.php;
                error_page 404 = @drupal;
                if (!-e $request_filename) {rewrite ^/(.*)$ /index.php?q=$1 last;}
                }
        location ~ \.php$ {
        include /srv/www/conf/sites/pressflow6/fastcgi_params;
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param  SCRIPT_FILENAME  /srv/www/sites/pressflow6/$fastcgi_script_name;
                }
        location ~* (/\..*|settings\.php$|\.(inc|info|install|module|en|txt|log|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(Entries.*|Repository|Root|Tag|Template))$ {
        deny all;
                }
        location = /robots.txt {
                allow all;
        }
        access_log /srv/www/log/sites/pressflow6/mysite.org/access.log;
        error_log /srv/www/log/sites/pressflow6/mysite.org/error.log;
}

Everything works beutifully, accept I get a 404 Not Found (from nginx, not drupal), when I goto to http://mysite.org/robots.txt. Now this happens with the moduled enabled (removed robots.txt from root) OR with module disabled (robots.txt in root). The following was taken straight from http://wiki.nginx.org/Drupal:
        location = /robots.txt {
                allow all;
        }

I also tried without the forward slash:
        location = robots.txt {
                allow all;
        }

This time I get 403 Forbidden from nginx.

I do keep restarting nginx anytime I change the config, and test.

What am I missing here?
Comments
cj-a-min’s picture
Comment #1
cj-a-min commented 3 years ago

After some research, I figured it out. You don't need to say "allow" in the config.

The following is a revamp of the nginx config file I used previously. I'll revisit later to do some tweaking. For now it works great!

Hope it helps someone. Or maybe someone can share some thoughts on this config.

#www.mysite.org redirect www to no www
server {
  server_name www.mysite.org;
  access_log off;
  rewrite ^ $scheme://mysite.org$request_uri permanent;
}
#mysite.org
server {
        server_name mysite.org;
        root   /srv/www/sites/pressflow6;
index  index.html index.htm index.php;
error_page 404 = @drupal;
        access_log /srv/www/log/sites/pressflow6/mysite.org/access.log;
        error_log /srv/www/log/sites/pressflow6/mysite.org/error.log;
#drupal specific
        location / {if (!-e $request_filename) {rewrite ^/(.*)$ /index.php?q=$1 last;}}
        if ($http_user_agent ~* (HTTrack|HTMLParser|libwww) ) {
        return 444;
}
if ($http_referer ~* (poker|sex) ) {
return 444;
}
#used ~* instead of = sign because my favicons are in other places; multi-site setup
        location ~* /favicon.ico {
                log_not_found off;
                access_log off;
        }
        location = /robots.txt {
                access_log off;
                log_not_found off;
#for robotstxt module
                try_files $uri @drupal;
        }
        location ~* \.(inc|engine|install|info|module|en|txt|sh|sql|theme|tpl\.php|xtmpl|Entries|Repository|Root|jar|java|class)$ {
                deny all;
        }
        location ~ \.php$ {
        include /srv/www/conf/sites/pressflow6/fastcgi_params;
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param  SCRIPT_FILENAME  /srv/www/sites/pressflow6$fastcgi_script_name;
        }
#get url from drupal
        location @drupal {
                rewrite ^/(.*)$ /index.php?q=$1;
        }
}


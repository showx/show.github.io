---
layout: post
title: php性能监测模块XHProf
date: 2013-12-04 22:05
author: admin
comments: true
categories: []
---
linux 一，什么是XHProf 
XHProf是一个分层PHP性能分析工具。它报告函数级别的请求次数和各种指标，包括阻塞时间，CPU时间和内存使用情况。一个函数的开销，可细分成调用者和被调用者的开销，XHProf数据收集阶段，它记录调用次数的追踪和包容性的指标弧在动态callgraph的一个程序。它独有的数据计算的报告/后处理阶段。在数据收集时，XHProfd通过检测循环来处理递归的函数调用，并通过给递归调用中每个深度的调用一个有用的命名来避开死循环。XHProf分析报告有助于理解被执行的代码的结构，它有一个简单的HTML的用户界面（ PHP写成的）。基于浏览器的性能分析用户界面能更容易查看，或是与同行们分享成果。也能绘制调用关系图。

二，安装XHProf扩展模块 
1，安装 
查看复制打印? 
wget http://pecl.php.net/get/xhprof-0.9.2.tgz 
tar zxvf xhprof-0.9.2.tgz 
cp ./xhprof-0.9.2.tgz ./www //xhprof自身带有一个web版的分析页面，放到我的web服务器下面 
cd xhprof-0.9.2/extension 
/usr/local/php/bin/phpize 
./configure –enable-xhprof –with-php-config=/usr/local/php/bin/php-config 
make && make install 
2，配置 
查看复制打印? 
[xhprof] 
extension=xhprof.so 
xhprof.output_dir=/home/zhangy/xhprof //如果不加存放目录的话，默认是放在/tmp下面 
三，XHProf测试 
前面我们说过了，XHProf自身带有一个web版的测试工具，里面还有一个小例子。看一下这个例子,我做了一点修改和注释 
查看复制打印? 
function bar($x) { 
if ($x > 0) { 
bar($x -1); 
} 
} 
function foo() { 
for ($idx = 0; $idx < 5; $idx++) { 
bar($idx); 
$x = strlen(“abc”); 
} 
}

//启动xhprof 
xhprof_enable(XHPROF_FLAGS_CPU + XHPROF_FLAGS_MEMORY);

//调用foo函数，也是我们要分析的函数 
foo();

//停止xhprof 
$xhprof_data = xhprof_disable();

//取得统计数据 
print_r($xhprof_data);

$XHPROF_ROOT = realpath(dirname(FILE) . '/..'); 
include_once $XHPROF_ROOT . “/xhprof_lib/utils/xhprof_lib.php”; 
include_once $XHPROF_ROOT . “/xhprof_lib/utils/xhprof_runs.php”;

//保存统计数据，生成统计ID和source名称 
$xhprof_runs = new XHProfRuns_Default(); 
$run_id = $xhprof_runs->save_run($xhprof_data, “xhprof_foo”); //source名称是xhprof_foo

//弹出一个统计窗口，查看统计信息 
echo ““; 
?> 
以下是部分的结果： 
查看复制打印? 
[foo==>bar] => Array 
( 
[ct] => 5 //bar()这个函数被调用了5次 
[wt] => 63 //每次运行bar()所要的时间，不知道这个是不是平均值 
[cpu] => 0 //每次运行bar()，cpu运算时间 
[mu] => 2860 //每次运行bar()，php所使用内存的改变 
[pmu] => 0 //每次运行bar()，php在内存使用最高峰时，所使用内存的改变 
)

windows下安装 
需要升级到php5.3以上 最好5.3.3 这个是前提 之后下面步骤 
[步骤] 
先要下载xhprof for windows版本，这个没得说，地址：http://www.benjamin-carl.de/?download=XHProf-0.10.0-PHP-5.3.3-VC6-x86-TS，下载的zip文件解压缩后是一个dll文件，直接放到php的ext目录里面就可以了

然后要把xhprof的两个包含了调试输出页面的子目录安置好，这里我选择了直接安置在自己网站发布位置的根目录里，也就是apache默认的htdocs的目录里面，我这里的htdocs是转移到另外一个开发U盘上的，方便在不同的地方编制代码，分别是xhprof_html、xhprof_lib、xprof_log，其中xhprof_html和xhprof_lib是从下载的xhprof源代码文件包里得到的，包所在站点：http://pecl.php.net/package/xhprof，xhprof下载地址：http://pecl.php.net/get/xhprof-0.9.2.tgz，然后自行在htdocs里创建xprof_log文件夹，这个文件夹是用来存放页面分析数据的。

由于我的Apache+php已经完全调试好，所以要处理的只有php.ini文件，开启办法很简单，在该文件的末尾加上如下代码即可： 
[xhprof] 
extension=php_xhprof.dll 
; directory used by default implementation of the iXHProfRuns 
; interface (namely, the XHProfRuns_Default class) for storing 
; XHProf runs. 
xhprof.output_dir=“M:/htdocs/xhprof_log” 
“提示：xhprof.output_dir=这个使用于设置性能分析数据存放位置的，我这里应为htdocs在M盘，故设置为M:/htdocs/xhprof_log，也就是上述的目录位置” 
添加成功后，可以重启Apache看看phpinfo()信息中是否包含了xhprof的段，有的话，那就安装成功了，提示：以cgi方式运行的php修改了php.ini以后，可以直接运行phpinfo()查看结果，

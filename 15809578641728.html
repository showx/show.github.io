

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    --- - shengsheng的博客
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="shengsheng的博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">---</h1>
        <p class="post-date">
                <span>Posted <time datetime="2020/02/06" itemprop="datePublished">2020/02/06</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<p>layout: post<br/>
title: 对比Mac OS上的PF与iptables<br/>
date: 2015-06-01 20:48<br/>
author: admin<br/>
comments: true</p>

<h2 id="toc_0">categories: []</h2>

<p>昨天同事问我怎么在Mac上配置策略路由，其实我也不知道！由于自己的实际需求，一直以来都想玩Mac网络功能，可是目光总被它炫烂的外表炫晕！今日同事这么一问我，顿时产生一种研究其究竟的欲望，还好，家里的电脑都是Mac系统(我非果粉，但老婆是)，周末带女儿上完早教课，终于可以闲下来玩一番了...<br/>
       其实，MacOS绚烂的外表下面，是一辆坦克，其内核是具有学院派高贵血统的BSD UNIX，而我们知道，UNIX网络的强大，TCP/IP和UNIX的关系，不禁觉得Mac的伟大，将UNIX放在时尚OL的双膝上内窥外瞟，而这是多么伟大的一项征服！<br/>
       我的实验拓扑如下：</p>

<p>iMac模拟一台终端，WIFI关闭，Macbook模拟路由器，WIFI开启，两台电脑之间用一根网线相连接。<br/>
       首先，我希望在Macbook上配置NAT，将作为内网的iMac发来的数据包做源地址转换，此时希望的NAT是动态NAT或者类似Linux的MAQUERADE的那种。Macbook上的WIFI接口连接我家的路由器，因此需要将从WIFI口en1出去的数据包做SNAT，类似Linux的-o en1 -j MASQUERADE这种，我知道在BSD上可以通过多种方式来配置，有一种类似Linux iptables的工具，那就是pf，通过编辑/etc/pf.conf来实现配置是再好不过的了，因为pfctl拥有规则语法检测机制，可以帮你检查到很多错误，那么以上的这个需求可以通过下面的配置完成：<br/>
nat on en1 from 172.16.4.0/24 to any -&gt; en1<br/>
其中，172.16.4.0/24是iMac所在段的地址，作为内网，而en1上则是所谓的外网地址192.168.1.108。实际上en1和地址段可以写成变量的形式，这里为了简单就直接写了，至于可以写成变量的形式，一会儿我要用这个和iptables和Cisco系统做对比。然后执行pfctl -e -f /etc/pf.conf就可以了！此时从iMac来ping 192.168.1.1路由器，就通了，然而从路由器却无法ping内网，这明显就是一个单向的转换，如果要做成双向的转换，那么就需要一个一一对应的转换了，在BSD中，这是通过binat实现的，主要在命令中，它加上了bi前缀，和bat区分开来，我们来看一下binat的配置：<br/>
binat on en1 from 172.16.4.10 to any -&gt; 172.16.4.30<br/>
这样就建立了一个一一的映射关系，不管从路由器主动发起还是从iMac主动发起，都可以实现地址转换，这就是我上一篇文章费了好大劲在Linux上实现的那个功能，不管是BSD还是Cisco，都可以轻而易举的完成配置，而Linux却很难，即使使用RAWNAT也还得配置两条规则！！！PF的一对一NAT虽然也内置了match，但你可以用any来覆盖它，最关键的，它独立成了binat，而不是nat的一个配置选项。<br/>
       NAT功能已经玩转了，每一件事情我都是希望最先试成功一个最小集合，然后再慢慢拓展，当初第一次碰到iptables的时候也一样。我一直都有一个疑惑，为何iptables没有实现一对一的地址转换？注意，Netfilter仅仅是一个框架，想实现任何功能都可以，所以我没有埋怨Netfilter而怪罪iptables。这是一个基本的需求啊，试想一个WEB服务器在DMZ区对外提供服务，而它还需要主动的访问另外的外部资源，这在云环境下很常见的，如果没有一一映射NAT，光是ip_conntrack就要消耗多少资源啊，而仅仅为了转换一个地址保持一个流是没有必要的。任何其它的操作系统都可以很容易实现的功能，Linux为何没有？另一个疑问就是，Mac OS为何没有把常用的功能开放出来，比如在一块网卡上添加多个IP。我猜想，Windows是比较中庸的系统，它提供添加多个地址，但是却没有iptables，iproute2之类的强大工具，即使netsh也只能算个鸡肋，相反，Linux和Mac OS就比较极端，特别是Mac OS，它假设使用它的人不是爱折腾网络的人，一个OL或者西装革履的墨镜先生是不会托着下巴配置策略路由的...然而在它的命令行却提供了几乎完整的BSD命令集，设计者又一次假设，如果一个购买Mac的人是一个技术狂，比如像我这样，那么他总是会第一时间调出命令行的，一旦调出命令行，一切就都在他眼前了，这样，将添加多个IP这个基本不会用到的功能做进GUI还有必要么？不禁崇敬Apple人啊！这方面，Windows和Linux都应该学习啊，我就不说重量级UNIX(比如AIX，HP-UX)了，因为那玩意儿一般人也不会接触到，相反Windows，Linux的接触人员还是很多的，Windows自不必说，Linux也是一款大众系统，特别是安卓时代以后。附上本段的一个补充：说了那么多Mac OS上添加Secodary IP的问题，到底怎么添加呢？ifconfig enX \(ip/\)mask alias即可，关键字是alias！<br/>
       到了本文最关键的时候了。pf的配置和iptables的配置哪个更加好呢？这当然不是仁者见仁智者见智的问题，可以毫不犹豫的说，iptables完败了！写过iptables规则控制脚本的人都很头疼，就是你得为你的每一个点子写一条rule，然后噩梦就来了，你时刻要注意在什么情况下要删除这个rule，还要确保删除干净...复杂的业务逻辑往往使这一点很难得到保证，于是你就只能将业务逻辑简单化以迁就iptables...这到底是为什么？？<br/>
       其根本原因就是iptables在每条规则层面上没有做到机制与策略分离，没有做到策略的可配置话，整条iptables规则的操作原子就是该条规则本身，比如你无法将一个match参数化，无法将一个target参数化，举以下例子：<br/>
iptables -A FORWARD -s 1.1.1.1 -d 2.2.2.2 -p tcp -j DROP<br/>
一旦这条规则设定了，如果有一天你控制的目标不再是2.2.2.2了，变成了3.3.3.3，那么你必须把这条规则删掉，然后再添加一条新的规则，你无法针对match对增删改操作。我们知道，一条规则蕴含的是一个判断逻辑，而具体的动作一定是要参数化的，这样才灵活，针对以上的例子规则，它蕴含的逻辑是，起始于某地到达某地的TCP包需要被丢弃！仅此而已，至于说陈述中的“某地”到底是什么，需要是可配置的。<br/>
       BSD的PF做到了这一点，它支持变量，宏等参数化配置概念。诸如最开始的NAT配置，像里面的IP地址这类配置，就可以像写BASH脚本一样定义。iptables的规则操作平面的缺失，确实是其硬伤，然而不能一棒子把它打死，我们知道ipset正是弥补这一缺失的努力成果之一，把匹配IP集合的定义移交给了ipset程序。我们期望见到的是很多的set，比如protoset，portset，stateset...在这方面，Cisco的NAT配置我们也可以看到类似的思想，Cisco剥离了ACL和NAT，ACL只负责match。<br/>
       但是并不是说PF就没有任何缺点，配置太庞杂了，比如配置策略路由：从哪个网口进来的访问包还从哪个网口出去。PF的实现方式是引入一系列硬配置route-to/reply，照这个逻辑，每一类的配置都需要引入一个配置参数咯，此法不妥啊，相反，Linux做的很好，通过mark的机制来实现策略路由，基于流的nf-mark可以标记一个流，很容易通过ip rule的fwmark来配置策略路由，策略路由本身并不是iptables负责的一块，iptables只管打mark，至于这个mark怎么用，它不管，策略路由在Linux中是单独实现的一块，和Netfilter没有任何关系。而PF则不同咯，其实它也有类似mark的tag机制，我觉得为了路由引入配置参数的方式不好。纵贯PF，它除了支持match参数化之外，其它的好像真的很乱，几乎所有的一切都可以用PF实现，NAT只是和PASS，BLOCK平行的一个action而已，另外，像什么代理之类的，统统都有相应的配置参数，我觉得这些都可以通过tag分出去的。<br/>
       遇到PF之前，总把iptables当成宝，实际上它真的就是！PF吸引人的地方在于其配置的可维护性。如果你有Mac，那么你就真的有了一个UNIX，可以折腾，任意的蹂躏，BSD UNIX强大的网络功能尽显眼前。</p>

    </div>
    <footer class="post-footer clearfix">
      
           
      
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  













        
      
  
    


    </body>
</html>



<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    --- - shengsheng的博客
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="shengsheng的博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">---</h1>
        <p class="post-date">
                <span>Posted <time datetime="2020/02/06" itemprop="datePublished">2020/02/06</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<p>layout: post<br/>
title: sphinx全文检索之PHP使用教程<br/>
date: 2014-03-14 14:42<br/>
author: admin<br/>
comments: true</p>

<h2 id="toc_0">categories: []</h2>

<p>数据结构：<br/>
<div id="highlighter_231314"><br/>
<div><br/>
<div><a title="view source" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#viewSource">view source</a><br/>
<div></div><br/>
<a title="print" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#printSource">print</a><a title="?" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#about">?</a></div><br/>
</div><br/>
<div><br/>
<div><code>01.</code><code>CREATE</code> <code>TABLE</code> <code>email (</code></div><br/>
<div><code>02.</code><code>emailid mediumint(8) unsigned </code><code>NOT</code> <code>NULL</code> <code>auto_increment COMMENT </code><code>&#39;邮件id&#39;</code><code>,</code></div><br/>
<div><code>03.</code></div><br/>
<div><code>04.</code><code>fromid </code><code>int</code><code>(10) unsigned </code><code>NOT</code> <code>NULL</code> <code>default</code> <code>&#39;0&#39;</code> <code>COMMENT </code><code>&#39;发送人ID&#39;</code><code>,</code></div><br/>
<div><code>05.</code></div><br/>
<div><code>06.</code><code>toid </code><code>int</code><code>(10) unsigned </code><code>NOT</code> <code>NULL</code> <code>default</code> <code>&#39;0&#39;</code> <code>COMMENT </code><code>&#39;收件人ID&#39;</code><code>,</code></div><br/>
<div><code>07.</code><code>content text unsigned </code><code>NOT</code> <code>NULL</code> <code>COMMENT </code><code>&#39;邮件内容&#39;</code><code>,</code></div><br/>
<div><code>08.</code><code>subject </code><code>varchar</code><code>(100) unsigned </code><code>NOT</code> <code>NULL</code> <code>COMMENT </code><code>&#39;邮件标题&#39;</code><code>,</code></div><br/>
<div><code>09.</code></div><br/>
<div><code>10.</code><code>sendtime </code><code>int</code><code>(10) </code><code>NOT</code> <code>NULL</code> <code>COMMENT </code><code>&#39;发送时间&#39;</code><code>,</code></div><br/>
<div><code>11.</code></div><br/>
<div><code>12.</code><code>attachment </code><code>varchar</code><code>(100) </code><code>NOT</code> <code>NULL</code> <code>COMMENT </code><code>&#39;附件ID，以逗号分割&#39;</code><code>, </code><code>PRIMARY</code> <code>KEY</code> <code>(emailid),</code></div><br/>
<div><code>13.</code><code>) ENGINE=MyISAM&#39;;</code></div><br/>
</div><br/>
</div><br/>
使用打开控制台，必需打开控制台PHP才能连接到sphinx（确保你已经建立好索引源）：</p>

<p>d:\coreseek\bin\searchd -c d:\coreseek\bin\sphinx.conf</p>

<p>coreseek/api目录下提供了PHP的接口文件 sphinxapi.php，这个文件包含一个SphinxClient的类</p>

<p>在PHP引入这个文件，new一下<br/>
<div id="highlighter_79825"><br/>
<div><br/>
<div><a title="view source" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#viewSource">view source</a><br/>
<div></div><br/>
<a title="print" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#printSource">print</a><a title="?" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#about">?</a></div><br/>
</div><br/>
<div><br/>
<div><code>01.</code><code>\(sphinx&lt;/code&gt; &lt;code&gt;= &lt;/code&gt;&lt;code&gt;new&lt;/code&gt; &lt;code&gt;SphinxClient();&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;02.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;03.&lt;/code&gt;&lt;code&gt;//sphinx的主机名和端口&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;04.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;05.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetServer ( </code><code>&#39;loclahost&#39;</code><code>, 9312 );</code></div><br/>
<div><code>06.</code></div><br/>
<div><code>07.</code><code>//设置返回结果集为php数组格式</code></div><br/>
<div><code>08.</code></div><br/>
<div><code>09.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetArrayResult ( true );&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;10.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;11.&lt;/code&gt;&lt;code&gt;//匹配结果的偏移量，参数的意义依次为：起始位置，返回结果条数，最大匹配条数&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;12.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;13.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetLimits(0, 20, 1000);</code></div><br/>
<div><code>14.</code></div><br/>
<div><code>15.</code><code>//最大搜索时间</code></div><br/>
<div><code>16.</code></div><br/>
<div><code>17.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetMaxQueryTime(10);&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;18.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;19.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;20.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;21.&lt;/code&gt;&lt;code&gt;//执行简单的搜索，这个搜索将会查询所有字段的信息，要查询指定的字段请继续看下文&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;22.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;23.&lt;/code&gt;&lt;code&gt;\)index</code> <code>= </code><code>&#39;email&#39;</code> <code>//索引源是配置文件中的 index 类，如果有多个索引源可使用,号隔开：&#39;email,diary&#39; 或者使用&#39;*&#39;号代表全部索引源</code></div><br/>
<div><code>24.</code></div><br/>
<div><code>25.</code><code>\(result&lt;/code&gt; &lt;code&gt;= &lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;query (</code><code>&#39;搜索关键字&#39;</code><code>, </code><code>$index</code><code>);</code></div><br/>
<div><code>26.</code></div><br/>
<div><code>27.</code><code>echo</code> <code>&#39;</code></div><br/>
</div><br/>
</div><br/>
<pre>&#39;;</p>

<p>print_r($result);</p>

<p>echo &#39;</pre><br/>
&#39;;</p>

<p>$result是一个数组，其中</p>

<p>total是匹配到的数据总数量</p>

<p>matches是匹配的数据，包含id，attrs这些信息</p>

<p>words是搜索关键字的分词</p>

<p>你可能奇怪为什么没有邮件的内容这些信息，其实sphinx并不会返回像mysql那样的数据数组，因为sphinx本来就没有记录完整的数据，只记录被分词后的数据。</p>

<p>具体还要看matches数组，matches中的ID就是指配置文件中sql_query SELECT语句中的第一个字段，我们配置文件中是这样的</p>

<p>sql_query = SELECT emailid,fromid,toid,subject,content,sendtime,attachement FROM email</p>

<p>所以matches中的ID是指emailid</p>

<p>至于weight是指匹配的权重，一般权重越高被返回的优先度也最高，匹配权重相关内容请参考官方文档</p>

<p>attrs是配置文件中sql_attr_ 中的信息，稍后会提到这些属性的用法</p>

<p>说了这么多，即使搜索到结果也不是我们想要的email数据，但事实sphinx是不记录真实数据的，所以要获取到真实email数据还要根据matches中的ID去搜索mysql的email表，但总体来说这样一来一回的速度还是远远比mysql的LIKE快得多，前提是几十万数据量以上，否则用sphinx只会更慢。</p>

<p>接下来介绍sphinx一些类似mysql条件的用法<br/>
<div id="highlighter_775959"><br/>
<div><br/>
<div><a title="view source" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#viewSource">view source</a><br/>
<div></div><br/>
<a title="print" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#printSource">print</a><a title="?" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#about">?</a></div><br/>
</div><br/>
<div><br/>
<div><code>01.</code><code>//emailid的范围</code></div><br/>
<div><code>02.</code></div><br/>
<div><code>03.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetIdRange(&lt;/code&gt;&lt;code&gt;\)min</code><code>, </code><code>\(max&lt;/code&gt;&lt;code&gt;);&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;04.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;05.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;06.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;07.&lt;/code&gt;&lt;code&gt;//属性过滤，可过滤的属性必需在配置文件中设置sql_attr_    ，之前我们定义了这些&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;08.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;09.&lt;/code&gt;&lt;code&gt;sql_attr_uint            = fromid&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;10.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;11.&lt;/code&gt;&lt;code&gt;sql_attr_uint            = toid&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;12.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;13.&lt;/code&gt;&lt;code&gt;sql_attr_timestamp  = sendtime&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;14.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;15.&lt;/code&gt;&lt;code&gt;//如果你想再次修改这些属性，配置完成后记得重新建立索引才能生效&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;16.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;17.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;18.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;19.&lt;/code&gt;&lt;code&gt;//指定一些值&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;20.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;21.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetFilter(</code><code>&#39;fromid&#39;</code><code>, </code><code>array</code><code>(1,2));    </code><code>//fromid的值只能是1或者2</code></div><br/>
<div><code>22.</code></div><br/>
<div><code>23.</code><code>//和以上条件相反，可增加第三个参数</code></div><br/>
<div><code>24.</code></div><br/>
<div><code>25.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetFilter(&lt;/code&gt;&lt;code&gt;&#39;fromid&#39;&lt;/code&gt;&lt;code&gt;, &lt;/code&gt;&lt;code&gt;array&lt;/code&gt;&lt;code&gt;(1,2), false);    &lt;/code&gt;&lt;code&gt;//fromid的值不能是1或者2&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;26.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;27.&lt;/code&gt;&lt;code&gt;//指定一个值的范围&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;28.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;29.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetFilterRange(</code><code>&#39;toid&#39;</code><code>, 5, 200);    </code><code>//toid的值在5-200之间</code></div><br/>
<div><code>30.</code></div><br/>
<div><code>31.</code><code>//和以上条件相反，可增加第三个参数</code></div><br/>
<div><code>32.</code></div><br/>
<div><code>33.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetFilterRange(&lt;/code&gt;&lt;code&gt;&#39;toid&#39;&lt;/code&gt;&lt;code&gt;, 5, 200, false);    &lt;/code&gt;&lt;code&gt;//toid的值在5-200以外&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;34.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;35.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;36.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;37.&lt;/code&gt;&lt;code&gt;//执行搜索&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;38.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;39.&lt;/code&gt;&lt;code&gt;\)result</code> <code>= </code><code>$sphinx</code><code>-&gt;query(</code><code>&#39;关键字&#39;</code><code>, </code><code>&#39;*&#39;</code><code>);</code></div><br/>
</div><br/>
</div><br/>
排序模式<br/>
可使用如下模式对搜索结果排序：</p>

<p>SPH_SORT_RELEVANCE 模式, 按相关度降序排列（最好的匹配排在最前面）</p>

<p>SPH_SORT_ATTR_DESC 模式, 按属性降序排列 （属性值越大的越是排在前面）</p>

<p>SPH_SORT_ATTR_ASC 模式, 按属性升序排列（属性值越小的越是排在前面）</p>

<p>SPH_SORT_TIME_SEGMENTS 模式, 先按时间段（最近一小时/天/周/月）降序，再按相关度降序</p>

<p>SPH_SORT_EXTENDED 模式, 按一种类似SQL的方式将列组合起来，升序或降序排列。</p>

<p>SPH_SORT_EXPR 模式，按某个算术表达式排序<br/>
<div id="highlighter_51631"><br/>
<div><br/>
<div><a title="view source" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#viewSource">view source</a><br/>
<div></div><br/>
<a title="print" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#printSource">print</a><a title="?" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#about">?</a></div><br/>
</div><br/>
<div><br/>
<div><code>01.</code><code>//使用属性排序</code></div><br/>
<div><code>02.</code></div><br/>
<div><code>03.</code><code>//以fromid倒序排序，注意当再次使用SetSortMode会覆盖上一个排序</code></div><br/>
<div><code>04.</code></div><br/>
<div><code>05.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetSortMode ( &lt;/code&gt;&lt;code&gt;&quot;SPH_SORT_ATTR_DESC&quot;&lt;/code&gt;&lt;code&gt;, &lt;/code&gt;&lt;code&gt;&#39;fromid&#39;&lt;/code&gt;&lt;code&gt;);&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;06.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;07.&lt;/code&gt;&lt;code&gt;//如果要使用多个字段排序可使用SPH_SORT_EXTENDED模式&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;08.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;09.&lt;/code&gt;&lt;code&gt;//@id是sphinx内置关键字，这里指emailid，至于为什么是emailid，自己思考一下&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;10.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;11.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetSortMode ( </code><code>&quot;SPH_SORT_ATTR_DESC&quot;</code><code>, </code><code>&#39;fromid ASC, toid DESC, @id DESC&#39;</code><code>);</code></div><br/>
<div><code>12.</code></div><br/>
<div><code>13.</code><code>//执行搜索</code></div><br/>
<div><code>14.</code></div><br/>
<div><code>15.</code><code>\(result&lt;/code&gt; &lt;code&gt;= &lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;query(</code><code>&#39;关键字&#39;</code><code>, </code><code>&#39;*&#39;</code><code>);</code></div><br/>
</div><br/>
</div><br/>
//更多请查看官方文档排序模式的说明</p>

<p>匹配模式<br/>
有如下可选的匹配模式：</p>

<p>SPH_MATCH_ALL, 匹配所有查询词(默认模式);</p>

<p>SPH_MATCH_ANY, 匹配查询词中的任意一个;</p>

<p>SPH_MATCH_PHRASE, 将整个查询看作一个词组，要求按顺序完整匹配;</p>

<p>SPH_MATCH_BOOLEAN, 将查询看作一个布尔表达式</p>

<p>SPH_MATCH_EXTENDED, 将查询看作一个CoreSeek/Sphinx内部查询语言的表达式 . 从版本Coreseek 3/Sphinx 0.9.9开始, 这个选项被选项SPH_MATCH_EXTENDED2代替，它提供了更多功能和更佳的性能。保留这个选项是为了与遗留的旧代码兼容——这样即使Sphinx及其组件包括API升级的时候，旧的应用程序代码还能够继续工作。</p>

<p>SPH_MATCH_EXTENDED2, 使用第二版的“扩展匹配模式”对查询进行匹配.</p>

<p>SPH_MATCH_FULLSCAN, 强制使用下文所述的“完整扫描”模式来对查询进行匹配。注意，在此模式下，所有的查询词都被忽略，尽管过滤器、过滤器范围以及分组仍然起作用，但任何文本匹配都不会发生.</p>

<p>我们要关注的主要是SPH_MATCH_EXTENDED2扩展匹配模式，扩展匹配模式允许使用一些像mysql的条件语句<br/>
<div id="highlighter_477460"><br/>
<div><br/>
<div><a title="view source" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#viewSource">view source</a><br/>
<div></div><br/>
<a title="print" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#printSource">print</a><a title="?" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#about">?</a></div><br/>
</div><br/>
<div><br/>
<div><code>01.</code><code>//设置扩展匹配模式</code></div><br/>
<div><code>02.</code></div><br/>
<div><code>03.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetMatchMode ( &lt;/code&gt;&lt;code&gt;&quot;SPH_MATCH_EXTENDED2&quot;&lt;/code&gt; &lt;code&gt;);&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;04.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;05.&lt;/code&gt;&lt;code&gt;//查询中使用条件语句，字段用@开头，搜索内容包含测试，toid等于1的邮件：&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;06.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;07.&lt;/code&gt;&lt;code&gt;\)result</code> <code>= </code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;query(&lt;/code&gt;&lt;code&gt;&#39;@content (测试) &amp;amp; @toid =1&#39;&lt;/code&gt;&lt;code&gt;, &lt;/code&gt;&lt;code&gt;&#39;*&#39;&lt;/code&gt;&lt;code&gt;);&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;08.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;09.&lt;/code&gt;&lt;code&gt;//用括号和&amp;amp;（与）、|、（或者）、-（非，即!=）设置更复杂的条件&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;10.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;11.&lt;/code&gt;&lt;code&gt;\)result</code> <code>= </code><code>$sphinx</code><code>-&gt;query(</code><code>&#39;(@content (测试) &amp; @subject =呃) | (@fromid -(100))&#39;</code><code>, </code><code>&#39;*&#39;</code><code>);</code></div><br/>
<div><code>12.</code></div><br/>
<div><code>13.</code><code>//更多语法请查看官方文档匹配模式的说明</code></div><br/>
</div><br/>
</div><br/>
扩展匹配模式中值得一提的是搜索的字段，如果该字段被设置属性，那么扩展匹配搜索的字段默认是不包含这些属性的，只能用SetFilter()或者SetFilterRange()之类</p>

<p>之前我们设置了fromid、toid、sendtime为属性，但又想在扩展匹配模式中又想用作条件该怎么办？</p>

<p>只要在sql_query语句中再选择多一次该字段就可以了</p>

<p>sql_query = SELECT emailid,fromid,fromid,toid,toid,subject,content,sendtime,sendtime,attachement FROM email</p>

<p>//设置完成记得重新建立索引</p>

<p>更多条件技巧<br/>
只是一些技巧，但不建议使用的部署环境中，至于为什么，请看文章结尾</p>

<p>&lt;、&lt;=、&gt;、&gt;=<br/>
默认sphinx没有这些比较符。</p>

<p>假如我想邮件的发送时间大于某一日期怎么办？用SetFilterRange()方法模拟一下<br/>
<div id="highlighter_412746"><br/>
<div><br/>
<div><a title="view source" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#viewSource">view source</a><br/>
<div></div><br/>
<a title="print" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#printSource">print</a><a title="?" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#about">?</a></div><br/>
</div><br/>
<div><br/>
<div><code>01.</code><code>//大于等于某一时间截\(time&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;02.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;03.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetFilterRange(</code><code>&#39;sendtime&#39;</code><code>, </code><code>\(time&lt;/code&gt;&lt;code&gt;, 10000000000) &lt;/code&gt;&lt;code&gt;//时间截最大是10个9，再加1是不可超越了。。&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;04.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;05.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;06.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;07.&lt;/code&gt;&lt;code&gt;//大于某一时间截\)time</code></div><br/>
<div><code>08.</code></div><br/>
<div><code>09.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetFilterRange(&lt;/code&gt;&lt;code&gt;&#39;sendtime&#39;&lt;/code&gt;&lt;code&gt;, &lt;/code&gt;&lt;code&gt;\)time</code><code>+1, 10000000000)</code></div><br/>
<div><code>10.</code></div><br/>
<div><code>11.</code><code>//小于等于某一时间截\(time&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;12.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;13.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetFilterRange(</code><code>&#39;sendtime&#39;</code><code>, -1, </code><code>\(time&lt;/code&gt;&lt;code&gt;)    &lt;/code&gt;&lt;code&gt;//时间截最小是0，所以应该减1&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;14.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;15.&lt;/code&gt;&lt;code&gt;//大于某一时间截\)time</code></div><br/>
<div><code>16.</code></div><br/>
<div><code>17.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetFilterRange(&lt;/code&gt;&lt;code&gt;&#39;sendtime&#39;&lt;/code&gt;&lt;code&gt;, -1, &lt;/code&gt;&lt;code&gt;\)time</code> <code>- 1)</code></div><br/>
</div><br/>
</div><br/>
IS NOT NULL<br/>
怎样搜索为空的字段，比如我要搜索附件为空的邮件，有人可能会想 @attachment (&#39;&#39;)不就可以了吗？其实这是搜索两个单引号。。。sphinx搜索的字符串不用加引号的</p>

<p>目前sphinx是没有提供这样的功能，其实可以在mysql语句上作手脚：</p>

<p>sql_query = SELECT emailid,fromid,toidsubject,content,sendtime,attachement != &#39;&#39; as attach is not null FROM email //这里返回了一个新字段attachisnotnull，当attachisnotnull为1的时候附件就不为空了</p>

<p>//设置完成记得重新建立索引</p>

<p>FIND_IN_SET()<br/>
搜索包含某一附件的邮件，mysql习惯用FIND_IN_SET这么简单一句就搞定了，在sphinx中必需在配置里设置属性sql_attr_multi 多值属性（MVA）：</p>

<p>sql_attr_multi = attachment #attachment可以是逗号分隔的附件ID，或者是空格、分号等sphinx都能识别<br/>
<div id="highlighter_39515"><br/>
<div><br/>
<div><a title="view source" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#viewSource">view source</a><br/>
<div></div><br/>
<a title="print" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#printSource">print</a><a title="?" href="http://www.php100.com/html/php/lei/2013/0916/6188.html#about">?</a></div><br/>
</div><br/>
<div><br/>
<div><code>01.</code><code>//设置完成记得重新建立索引</code></div><br/>
<div><code>02.</code></div><br/>
<div><code>03.</code></div><br/>
<div><code>04.</code></div><br/>
<div><code>05.</code><code>然后PHP中可以使用SetFilter()</code></div><br/>
<div><code>06.</code></div><br/>
<div><code>07.</code><code>//搜索包含附件ID为1或2邮件，mysql语法是这样FIND_IN_SET(<code>attachment</code>, &#39;1,2&#39;)</code></div><br/>
<div><code>08.</code></div><br/>
<div><code>09.</code><code>\(sphinx&lt;/code&gt;&lt;code&gt;-&amp;gt;SetFilter(&lt;/code&gt;&lt;code&gt;&#39;attachment&#39;&lt;/code&gt;&lt;code&gt;, &lt;/code&gt;&lt;code&gt;array&lt;/code&gt;&lt;code&gt;(1,2))&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;10.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;11.&lt;/code&gt;&lt;code&gt;//可以使用SetFilterRange，搜索包含附件ID在50-100范围的邮件&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;12.&lt;/code&gt;&lt;/div&gt;<br/>
&lt;div&gt;&lt;code&gt;13.&lt;/code&gt;&lt;code&gt;\)sphinx</code><code>-&gt;SetFilterRange(</code><code>&#39;attachment&#39;</code><code>, 50, 100)</code></div><br/>
</div><br/>
</div><br/>
总结<br/>
如果你想一个免费、好用、极速的全文搜索引擎，sphinx无疑是最好的选择，但是不要忘记sphinx的目的：全文检索。不要去想那些乱七八糟条件。你想要把sphinx搜索变得像mysql那样灵活，可完全单独用在一些复杂的多条件搜索，像某些邮件的高级搜索，那么我建议你还是多花点时间在PHP或者mysql代码的优化上，因为那样可能会让你的搜索变得更慢。</p>

<p>最好的方法是以最简单的方法搜索到内容，将ID交还mysql数据库搜索。</p>

    </div>
    <footer class="post-footer clearfix">
      
           
      
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  













        
      
  
    


    </body>
</html>

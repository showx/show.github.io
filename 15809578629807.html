

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    --- - shengsheng的博客
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="shengsheng的博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">---</h1>
        <p class="post-date">
                <span>Posted <time datetime="2020/02/06" itemprop="datePublished">2020/02/06</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<p>layout: post<br/>
title: 你真的了解如何将 Nginx 配置为Web服务器吗[转]<br/>
date: 2016-12-01 09:32<br/>
author: admin<br/>
comments: true</p>

<h2 id="toc_0">categories: [Uncategorized]</h2>

<p>阅读之前，建议先阅读<a href="https://lufficc.com/blog/nginx-for-beginners">初识 Nginx</a>。 之后，我们来了解一下 Nginx 配置。</p>

<p>抽象来说，将 Nginx 配置为 Web 服务器就是定义<strong>处理哪些 <code>URLS</code> </strong>和<strong>如何处理这些<code>URLS</code> 对应的请求</strong>。具体来说，就是定义一些虚拟服务器（Virtual Servers），控制具有特定 IP 和域名的请求。</p>

<p>更具体的来说， Nginx 通过定义一系列 <code>location</code>s 来控制对 <code>URIS</code> 的选择。每一个 <code>location</code>定义了对映射到自己的请求的处理场景：<strong>返回一个文件</strong>或者<strong>代理请求</strong>，或者根据不同的错误代码返回不同的错误页面。另外，根据 <code>URI</code> 的不同，请求也可以被<strong>重定向</strong>到其它 <code>server</code> 或者 <code>location</code> 。<br/>
<h2>设置虚拟服务器</h2><br/>
<h4><code>listen</code>：</h4><br/>
Nginx 配置文件至少包含一个 <code>server</code> 命令 ，用来定义虚拟服务器。当请求到来时， Nginx 会首先选择一个虚拟服务器来处理该请求。</p>

<p>虚拟服务器定义在 <code>http</code> 上下文中的 <code>server</code> 中：<br/>
<pre><code class="hljs nginx"><span class="hljs-section">http</span> {<br/>
    <span class="hljs-section">server</span> {<br/>
        <span class="hljs-comment"># Server configuration</span><br/>
    }<br/>
}</code></pre><br/>
<blockquote><em>注意： <code>http</code> 中可以定义多个 <code>server</code></em></blockquote><br/>
<code>server</code> 配置块使用 <code>listen</code> 命令监听本机 IP 和端口号（包括 Unix domain socket and path），支持 IPv4、IPv6，IPv6地址需要用方括号括起来：<br/>
<pre><code class="hljs nginx"><span class="hljs-section">server</span> {<br/>
    <span class="hljs-attribute">listen</span> <span class="hljs-number">127.0.0.1:8080</span>;  <span class="hljs-comment"># IPv4地址，8080端口</span><br/>
    <span class="hljs-comment"># listen [2001:3CA1:10F:1A:121B:0:0:10]:80;   # IPv6地址，80端口</span><br/>
    <span class="hljs-comment"># listen [::]:80;  # 听本机的所有IPv4与IPv6地址，80端口</span><br/>
    <span class="hljs-comment"># The rest of server configuration</span><br/>
}</code></pre><br/>
上述配置，如果不写端口号，默认使用80端口，如果不写 IP ，则监听本机所有 IP。<br/>
<h4><code>server_name</code>：</h4><br/>
如果多个 <code>server</code> 的 <code>listen</code> IP 和端口号一模一样， Nginx 通过请求头中的 Host <img src="https://static.lufficc.com/image/474c32008006ad74c1d7c1dcb8f152ed.png" />与 <code>server_name</code> 定义的主机名进行比较，来选择合适的虚拟服务器处理请求：<br/>
<pre><code class="hljs perl">server {<br/>
    <span class="hljs-keyword">listen</span>      <span class="hljs-number">80</span>;<br/>
    server_name lufficc.com  <a href="http://www.lufficc.com">www.lufficc.com</a>;<br/>
    ...<br/>
}</code></pre><br/>
<code>server_name</code> 的参数可以为：<br/>
<ol><br/>
    <li>完整的主机名，如：<code>api.lufficc.com</code> 。</li><br/>
    <li>含有通配符（含有 <code><em></code>），如：<code></em>.lufficc.com</code> 或 <code>api.<em></code> 。</li><br/>
    <li>正则表达式，以 <code>~</code> 开头。</li><br/>
</ol><br/>
<blockquote>通配符只能在开头或结尾，而且只能与一个 <code>.</code> 相邻。<code>www.</em>.example.org</code> 和 <code>w<em>.example.org</code> 均无效。 但是，可以使用正则表达式匹配这些名称，例如 <code>~<sup>www..+.example.org$</code></sup> 和 <code>~<sup>w.</sup></em>.example.org\(&lt;/code&gt; 。 而且 &lt;code&gt;*&lt;/code&gt; 可以匹配多个部分。 名称 &lt;code&gt;* .example.org&lt;/code&gt; 不仅匹配 &lt;code&gt;www.example.org&lt;/code&gt;，还匹配&lt;code&gt;www.sub.example.org&lt;/code&gt;。<br/>
对于正则表达式：Nginx 使用的正则表达式与 Perl 编程语言（PCRE）使用的正则表达式兼容。 要使用正则表达式，且必须以 &lt;code&gt;~&lt;/code&gt; 开头。&lt;/blockquote&gt;<br/>
命名的正则表达式可以捕获变量，然后使用：<br/>
&lt;pre&gt;&lt;code class=&quot;hljs nginx&quot;&gt;&lt;span class=&quot;hljs-section&quot;&gt;server&lt;/span&gt; {<br/>
    &lt;span class=&quot;hljs-attribute&quot;&gt;server_name&lt;/span&gt;   ~^(www\.)?(?&amp;lt;domain&amp;gt;.+)\);</p>

<pre><code class="language-text">&lt;span class=&quot;hljs-attribute&quot;&gt;location&lt;/span&gt; / {
    &lt;span class=&quot;hljs-attribute&quot;&gt;root&lt;/span&gt;   /sites/&lt;span class=&quot;hljs-variable&quot;&gt;$domain&lt;/span&gt;;
}
</code></pre>

<p>}</code></pre><br/>
小括号 <code>()</code> 之间匹配的内容，也可以在后面通过 <code>\(1&lt;/code&gt; 来引用，&lt;code&gt;\)2</code> 表示的是前面第二个 <code>()</code> 里的内容。因此上述内容也可写为：<br/>
<pre><code class="hljs nginx"><span class="hljs-section">server</span> {<br/>
    <span class="hljs-attribute">server_name</span>   ~<sup>www.</sup>?(.+)$;</p>

<pre><code class="language-text">&lt;span class=&quot;hljs-attribute&quot;&gt;location&lt;/span&gt; / {
    &lt;span class=&quot;hljs-attribute&quot;&gt;root&lt;/span&gt;   /sites/&lt;span class=&quot;hljs-variable&quot;&gt;$2&lt;/span&gt;;
}
</code></pre>

<p>}</code></pre><br/>
一个 <code>server_name</code> 示例：<br/>
<pre><code class="hljs perl">server {<br/>
    <span class="hljs-keyword">listen</span>      <span class="hljs-number">80</span>;<br/>
    server_name api.lufficc.com  <em>.lufficc.com;<br/>
    ...<br/>
}</code></pre><br/>
同样，如果多个名称匹配 <code>Host</code> 头部， Nginx 采用下列顺序选择：<br/>
<ol><br/>
    <li>完整的主机名，如 <code>api.lufficc.com</code>。</li><br/>
    <li>最长的，且以 <code></em></code> 开头的通配名，如：<code><em>.lufficc.com</code>。</li><br/>
    <li>最长的，且以 <code></em></code> 结尾的通配名，如：<code>api.<em></code> 。</li><br/>
    <li>第一个匹配的正则表达式。（按照配置文件中的顺序）</li><br/>
</ol><br/>
即优先级：<code>api.lufficc.com</code> &gt; <code></em>.lufficc.com</code> &gt; <code>api.*</code> &gt; 正则。</p>

<p>如果 <code>Host</code> 头部不匹配任何一个 <code>server_name</code> ,Nginx 将请求路由到默认虚拟服务器。默认虚拟服务器是指：<code>nginx.conf</code> 文件中第一个 <code>server</code> 或者 显式用 <code>default_server</code> 声明：<br/>
<pre><code class="hljs perl">server {<br/>
    <span class="hljs-keyword">listen</span>      <span class="hljs-number">80</span> default_server;<br/>
    ...<br/>
}</code></pre><br/>
<h2>配置 <code>location</code></h2><br/>
<h4><code>URI</code> 与 <code>location</code> 参数的匹配</h4><br/>
当选择好 <code>server</code> 之后，Nginx 会根据 <code>URI</code>s 选择合适的 <code>location</code> 来决定代理请求或者返回文件。</p>

<p><code>location</code> 指令接受两种类型的参数：<br/>
<ol><br/>
    <li>前缀字符串（路径名称）</li><br/>
    <li>正则表达式</li><br/>
</ol><br/>
对于前缀字符串参数， <code>URI</code>s 必须严格的以它开头。例如对于 <code>/some/path/</code> 参数，可以匹配 <code>/some/path/document.html</code> ，但是不匹配 <code>/my-site/some/path</code>，因为 <code>/my-site/some/path</code> 不以 <code>/some/path/</code> 开头。<br/>
<pre><code class="hljs coffeescript">location <span class="hljs-regexp">/some/path/</span> {<br/>
    ...<br/>
}</code></pre><br/>
对于正则表达式，以 <code>~</code> 开头表示大小写敏感，以 <code>~*</code> 开头表示大小写不敏感。注意路径中的 <code>.</code> 要写成 <code>.</code> 。例如一个匹配以 <code>.html</code> 或者 <code>.htm</code> 结尾的 <code>URI</code> 的 <code>location</code>：<br/>
<pre><code class="hljs">location ~ .html? {<br/>
    ...<br/>
}</code></pre><br/>
正则表达式的优先级大于前缀字符串。如果找到匹配的前缀字符串，仍继续搜索正则表达式，但如果前缀字符串以 <code><sup>~</code></sup> 开头，则不再检查正则表达式。</p>

<p>具体的搜索匹配流程如下：<br/>
<ol><br/>
    <li>将 <code>URI</code> 与所有的前缀字符串进行比较。</li><br/>
    <li><code>=</code> 修饰符表明 <code>URI</code> 必须与前缀字符串相等（不是开始，而是相等），如果找到，则搜索停止。</li><br/>
    <li>如果找到的最长前缀匹配字符串以 <code><sup>~</code></sup> 开头，则不再搜索正则表达式是否匹配。</li><br/>
    <li>存储匹配的最长前缀字符串。</li><br/>
    <li>测试对比 <code>URI</code> 与正则表达式。</li><br/>
    <li>找到第一个匹配的正则表达式后停止。</li><br/>
    <li>如果没有正则表达式匹配，使用 4 存储的前缀字符串对应的 <code>location</code>。</li><br/>
</ol><br/>
<code>=</code> 修饰符拥有最高的优先级。如网站首页访问频繁，我们可以专门定义一个 <code>location</code> 来减少搜索匹配次数（因为搜索到 <code>=</code> 修饰的匹配的 <code>location</code> 将停止搜索），提高速度：<br/>
<pre><code class="hljs makefile">location = / {<br/>
    ...<br/>
}</code></pre><br/>
<h4>静态文件和代理</h4><br/>
<code>location</code> 也定义了如何处理匹配的请求：<strong>返回静态文件</strong> 或者 <strong>交给代理服务器处理</strong>。下面的例子中，第一个 <code>location</code> 返回 <code>/data</code> 目录中的静态文件，第二个 <code>location</code> 则将请求传递给 <a href="https://lufficc.com/"><a href="https://lufficc.com">https://lufficc.com</a></a> 域名的服务器处理：<br/>
<pre><code class="hljs nginx"><span class="hljs-section">server</span> {<br/>
    <span class="hljs-attribute">location</span> /images/ {<br/>
        <span class="hljs-attribute">root</span> /data;<br/>
    }</p>

<pre><code class="language-text">&lt;span class=&quot;hljs-attribute&quot;&gt;location&lt;/span&gt; / {
    &lt;span class=&quot;hljs-attribute&quot;&gt;proxy_pass&lt;/span&gt; https://lufficc.com;
}
</code></pre>

<p>}</code></pre><br/>
<code>root</code> 指令定义了静态文件的根目录，并且和 <code>URI</code> 拼接形成最终的本地文件路径。如请求 <code>/images/example.png</code>，则拼接后返回本地服务器文件 <code>/data/images/example.png</code> 。</p>

<p><code>proxy_pass</code> 指令将请求传递到 URL 指向的代理服务器。让后将来自代理服务器的响应转发给客户端。 在上面的示例中，所有不以 <code>/images /</code> 开头的 <code>URI</code> 的请求都将传递给代理服务器处理。</p>

<p>比如我把 <code>proxy_pass</code> 设置为 <code><a href="https://www.baidu.com/">https://www.baidu.com/</a></code>，那么访问 <a href="http://search.lufficc.com/"><a href="http://search.lufficc.com/">http://search.lufficc.com/</a></a>将得到百度首页一样的响应（页面）（感兴趣的童鞋可以自己试一试搜索功能，和百度没差别呢）：<br/>
<pre><code class="hljs cpp">server{<br/>
      listen <span class="hljs-number">80</span>;<br/>
      server_name search.lufficc.com;<br/>
      location / {<br/>
              proxy_pass https:<span class="hljs-comment">//<a href="http://www.baidu.com">www.baidu.com</a>;</span><br/>
      }<br/>
}</code></pre><br/>
<h2>使用变量（Variables）</h2><br/>
你可以使用变量来使 Nginx 在不同的请求下采用不同的处理方式。变量是在运行时计算的，用作指令的参数。 变量由 <code>$</code> 开头的符号表示。 变量基于 Nginx 的状态定义信息，例如当前处理的请求的属性。</p>

<p>有很多预定义变量，例如核心的 HTTP 变量，你也可以使用 <code>set</code>，<code>map</code> 和 <code>geo</code> 指令定义自定义变量。 大多数变量在运行时计算，并包含与特定请求相关的信息。 例如，<code>\(remote_addr&lt;/code&gt; 包含客户端 IP 地址，&lt;code&gt;\)uri</code> 保存当前URI值。</p>

<p>一些常用的变量如下：<br/>
<table class="table table-bordered table-responsive"><br/>
<thead><br/>
<tr><br/>
<th>变量名称</th><br/>
<th>作用</th><br/>
</tr><br/>
</thead><br/>
<tbody><br/>
<tr><br/>
<td><code>\(uri&lt;/code&gt;&lt;/td&gt;<br/>
&lt;td&gt;请求中的当前URI(不带请求参数)，它可以通过内部重定向，或者使用index指令进行修改，&lt;code&gt;\)uri</code>不包含主机名,如 <code>/foo/bar.html</code>。</td><br/>
</tr><br/>
<tr><br/>
<td><code>\(arg_name&lt;/code&gt;&lt;/td&gt;<br/>
&lt;td&gt;请求中的的参数名，即“?”后面的&lt;code&gt;arg_name=arg_value&lt;/code&gt;形式的&lt;code&gt;arg_name&lt;/code&gt;&lt;/td&gt;<br/>
&lt;/tr&gt;<br/>
&lt;tr&gt;<br/>
&lt;td&gt;&lt;code&gt;\)hostname</code></td><br/>
<td>主机名</td><br/>
</tr><br/>
<tr><br/>
<td><code>\(args&lt;/code&gt;&lt;/td&gt;<br/>
&lt;td&gt;请求中的参数值&lt;/td&gt;<br/>
&lt;/tr&gt;<br/>
&lt;tr&gt;<br/>
&lt;td&gt;&lt;code&gt;\)query_string</code></td><br/>
<td>同 <code>\(args&lt;/code&gt;&lt;/td&gt;<br/>
&lt;/tr&gt;<br/>
&lt;tr&gt;<br/>
&lt;td&gt;&lt;code&gt;\)request</code></td><br/>
<td>代表客户端的请求地址</td><br/>
</tr><br/>
<tr><br/>
<td><code>\(request_uri&lt;/code&gt;&lt;/td&gt;<br/>
&lt;td&gt;这个变量等于包含一些客户端请求参数的原始URI，它无法修改，不包含主机名，如：&lt;code&gt;/cnphp/test.php?arg=freemouse&lt;/code&gt;。&lt;/td&gt;<br/>
&lt;/tr&gt;<br/>
&lt;tr&gt;<br/>
&lt;td&gt;...&lt;/td&gt;<br/>
&lt;td&gt;...&lt;/td&gt;<br/>
&lt;/tr&gt;<br/>
&lt;/tbody&gt;<br/>
&lt;/table&gt;<br/>
一个简单的应用就是从 &lt;code&gt;http&lt;/code&gt; 重定向到 &lt;code&gt;https&lt;/code&gt; 时带上路径信息：<br/>
&lt;pre&gt;&lt;code class=&quot;hljs bash&quot;&gt;server{<br/>
       ...<br/>
       &lt;span class=&quot;hljs-built_in&quot;&gt;return&lt;/span&gt;      301 https://lufficc.com&lt;span class=&quot;hljs-variable&quot;&gt;\)request_uri</span>;<br/>
       ...<br/>
}</code></pre><br/>
<h2>返回特定状态码</h2><br/>
如果你的网站上的一些资源永久移除了，最快最简洁的方法就是使用 <code>return</code> 指令直接返回：<br/>
<pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /wrong/url {<br/>
    <span class="hljs-attribute">return</span> <span class="hljs-number">404</span>;<br/>
}</code></pre><br/>
<code>return</code> 的第一个参数是响应代码。可选的第二个参数可以是重定向（对应于代码301，302，303和307）的 URL 或在响应正文中返回的文本。 例如：<br/>
<pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /permanently/moved/url {<br/>
    <span class="hljs-attribute">return</span> <span class="hljs-number">301</span> <a href="http://www.example.com/moved/here">http://www.example.com/moved/here</a>;<br/>
}</code></pre><br/>
<code>return</code> 指令可以包含在 <code>location</code> 和 <code>server</code> 上下文中：<br/>
<pre><code class="hljs bash">server{<br/>
      location / {<br/>
              <span class="hljs-built_in">return</span> 404;<br/>
      }<br/>
}</code></pre><br/>
或者：<br/>
<pre><code class="hljs bash">server{<br/>
      ...<br/>
      <span class="hljs-built_in">return</span> 404;<br/>
      location / {<br/>
          ...<br/><br/>
      }<br/>
}</code></pre><br/>
<h2>错误处理</h2><br/>
<code>error_page</code> 命令可以配置特定错误码的错误页面，或者重定向到其他的页面。下面的示例将在 404 错误发生时返回 <code>/404.html</code> 页面。<br/>
<pre><code class="hljs nginx"><span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /<span class="hljs-number">404</span>.html;</code></pre><br/>
<code>error_page</code> 命令定义了如何处理错误，因此不会直接返回，而 <code>return</code> 确实会立即返回。当代理服务器或者 Nginx 处理时产生相应的错误的代码，均会返回相应的错误页面。</p>

<p>在下面的示例中，当 Nginx 找不到页面时，它将使用代码301替换代码404，并将客户端重定向到 <code><a href="http://example.com/new/path.html">http://example.com/new/path.html</a></code> 。 此配置很有用，比如当客户端仍尝试用旧的 <code>URI</code> 访问页面时，301代码通知浏览器页面已永久移除，并且需要自动替换为返回的新地址。<br/>
<pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /old/path.html {<br/>
    <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> =<span class="hljs-number">301</span> http:/example.com/new/path.html;<br/>
}</code></pre><br/>
<h2>重写 <code>URI</code>s</h2><br/>
<code>rewrite</code> 指令可以多次修改请求的 <code>URI</code>。<code>rewrite</code> 的第一个参数是 <code>URI</code>需要匹配的正则表达式，第二个参数是将要替换的 <code>URI</code>。第三个参数可选，指示是否继续可以重写或者返回重定向代码（301或302）。例如：<br/>
<pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /users/ {<br/>
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> <sup>/users/(.*)$</span></sup> /show?user=<span class="hljs-variable">$1</span> <span class="hljs-literal">break</span>;<br/>
}</code></pre><br/>
您可以在 <code>server</code> 和 <code>location</code> 上下文中包括多个 <code>rewrite</code> 指令。 <code>Nginx</code> 按照它们发生的顺序一个一个地执行指令。 当选择 <code>server</code> 时，<code>server</code> 中的 <code>rewrite</code> 指令将执行一次。</p>

<p>在 <code>Nginx</code> 处理一组 <code>rewrite</code> 指令之后，它根据新的 <code>URI</code> 选择 <code>location</code> 。 如果所选 <code>location</code> 仍旧包含 <code>rewrite</code> 指令，它们将依次执行。 如果 <code>URI</code> 匹配所有，则在处理完所有定义的 <code>rewrite</code> 指令后，搜索新的 <code>location</code> 。</p>

<p>以下示例将 <code>rewrite</code> 指令与 <code>return</code> 指令结合使用：<br/>
<pre><code class="hljs ruby">server {<br/>
    ...<br/>
    rewrite <sup><span class="hljs-regexp">/download/</span>.*</sup>/media/(.<em>)..</em>\( \)1/mp3/\(2.mp3 last;<br/>
    rewrite ^(&lt;span class=&quot;hljs-regexp&quot;&gt;/download/&lt;/span&gt;.*)/audio/(.*)\..*\) \(1/mp3/\)2.ra  last;<br/>
    <span class="hljs-keyword">return</span>  <span class="hljs-number">403</span>;<br/>
    ...<br/>
}</code></pre><br/>
诸如 <code>/download/some/media/file</code> 的 URI 被改为 <code>/download/some/mp3/file.mp3</code> 。 由于 <code>last</code> 标志，后续指令（第二个 <code>rewrite</code> 指令和 <code>return</code> 指令）被跳过，但 Nginx 继续以更改后的 URI 处理请求。 类似地，诸如 <code>/download/some/audio/file</code> 的 URI 被替换为 <code>/download/some/mp3/file.ra</code>。 如果 URI 不匹配 <code>rewrite</code> 指令，Nginx 将403 错误代码返回给客户端。</p>

<p><code>last</code> 与 <code>break</code>的区别是：<br/>
<ul><br/>
    <li><code>last</code> ： 在当前 <code>server</code> 或 <code>location</code> 上下文中停止执行 <code>rewrite</code> 指令，但是 Nginx 继续搜索与重写的URI匹配的 <code>location</code>，并应用新 <code>location</code> 中的任何 <code>rewrite</code> 指令（这意味着 URI 可能再次改变）。</li><br/>
    <li><code>break</code> ：停止当前上下文中 <code>rewrite</code> 指令的处理，并取消搜索与新 URI 匹配的 <code>location</code>。 不会执行新 <code>location</code>中的 <code>rewrite</code> 指令。</li><br/>
</ul><br/>
<h2>附录</h2><br/>
<h4>常用正则</h4><br/>
<ul><br/>
    <li><code>.</code> ： 匹配除换行符以外的任意字符</li><br/>
    <li><code>?</code> ： 重复0次或1次</li><br/>
    <li><code>+</code> ： 重复1次或更多次</li><br/>
    <li><code>*</code>： 重复0次或更多次</li><br/>
    <li><code>\d</code> ：匹配数字</li><br/>
    <li><code><sup></code></sup> ： 匹配字符串的开始</li><br/>
    <li><code>\(&lt;/code&gt; ： 匹配字符串的介绍&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;{n}&lt;/code&gt; ： 重复n次&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;{n,}&lt;/code&gt; ： 重复n次或更多次&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;[c]&lt;/code&gt; ： 匹配单个字符c&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;[a-z]&lt;/code&gt;： 匹配a-z小写字母的任意一个&lt;/li&gt;<br/>
&lt;/ul&gt;<br/>
&lt;h4&gt;全局变量&lt;/h4&gt;<br/>
&lt;ul&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)args</code> ： #这个变量等于请求行中的参数，同<code>\(query_string&lt;/code&gt;&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)content_length</code> ： 请求头中的Content-length字段。</li><br/>
    <li><code>\(content_type&lt;/code&gt; ： 请求头中的Content-Type字段。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)document_root</code> ： 当前请求在root指令中指定的值。</li><br/>
    <li><code>\(host&lt;/code&gt; ： 请求主机头字段，否则为服务器名称。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)http_user_agent</code> ： 客户端agent信息</li><br/>
    <li><code>\(http_cookie&lt;/code&gt; ： 客户端cookie信息&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)limit_rate</code> ： 这个变量可以限制连接速率。</li><br/>
    <li><code>\(request_method&lt;/code&gt; ： 客户端请求的动作，通常为GET或POST。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)remote_addr</code> ： 客户端的IP地址。</li><br/>
    <li><code>\(remote_port&lt;/code&gt; ： 客户端的端口。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)remote_user</code> ： 已经经过Auth Basic Module验证的用户名。</li><br/>
    <li><code>\(request_filename&lt;/code&gt; ： 当前请求的文件路径，由root或alias指令与URI请求生成。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)scheme</code> ： HTTP方法（如http，https）。</li><br/>
    <li><code>\(server_protocol&lt;/code&gt; ： 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)server_addr</code> ： 服务器地址，在完成一次系统调用后可以确定这个值。</li><br/>
    <li><code>\(server_name&lt;/code&gt; ： 服务器名称。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)server_port</code> ： 请求到达服务器的端口号。</li><br/>
    <li><code>\(request_uri&lt;/code&gt; ： 包含请求参数的原始URI，不包含主机名，如：&lt;code&gt;/foo/bar.php?arg=baz&lt;/code&gt;。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)uri</code> ： 不带请求参数的当前URI，\(uri不包含主机名，如&lt;code&gt;/foo/bar.html&lt;/code&gt;。&lt;/li&gt;<br/>
    &lt;li&gt;&lt;code&gt;\)document_uri</code> ： 与\(uri相同。&lt;/li&gt;<br/>
&lt;/ul&gt;<br/>
例如请求：&lt;code&gt;http://localhost:88/test1/test2/test.php&lt;/code&gt;<br/>
&lt;code&gt;\)host</code>：localhost<br/>
<code>\(server_port&lt;/code&gt;：88<br/>
&lt;code&gt;\)request_uri</code>：<a href="http://localhost:88/test1/test2/test.php"><a href="http://localhost:88/test1/test2/test.php">http://localhost:88/test1/test2/test.php</a></a><br/>
<code>\(document_uri&lt;/code&gt;：/test1/test2/test.php<br/>
&lt;code&gt;\)document_root</code>：/var/www/html<br/>
<code>$request_filename</code>：/var/www/html/test1/test2/test.php<br/>
<h2>参考</h2><br/>
<ol><br/>
    <li><a href="https://www.nginx.com/resources/admin-guide/nginx-web-server/"><a href="https://www.nginx.com/resources/admin-guide/nginx-web-server/">https://www.nginx.com/resources/admin-guide/nginx-web-server/</a></a></li><br/>
    <li><a href="http://seanlook.com/2015/05/17/nginx-location-rewrite/"><a href="http://seanlook.com/2015/05/17/nginx-location-rewrite/">http://seanlook.com/2015/05/17/nginx-location-rewrite/</a></a></li><br/>
</ol></p>

    </div>
    <footer class="post-footer clearfix">
      
           
      
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  













<script src="asset/prism.js"></script>

        
      
  
    


    </body>
</html>

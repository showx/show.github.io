

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    --- - shengsheng的博客
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="shengsheng的博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">---</h1>
        <p class="post-date">
                <span>Posted <time datetime="2020/02/06" itemprop="datePublished">2020/02/06</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<p>layout: post<br/>
title: Ajax跨域、Json跨域、Socket跨域和Canvas跨域等同源策略限制的解决方法<br/>
date: 2015-06-12 13:40<br/>
author: admin<br/>
comments: true</p>

<h2 id="toc_0">categories: []</h2>

<p>同源是指相同的协议、域名、端口，三者都相同才属于同域。不符合上述定义的请求，则称为跨域。</p>

<p>相信每个开发人员都曾遇到过跨域请求的情况，虽然情况不一样，但问题的本质都可以归为浏览器出于安全考虑下的同源策略的限制。</p>

<p>跨域的情形有很多，最常见的有Ajax跨域、Socket跨域和Canvas跨域。下面列举一些我们常见的跨域情形下，某些浏览器控制台给出的错误提示：</p>

<p>FireFox下的提示：</p>

<p>已阻止交叉源请求：同源策略不允许读取***上的远程资源。可以将资源移动到相同的域名上或者启用 CORS 来解决这个问题。</p>

<p>Canvas跨域Chrome下的提示：</p>

<p>Uncaught SecurityError : Failed to execute &#39;getImageData&#39; on &#39;CanvasRenderingContext2D&#39; : The canvas has been tainted by cross-origin data.</p>

<p>或：</p>

<p>Imagefrom origin &#39;<a href="http://js.xx.com">http://js.xx.com</a>&#39; has been blocked from loading by Cross-OriginResource Sharing policy: No &#39;Access-Control-Allow-Origin&#39; header is present onthe requested resource. Origin &#39;<a href="http://act.xx.com">http://act.xx.com</a>&#39; is therefore not allowedaccess.</p>

<p>网上有许多解决跨域的方法，大体上有这几种：</p>

<p>1）document.domain+iframe的设置</p>

<p>2）动态创建script</p>

<p>3）利用iframe和location.hash</p>

<p>4）window.name实现的跨域数据传输</p>

<p>5）使用HTML5 postMessage</p>

<p>6）利用flash</p>

<p>7）通过代理，js访问代理，代理转到不同的域</p>

<p><a href="http://developer.yahoo.com/javascript/howto-proxy.html">http://developer.yahoo.com/javascript/howto-proxy.html</a></p>

<p>8）Jquery JSONP(不能成为真正的Ajax，本质上仍是动态创建script)</p>

<p><a href="http://www.cnblogs.com/chopper/archive/2012/03/24/2403945.html">http://www.cnblogs.com/chopper/archive/2012/03/24/2403945.html</a></p>

<p>9）跨域资源共享（CORS） 这是HTML5跨域问题的标准解决方案</p>

<p>说明：方案1~方案6见Rain Man所写的文章《JavaScript跨域总结与解决办法》</p>

<p><a href="http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html">http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html</a></p>

<p>下面主要就我总结的几种解决跨域的方法，展开说一下。</p>

<p>1）  绕开跨域。</p>

<p>适用情形是：动静分离。</p>

<p>example1.com域名下的页面中跨域请求是以JavaScript内联方式实现的，而请求的目标静态资源是放在example2.com 域名下，这时可以将执行跨域请求的JavaScript代码块独立出来，放到example2.com上，而example1.com页面通过外联方式引 入该静态域名下的js文件。这样，js与请求的图片等资源都在example2.com下，即可正常访问到。这种方法其实是一种巧妙避开跨域的方法。</p>

<p>2）  后台抓取克隆图片。</p>

<p>适用情形：动静不分离（两个域名均运行访问静态资源）。</p>

<p>example1.com请求example2.com下的资源图片，可以使用PHP抓取图片并在example2.com下生成一份，这样就可以间接访问到example1.com的静态资源。</p>

<p>html模板示例代码：</p>

<p>$(&quot;#scratchpad&quot;).wScratchPad({     //刮刮卡示例，当前域名<a href="http://act.xxx.com">http://act.xxx.com</a></p>

<p>width:283,</p>

<p>height:154,</p>

<p>//color: &quot;#a9a9a7&quot;,</p>

<p>image2:&quot;imgdata.php?url=<a href="http://js.xxx.com/static/activity/sq/guagua315/images/card_inner.jpg">http://js.xxx.com/static/activity/sq/guagua315/images/card_inner.jpg</a>&quot;,</p>

<p>scratchMove:function() {</p>

<p>}</p>

<p>});</p>

<p>或：</p>

<p>xi= new XMLHttpRequest ();</p>

<p>xi.open( &quot;GET&quot; , &quot;imgdata.php?url=&quot; +yourImageURL, true );</p>

<p>xi.send();</p>

<p>xi.onreadystatechange= function () {</p>

<p>if (xi.readyState== 4 &amp;&amp; xi.status== 200 ) {</p>

<p>img= new Image ;</p>

<p>img.onload= function (){</p>

<p>ctx.drawImage(img, 0 , 0 , canvas.width, canvas.height);</p>

<p>}</p>

<p>img.src=xi.responseText;</p>

<p>}</p>

<p>}</p>

<p>PHP处理代码：</p>

<p>&lt;?php //imgdata.php</p>

<p>\(url=\)_GET[ &#39;url&#39; ];</p>

<p>\(img =file_get_contents(\)url);</p>

<p>\(imgname = substr(strrchr(\)url, &quot;/&quot; ), 1 );</p>

<p>file_put_contents(\(fn,\)img);</p>

<p>echo $imgname;</p>

<p>?&gt;</p>

<p>上述代码在当前php目录下生成了克隆生成了一张图片。</p>

<p>3）  后台程序设置Access-Control-Allow-Origin</p>

<p>适用情形：Ajax获取跨域接口的JSON数据。</p>

<p>example1.com请求example2.com的数据接口，则需要在example2.com的数据接口添加跨域访问授权。</p>

<p>PHP程序中开始出添加 header (&#39;HeaderName: Header Value&#39;); 这样的header标记：</p>

<p>header(&#39;Access-Control-Allow-Origin:*&#39;);</p>

<p>4）修改服务器配置启用CORS</p>

<p>适用情形：跨域访问静态资源。</p>

<p>Access-Control-Allow-Origin是什么作用呢？用于授权资源的跨站访问。比如,静态资源图片都放在 example2.com 域名下, 如果在返回的头中没有设置 Access-Control-Allow-Origin , 那么别的域是没有权限外链你的图片的。</p>

<p>要实现CORS跨域，服务端需要这个一个流程，图片引自 html5rocks ，附图如下</p>

<p>a.      对于简单请求，如GET，只需要在HTTP Response后添加Access-Control-Allow-Origin。</p>

<p>b.      对于非简单请求，比如POST、PUT、DELETE等，浏览器会分两次应答。第一次preflight（method: OPTIONS），主要验证来源是否合法，并返回允许的Header等。第二次才是真正的HTTP应答。所以服务器必须处理OPTIONS应答。</p>

<p>这里是一个nginx启用CORS的参考配置示例 <a href="http://enable-cors.org/server_nginx.html">http://enable-cors.org/server_nginx.html</a> 。代码：</p>

<h1 id="toc_1">A CORS (Cross-Origin Resouce Sharing) config for nginx</h1>

<h1 id="toc_2">== Purpose</h1>

<h1 id="toc_3">This nginx configuration enables CORS requests in the following way:</h1>

<h1 id="toc_4">- enables CORS just for origins on a whitelist specified by a regular expression</h1>

<h1 id="toc_5">- CORS preflight request (OPTIONS) are responded immediately</h1>

<h1 id="toc_6">- Access-Control-Allow-Credentials=true for GET and POST requests</h1>

<h1 id="toc_7">- Access-Control-Max-Age=20days, to minimize repetitive OPTIONS requests</h1>

<h1 id="toc_8">- various superluous settings to accommodate nonconformant browsers</h1>

<h1 id="toc_9">== Comment on echoing Access-Control-Allow-Origin</h1>

<h1 id="toc_10">How do you allow CORS requests only from certain domains? The last</h1>

<h1 id="toc_11">published W3C candidate recommendation states that the</h1>

<h1 id="toc_12">Access-Control-Allow-Origin header can include a list of origins.</h1>

<h1 id="toc_13">(See: <a href="http://www.w3.org/TR/2013/CR-cors-20130129/#access-control-allow-origin-response-header">http://www.w3.org/TR/2013/CR-cors-20130129/#access-control-allow-origin-response-header</a> )</h1>

<h1 id="toc_14">However, browsers do not support this well and it likely will be</h1>

<h1 id="toc_15">dropped from the spec (see, <a href="http://www.rfc-editor.org/errata_search.php?rfc=6454&amp;eid=3249">http://www.rfc-editor.org/errata_search.php?rfc=6454&amp;eid=3249</a> ).</h1>

<h1 id="toc_16">The usual workaround is for the server to keep a whitelist of</h1>

<h1 id="toc_17">acceptable origins (as a regular expression), match the request&#39;s</h1>

<h1 id="toc_18">Origin header against the list, and echo back the matched value.</h1>

<h1 id="toc_19">(Yes you can use &#39;*&#39; to accept all origins but this is too open and</h1>

<h1 id="toc_20">prevents using &#39;Access-Control-Allow-Credentials: true&#39;, which is</h1>

<h1 id="toc_21">needed for HTTP Basic Access authentication.)</h1>

<h1 id="toc_22">== Comment on  spec</h1>

<h1 id="toc_23">Comments below are all based on my reading of the CORS spec as of</h1>

<h1 id="toc_24">2013-Jan-29 ( <a href="http://www.w3.org/TR/2013/CR-cors-20130129/">http://www.w3.org/TR/2013/CR-cors-20130129/</a> ), the</h1>

<h1 id="toc_25">XMLHttpRequest spec (</h1>

<h1 id="toc_26"><a href="http://www.w3.org/TR/2012/WD-XMLHttpRequest-20121206/">http://www.w3.org/TR/2012/WD-XMLHttpRequest-20121206/</a> ), and</h1>

<h1 id="toc_27">experimentation with latest versions of Firefox, Chrome, Safari at</h1>

<h1 id="toc_28">that point in time.</h1>

<h1 id="toc_29">== Changelog</h1>

<h1 id="toc_30">shared at: <a href="https://gist.github.com/algal/5480916">https://gist.github.com/algal/5480916</a></h1>

<h1 id="toc_31">based on: <a href="https://gist.github.com/alexjs/4165271">https://gist.github.com/alexjs/4165271</a></h1>

<p>location / {<br/>
    # if the request included an Origin: header with an origin on the whitelist,<br/>
    # then it is some kind of CORS request.<br/>
    # specifically, this example allow CORS requests from<br/>
    #  scheme    : http or https<br/>
    #  authority : any authority ending in &quot;.mckinsey.com&quot;<br/>
    #  port      : nothing, or :<br/>
    if (\(http_origin ~* (https?://[^/]*\.mckinsey\.com(:[0-9]+)?)\)) {<br/>
  set \(cors &quot;true&quot;;<br/>
    }<br/>
    # Nginx doesn&#39;t support nested If statements, so we use string<br/>
    # concatenation to create a flag for compound conditions<br/>
    # OPTIONS indicates a CORS pre-flight request<br/>
    if (\)request_method = &#39;OPTIONS&#39;) {<br/>
  set \(cors &quot;\){cors}options&quot;;<br/><br/>
    }<br/>
    # non-OPTIONS indicates a normal CORS request<br/>
    if (\(request_method = &#39;GET&#39;) {<br/>
  set \)cors &quot;\({cors}get&quot;;  <br/>
    }<br/>
    if (\)request_method = &#39;POST&#39;) {<br/>
  set \(cors &quot;\){cors}post&quot;;<br/>
    }<br/>
    # if it&#39;s a GET or POST, set the standard CORS responses header<br/>
    if (\(cors = &quot;trueget&quot;) {<br/>
  # Tells the browser this origin may make cross-origin requests<br/>
  # (Here, we echo the requesting origin, which matched the whitelist.)<br/>
  add_header &#39;Access-Control-Allow-Origin&#39; &quot;\)http_origin&quot;;<br/>
  # Tells the browser it may show the response, when XmlHttpRequest.withCredentials=true.<br/>
  add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;<br/>
  # # Tell the browser which response headers the JS can see, besides the &quot;simple response headers&quot;<br/>
  # add_header &#39;Access-Control-Expose-Headers&#39; &#39;myresponseheader&#39;;<br/>
    }<br/>
    if (\(cors = &quot;truepost&quot;) {<br/>
  # Tells the browser this origin may make cross-origin requests<br/>
  # (Here, we echo the requesting origin, which matched the whitelist.)<br/>
  add_header &#39;Access-Control-Allow-Origin&#39; &quot;\)http_origin&quot;;<br/>
  # Tells the browser it may show the response, when XmlHttpRequest.withCredentials=true.<br/>
  add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;<br/>
  # # Tell the browser which response headers the JS can see, besides the &quot;simple response headers&quot;<br/>
  # add_header &#39;Access-Control-Expose-Headers&#39; &#39;myresponseheader&#39;;<br/>
    }<br/>
    # if it&#39;s OPTIONS, then it&#39;s a CORS preflight request so respond immediately with no response body<br/>
    if (\(cors = &quot;trueoptions&quot;) {<br/>
  # Tells the browser this origin may make cross-origin requests<br/>
  # (Here, we echo the requesting origin, which matched the whitelist.)<br/>
  add_header &#39;Access-Control-Allow-Origin&#39; &quot;\)http_origin&quot;;<br/>
  # in a preflight response, tells browser the subsequent actual request can include user credentials (e.g., cookies)<br/>
  add_header &#39;Access-Control-Allow-Credentials&#39; &#39;true&#39;;<br/>
  #<br/>
  # Return special preflight info<br/>
  #<br/>
  # Tell browser to cache this pre-flight info for 20 days<br/>
  add_header &#39;Access-Control-Max-Age&#39; 1728000;<br/>
  # Tell browser we respond to GET,POST,OPTIONS in normal CORS requests.<br/>
  #<br/>
  # Not officially needed but still included to help non-conforming browsers.<br/>
  #<br/>
  # OPTIONS should not be needed here, since the field is used<br/>
  # to indicate methods allowed for &quot;actual request&quot; not the<br/>
  # preflight request.<br/>
  #<br/>
  # GET,POST also should not be needed, since the &quot;simple<br/>
  # methods&quot; GET,POST,HEAD are included by default.<br/>
  #<br/>
  # We should only need this header for non-simple requests<br/>
  # methods (e.g., DELETE), or custom request methods (e.g., XMODIFY)<br/>
  add_header &#39;Access-Control-Allow-Methods&#39; &#39;GET, POST, OPTIONS&#39;;<br/>
  # Tell browser we accept these headers in the actual request<br/>
  #<br/>
  # A dynamic, wide-open config would just echo back all the headers<br/>
  # listed in the preflight request&#39;s<br/>
  # Access-Control-Request-Headers.<br/>
  #<br/>
  # A dynamic, restrictive config, would just echo back the<br/>
  # subset of Access-Control-Request-Headers headers which are<br/>
  # allowed for this resource.<br/>
  #<br/>
  # This static, fairly open config just returns a hardcoded set of<br/>
  # headers that covers many cases, including some headers that<br/>
  # are officially unnecessary but actually needed to support<br/>
  # non-conforming browsers<br/>
  # <br/>
  # Comment on some particular headers below:<br/>
  #<br/>
  # Authorization -- practically and officially needed to support<br/>
  # requests using HTTP Basic Access authentication. Browser JS<br/>
  # can use HTTP BA authentication with an XmlHttpRequest object<br/>
  # req by calling<br/>
  # <br/>
  #   req.withCredentials=true,  and<br/>
  #   req.setRequestHeader(&#39;Authorization&#39;,&#39;Basic &#39; + window.btoa(theusername + &#39;:&#39; + thepassword))<br/>
  #<br/>
  # Counterintuitively, the username and password fields on<br/>
  # XmlHttpRequest#open cannot be used to set the authorization<br/>
  # field automatically for CORS requests.<br/>
  #<br/>
  # Content-Type -- this is a &quot;simple header&quot; only when it&#39;s<br/>
  # value is either application/x-www-form-urlencoded,<br/>
  # multipart/form-data, or text/plain; and in that case it does<br/>
  # not officially need to be included. But, if your browser<br/>
  # code sets the content type as application/json, for example,<br/>
  # then that makes the header non-simple, and then your server<br/>
  # must declare that it allows the Content-Type header.<br/>
  # <br/>
  # Accept,Accept-Language,Content-Language -- these are the<br/>
  # &quot;simple headers&quot; and they are officially never<br/>
  # required. Practically, possibly required.<br/>
  #<br/>
  # Origin -- logically, should not need to be explicitly<br/>
  # required, since it&#39;s implicitly required by all of<br/>
  # CORS. officially, it is unclear if it is required or<br/>
  # forbidden! practically, probably required by existing<br/>
  # browsers (Gecko does not request it but WebKit does, so<br/>
  # WebKit might choke if it&#39;s not returned back).<br/>
  #<br/>
  # User-Agent,DNT -- officially, should not be required, as<br/>
  # they cannot be set as &quot;author request headers&quot;. practically,<br/>
  # may be required.<br/>
  # <br/>
  # My Comment:<br/>
  #<br/>
  # The specs are contradictory, or else just confusing to me,<br/>
  # in how they describe certain headers as required by CORS but<br/>
  # forbidden by XmlHttpRequest. The CORS spec says the browser<br/>
  # is supposed to set Access-Control-Request-Headers to include<br/>
  # only &quot;author request headers&quot; (section 7.1.5). And then the<br/>
  # server is supposed to use Access-Control-Allow-Headers to<br/>
  # echo back the subset of those which is allowed, telling the<br/>
  # browser that it should not continue and perform the actual<br/>
  # request if it includes additional headers (section 7.1.5,<br/>
  # step 8). So this implies the browser client code must take<br/>
  # care to include all necessary headers as author request<br/>
  # headers.<br/>
  # <br/>
  # However, the spec for XmlHttpRequest#setRequestHeader<br/>
  # (section 4.6.2) provides a long list of headers which the<br/>
  # the browser client code is forbidden to set, including for<br/>
  # instance Origin, DNT (do not track), User-Agent, etc.. This<br/>
  # is understandable: these are all headers that we want the<br/>
  # browser itself to control, so that malicious browser client<br/>
  # code cannot spoof them and for instance pretend to be from a<br/>
  # different origin, etc..<br/>
  #<br/>
  # But if XmlHttpRequest forbids the browser client code from<br/>
  # setting these (as per the XmlHttpRequest spec), then they<br/>
  # are not author request headers. And if they are not author<br/>
  # request headers, then the browser should not include them in<br/>
  # the preflight request&#39;s Access-Control-Request-Headers. And<br/>
  # if they are not included in Access-Control-Request-Headers,<br/>
  # then they should not be echoed by<br/>
  # Access-Control-Allow-Headers. And if they are not echoed by<br/>
  # Access-Control-Allow-Headers, then the browser should not<br/>
  # continue and execute actual request. So this seems to imply<br/>
  # that the CORS and XmlHttpRequest specs forbid certain<br/>
  # widely-used fields in CORS requests, including the Origin<br/>
  # field, which they also require for CORS requests.<br/>
  #<br/>
  # The bottom line: it seems there are headers needed for the<br/>
  # web and CORS to work, which at the moment you should<br/>
  # hard-code into Access-Control-Allow-Headers, although<br/>
  # official specs imply this should not be necessary.<br/>
  # <br/>
  add_header &#39;Access-Control-Allow-Headers&#39; &#39;Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since&#39;;<br/>
  # build entire response to the preflight request<br/>
  # no body in this response<br/>
  add_header &#39;Content-Length&#39; 0;<br/>
  # (should not be necessary, but included for non-conforming browsers)<br/>
  add_header &#39;Content-Type&#39; &#39;text/plain charset=UTF-8&#39;;<br/>
  # indicate successful return with no content<br/>
  return 204;<br/>
    }<br/>
    # --PUT YOUR REGULAR NGINX CODE HERE--<br/>
}<br/>
服务器解析流程如下：</p>

<p>a.首先查看http头部有无origin字段；</p>

<p>b.如果没有，或者不允许，直接当成普通请求处理，结束；</p>

<p>c.如果有并且是允许的，那么再看是否是preflight(method=OPTIONS)；</p>

<p>d.如果是preflight，就返回Allow-Headers、Allow-Methods等，内容为空；</p>

<p>e.如果不是preflight，就返回Allow-Origin、Allow-Credentials等，并返回正常内容。</p>

<p>若服务器为nginx，可以 在 nginx 的 conf 文件中加入以下内容：</p>

<p>location / {<br/>
  add_header Access-Control-Allow-Origin *;<br/>
}<br/>
若服务器为Apache，则可以按照如下配置：</p>
<IfModule mod_setenvif.c>
<pre><code class="language-text">&lt;IfModule mod_headers.c&gt;
    &lt;FilesMatch &quot;\.(cur|gif|ico|jpe?g|png|svgz?|webp)$&quot;&gt;
        SetEnvIf Origin &quot;:&quot; IS_CORS
        Header set Access-Control-Allow-Origin &quot;*&quot; env=IS_CORS
    &lt;/FilesMatch&gt;
&lt;/IfModule&gt;
</code></pre>
</IfModule>
<p>为安全起见，Access-Control-Allow-Origin也可设为特定域名的方式。</p>

<p>在HTML5中，有些HTML元素为CORS提供了支持，如img、video新增了 crossOrigin 属性，属性值可以为 anonymous 或 use-credentials 。比如， canvas 绘图要用到跨域图片，在 JavaScript 中要设置 img . crossOrigin = &quot;Anonymous&quot; ;</p>

<p>var img = new Image,<br/>
  canvas = document.createElement(&quot;canvas&quot;),<br/>
  ctx = canvas.getContext(&quot;2d&quot;),<br/>
  src = &quot;<a href="http://example.com/image">http://example.com/image</a>&quot;; // insert image url here<br/>
img.crossOrigin = &quot;Anonymous&quot;;<br/>
img.onload = function() {<br/>
  canvas.width = img.width;<br/>
  canvas.height = img.height;<br/>
  ctx.drawImage( img, 0, 0 );<br/>
  localStorage.setItem( &quot;savedImageData&quot;, canvas.toDataURL(&quot;image/png&quot;) );<br/>
}<br/>
img.src = src;<br/>
// make sure the load event fires for cached images too<br/>
if ( img.complete || img.complete === undefined ) {<br/>
  img.src = &quot;data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==&quot;;<br/>
  img.src = src;<br/>
}<br/>
上述配置完成后，重启服务器，CORS启用。</p>

<p>然后我们再刷新页面，查询请求头的参数，可以发现多出一个：Access-Control-Allow-Origin:*</p>

<p>，到此证明服务器配置已经生效。同时我们的canvas绘图也可以正常使用了。</p>

<p>刷新页面返回请求响应结果后，HTTP Request Headers的内容：</p>

<p>Remote Address:222.132.18.xx:80</p>

<p>Request URL:<a href="http://js.xx.com/static/activity/sq/guagua315/images/card_inner.jpg">http://js.xx.com/static/activity/sq/guagua315/images/card_inner.jpg</a></p>

<p>Request Method:GET</p>

<p>Status Code:200 OK</p>

<p>Request Headersview source</p>

<p>Accept:image/webp,<em>/</em>;q=0.8</p>

<p>Accept-Encoding:gzip, deflate, sdch</p>

<p>Accept-Language:zh-CN,zh;q=0.8</p>

<p>Cache-Control:no-cache</p>

<p>Connection:keep-alive</p>

<p>Host:js.xx.com</p>

<p>Origin:<a href="http://act.xx.com">http://act.xx.com</a></p>

<p>Pragma:no-cache</p>

<p>RA-Sid:7CCAD53E-20140704-054839-03c57a-85faf2</p>

<p>RA-Ver:2.8.8</p>

<p>Referer:<a href="http://act.xx.com/sq/guagua315?uuid=46124642&amp;fid=2&amp;sign=xxx">http://act.xx.com/sq/guagua315?uuid=46124642&amp;fid=2&amp;sign=xxx</a></p>

<p>User-Agent:Mozilla/5.0 (Windows NT 6.1;WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/40.0.2214.115Safari/537.36</p>

<p>Response Headersview source</p>

<p>Accept-Ranges:bytes</p>

<p>Access-Control-Allow-Origin:*</p>

<p>Connection:close</p>

<p>Content-Length:4010</p>

<p>Content-Type:image/jpeg</p>

<p>Date:Thu, 12 Mar 2015 02:29:43 GMT</p>

<p>ETag:&quot;54f7d1b4-faa&quot;</p>

<p>Last-Modified:Thu, 05 Mar 2015 03:47:00 GMT</p>

<p>Powered-By-ChinaCache:MISS fromCNC-WF-3-3X6</p>

<p>Powered-By-ChinaCache:MISS fromCNC-WF-3-3X5</p>

<p>Server:Tengine</p>

<p>Switch:FSCS</p>

<p>附图：</p>

    </div>
    <footer class="post-footer clearfix">
      
           
      
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  













<script src="asset/prism.js"></script>

        
      
  
    


    </body>
</html>

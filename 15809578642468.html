

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    --- - shengsheng的博客
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="shengsheng的博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">---</h1>
        <p class="post-date">
                <span>Posted <time datetime="2020/02/06" itemprop="datePublished">2020/02/06</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<p>layout: post<br/>
title: 使用Zend_Auth和Zend_Acl进行角色权限控制<br/>
date: 2015-05-21 15:59<br/>
author: admin<br/>
comments: true</p>

<h2 id="toc_0">categories: []</h2>

<p>在CRM系统开发中，根据不同的用户组分配不同的权限是一件再正常不过的事情。ZF框架提供的Zend_Auth和Zend_Acl这两个组件就是用来帮我们完成类似工作的。<br/>
Zend_Auth登录认证:　　<br/>
Zend_Auth组件的使用很容易，相信大家看了下面的图文解说之后就会明白的。</p>

<p>解释：<br/>
Zend_Auth_Adapter_Interface中提供了一个接口，我们需要自己去实现<br/>
代码如下：</p>

<p>&lt;?php<br/>
require_once &#39;Zend/Auth/Adapter/Interface.php&#39;;<br/>
class Auth implements Zend_Auth_Adapter_Interface{<br/>
    private \(_useraccount;<br/>
    private \)_password;<br/>
    private \(_db;<br/>
    /**<br/>
     * 构造函数 设置用户名和密码 数据连接对象   <br/>
     * <br/>
     * @return void      <br/>
     */<br/>
    public function __construct(\)useraccount,\(password,\)db){<br/><br/>
        \(this-&gt;_useraccount = \)useraccount;<br/>
        \(this-&gt;_password      = \)password;<br/>
        \(this-&gt;_db             = \)db; <br/>
    }</p>

<pre><code class="language-text">/**     
 * 进行认证  
 * @throws Zend_Auth_Adapter_Exception    
 * @return Zend_Auth_Result
 * 
 */
public function authenticate()
{
    //默认情况下是认证失败
    $authResult = array(
        &#39;code&#39;     =&gt; Zend_Auth_Result::FAILURE,//详参：Zend_Auth_Result
        &#39;identity&#39; =&gt; &#39;&#39;,
        &#39;info&#39; =&gt; array()
       );

       //获得登录用户信息
    $result = $this-&gt;_getAccountData();

    if(isset($result)&amp;&amp;!empty($result)) {//认证成功,则将用户信息存储到session中
        $authResult = array(
            &#39;code&#39;     =&gt; Zend_Auth_Result::SUCCESS,
            &#39;identity&#39; =&gt; $result[&#39;name&#39;],
            &#39;info&#39;     =&gt; array(&#39;status&#39;=&gt;$result[&#39;status&#39;])
        );
        //角色存储  个人缓存空间
        $namespace = Zend_Auth::getInstance()//单例模式
                             -&gt; getStorage() 
                             -&gt; getNamespace();
        $_SESSION[$namespace][&#39;role&#39;]     = $result[&#39;group_id&#39;];//所属用户组
        $_SESSION[$namespace][&#39;userInfo&#39;] = $result;
        $_SESSION[$namespace][&#39;userInfo&#39;][&#39;lastLoginTime&#39;] = $result[&#39;login_time&#39;];
        $_SESSION[$namespace][&#39;userInfo&#39;][&#39;lastLoginIp&#39;]   = $result[&#39;login_ip&#39;];           
</code></pre>

<p>//            \(_SESSION[\)namespace][&#39;userInfo&#39;][&#39;password&#39;]   = $result[&#39;password&#39;];//密码是很重要的，不要写到session中<br/>
        }</p>

<pre><code class="language-text">    return new Zend_Auth_Result($authResult[&#39;code&#39;], $authResult[&#39;identity&#39;], $authResult[&#39;info&#39;]);
}
/**
 * 用户密码加密
 * @param $pwd  原始密码
 * @return string  加密后的密码字符串
 * 
 */
static public function encryptionType($pwd=null) {
    $pwd = md5($pwd);
    return $pwd;
}
/**
 * 获得用户数据结构
 * 
 * @todo 整理密码的公共类
 */
private function _getAccountData(){
    $resArr = array();
    $sysUserObj = Base_Dao_Factory::getObject(&#39;Admin_Models_User&#39;);
    //先登录普通会员帐号
    $data = array(
        &#39;login_name&#39; =&gt; $this-&gt;_useraccount,
        &#39;login_pwd&#39;  =&gt; $this-&gt;encryptionType($this-&gt;_password)
    );
    $result = $sysUserObj-&gt;login($data);
    //判断是否有数据,是则赋值
    if ($result) {
        if (!empty($result[0])) {
            $resArr = $result[0];
        }
    }
    return $resArr;
}
</code></pre>

<p>}</p>

<p>解释：在authenticate方法的实现代码中，return一个Zend_Auth_Result对象实例，而查看Zend_Auth_Result的源代码，知道实例化的时候需要传入三个参数：<br/>
@param int \(code            身份认证的结果（如：Zend_Auth_Result::SUCCESS）<br/>
@param mixed \)identity   用于身份认证的标示符（如：登录名(张三)）<br/>
@param array $messages 认证失败的原因数组<br/>
而一旦认证成功，则将信息存储到session变量中。</p>

<p>以上的校验工作都是在同一个action中完成的，这里，我使用的是Zend_Auth类中的getCode方法<br/>
getCode方法：返回一个zend_auth_resulet常量标识符用来决定认证失败的类型或者是否认证成功(详参：Zend_Auth_Result)</p>

<p>找不到身份表示的错误：Zend_Auth_Result::FAILURE_IDENTITY_NOT_FOUND</p>

<p>无效认证导致的错误：  Zend_Auth_Result::FAILURE_CREDENTIAL_INVALID</p>

<p>认证成功：           Zend_Auth_Result::SUCCESS</p>

<p>一般错误:           Zend_Auth_Result::FAILURE</p>

<p>Zend_Auth中还有其他几个方法:<br/>
getStorage方法：<br/>
getIdentity()：返回认证尝试的身份<br/>
isvalid()           返回true表示一个成功的认证尝试<br/>
getcode()        返回一个zend_auth_resulet常量标识符用来决定认证失败的类型或者是否认证成功<br/>
getIdentity()    返回认证尝试的身份<br/>
getmessages() 返回关于认证尝试失败的数组</p>

<p>\(auth=Zend_Auth::getInstance();        <br/>
 if (\)auth-&gt;hasIdentity()){<br/>
       echo \(auth-&gt;getIdentity();    //输出：张三<br/>
       \)auth-&gt;clearIdentity();       //清除身份<br/>
 }<br/>
 echo \(auth-&gt;getIdentity();          //NULL<br/>
 var_dump(\)auth-&gt;getStorage());     //Zend_Auth_Storage_Session对象</p>

<p>Zend_Acl进行权限控制<br/>
实现目标：当发送一个请求(eg:/index.php/shopping/showshop/)的时候,首先应该先进行判断，看是否具有访问权限<br/>
用图表示，大概就如下所示：</p>

<p>在action被Zend_Controller_Dispatcher派发之前，会先调用Zend_Controller_Plugin_Abstract类中的preDispatch()方法，因此我们可以继承Zend_Controller_Plugin_Abstract类，在子类中的preDispatch方法中进行权限判断。<br/>
代码如下：<br/>
Verify.php<br/>
&lt;?php<br/>
require_once &#39;Zend/Controller/Plugin/Abstract.php&#39;;<br/>
class Verify extends Zend_Controller_Plugin_Abstract<br/>
{<br/>
    /**<br/>
     * 访问控制列表对象<br/>
     * @var object<br/>
     <em>/<br/>
    protected $_acl;<br/>
    /</em>*<br/>
     * 登录的用户名<br/>
     * @var string <br/>
     */<br/>
    protected $_loginname;</p>

<pre><code class="language-text">/**
 * 构造函数
 * 初始化访问控制列表
 * @param Acl $acl
 * @todo 未登录的时候,$this -&gt; _loginname是为空的
 */
public function __construct($acl)
{
    $this -&gt; _acl = $acl;
    require_once(&#39;Zend/Auth.php&#39;);
    $this -&gt; _loginname = Zend_Auth::getInstance()-&gt;getIdentity();//eg:张三
}

/**
 * 重写父类的preDispatch方法
 * 
 * @param Zend_Controller_Request_Abstract $request
 */
public function preDispatch(Zend_Controller_Request_Abstract $request)
{
    //请求信息
    $module     = $request -&gt; module;                //模块
    $controller = $request -&gt; controller;            //请求的控制器
    $action     = $request -&gt; action;                //请求的action

    $resource = ucfirst(strtolower($controller));    //资源：一个限制访问的对象
    $action   = strtolower($action);                
    $role     = $this-&gt;_acl-&gt;getRole();                //角色：一个可以发出请求去访问Resource的对象

    //判断是否拥有资源
    if(!($this -&gt; _acl -&gt; has($resource))) {
        $resource = null;
    }
</code></pre>

<p>//        \(this-&gt;_acl-&gt;removeAllow(\)role,\(resource);        //可以针对某个role移除权限<br/>
        //判断当前用户是有权限执行某个请求<br/>
        if(!(\)this -&gt; _acl -&gt; isAllowed(\(role, \)resource, \(action))) {<br/>
            if (!\)this -&gt; _loginname) {//未登陆的情况<br/>
                \(module     = &#39;admin&#39;;<br/>
                \)controller = &#39;login&#39;;<br/>
                \(action     = &#39;view&#39;;<br/>
            }else {                      //没有权限的情况<br/>
                echo &quot;&lt;script&gt;<br/>
                        \).messager.alert(&#39;提醒&#39;,&#39;您没有操作权限&#39;, &#39;warning&#39;);<br/>
                    </script>&quot;;<br/>
                exit();<br/>
            }<br/>
        }<br/>
//        else {    //认证成功<br/>
//<br/><br/>
//        }<br/>
        \(request -&gt; setModuleName(\)module);<br/>
        \(request -&gt; setControllerName(\)controller);<br/>
        \(request -&gt; setActionName(\)action);<br/>
    }<br/>
}</p>

<p>解释：思路其实很简单，首先获取当前用户的角色（或超管或访客），然后使用isAllowed方法来判断请求者在整个 web 应用里是否拥有执行功能的许可，从而执行不同的流程控制。<br/>
但是，这里涉及到几个问题：<br/>
①preDispatch方法在哪里调用呢<br/>
②Verify类在哪里进行实例化<br/>
③访问控制列表(acl)如何定义<br/>
解答：<br/>
第一个问题：preDispatch在Zend_Controller_Action的dispatch方法中被调用（502行左右），该方法先于postDispatch被调用。<br/>
第二个问题：在入口文件index.php中进行实例化<br/>
\(acl = new Acl();//自定义的Acl类\)fc = Zend_Controller_Front::getInstance();//取得Zend_Controller_Front类实例\(fc -&gt; registerPlugin(new Verify(\)acl));<br/>
以上代码片段的\(acl = new Acl()也正是第三个问题将要回答的<br/>
第三个问题：关于访问控制列表的定义，及如何添加角色，添加资源，可以仔细看看官方手册，讲得很详细<br/>
http://framework.zend.com/manual/1.12/zh/zend.acl.introduction.html<br/>
Zend_Acl中的几个方法：<br/>
allow：增加一条“允许”规则到acl列表<br/>
如：\)acl-&gt;allow(&#39;guest&#39;, null, &#39;view&#39;);//允许游客具有访问的权限<br/>
deny：增加一条“禁止”规则到acl列表<br/>
如：\(acl-&gt;deny(&#39;guest&#39;, null, &#39;view&#39;);//禁止游客具有访问的权限<br/>
isAllowed：判断某个角色（role）是否有权访问某个资源（resource）<br/>
remove：删除某个资源及其子资源<br/>
removeAll：从ACL中删除所有的资源<br/>
removeAllow：从ACL中删除某个role有权访问的资源<br/>
removeDeny：从ACL中删除某个role禁止访问的资源<br/>
removeRole：从ACL中删除某个角色role<br/>
addRole：添加一个唯一的角色到ACL注册表中<br/>
hasRole：判断某个角色role是否已注册过<br/>
getRole：返回当前用户角色<br/>
getRoles：返回一个注册角色的数组<br/>
getResources：返回注册过的资源数组<br/>
在项目中，我们可以写一个Acl类，继承自Zend_Acl，而角色，资源等的添加定义都可以在自定义类中去实现<br/>
好比如这样：<br/>
Acl.php(自定义)<br/>
&lt;?php<br/>
require_once(&#39;Zend/Acl.php&#39;);<br/>
/**<br/>
 * 角色权限控制<br/>
 * <br/>
 */<br/>
class Acl extends Zend_Acl<br/>
{<br/>
    public function __construct()<br/>
    {<br/>
        \)role = \(this -&gt; getRole();                    //获取用户角色<br/>
        if (\)role==&#39;guest&#39;) {                        //访客角色<br/>
            \(roleGuest=new Zend_Acl_Role(&#39;guest&#39;);    //创建角色guest<br/>
            \)this-&gt;addRole(\(roleGuest);                //将角色添加到role注册表<br/>
            \)this -&gt; add(new Zend_Acl_Resource(&#39;Login&#39;));<br/>
            \(this -&gt; add(new Zend_Acl_Resource(&#39;User&#39;));<br/>
            \)this -&gt; allow(&#39;guest&#39;, null, array(&#39;login&#39;));    //允许访客到登录界面<br/>
            \(this -&gt; allow(&#39;guest&#39;, null, Array(&#39;showuserbydep&#39;));//允许guest根据部门获取用户<br/>
        }else {                                    //登录用户的权限<br/>
            //如果该角色不存在,则添加到Role注册表中,否则后面的代码会报错<br/>
            //eg:Fatal error: Uncaught exception &#39;Zend_Acl_Role_Registry_Exception&#39; with message &#39;Role &#39;admin&#39; not found&#39;<br/>
            if (!\)this-&gt;hasRole(\(role)) {<br/>
                \)this -&gt; addRole(new Zend_Acl_Role($role));<br/>
            }</p>

<pre><code class="language-text">        //登录的用户都有的权限
        $this -&gt; add(new Zend_Acl_Resource(&#39;Index&#39;));
        $this -&gt; add(new Zend_Acl_Resource(&#39;Dep&#39;));
        $this -&gt; add(new Zend_Acl_Resource(&#39;Login&#39;));
        $this -&gt; add(new Zend_Acl_Resource(&#39;Order&#39;));
        $this -&gt; add(new Zend_Acl_Resource(&#39;Shopping&#39;));
        $this -&gt; add(new Zend_Acl_Resource(&#39;User&#39;));
        $this -&gt; add(new Zend_Acl_Resource(&#39;Authgroup&#39;));

        //第三个参数不写,默认具有访问整个控制器的权限
        $this -&gt; allow($role,&#39;Index&#39;,Array(&#39;index&#39;));
        $this -&gt; allow($role,&#39;Login&#39;,Array(&#39;index&#39;,&#39;login&#39;,&#39;admin&#39;,&#39;top&#39;,&#39;left&#39;,&#39;view&#39;,&#39;welcome&#39;,&#39;logout&#39;));
        $this -&gt; allow($role,&#39;Order&#39;,Array(&#39;orderhistory&#39;));
        $this -&gt; allow($role,&#39;Shopping&#39;,Array(&#39;showmenu&#39;,&#39;uploadimage&#39;,&#39;showshop&#39;,&#39;showfood&#39;));
        $this -&gt; allow($role,&#39;User&#39;,&#39;index&#39;);
        $this -&gt; allow($role,&#39;Dep&#39;,Array(&#39;showdep&#39;));
        $this -&gt; allow($role,&#39;Authgroup&#39;,&#39;index&#39;);

        $rolePurview = $this -&gt; getRolePurview($role);//角色的权限
        //判断权限数据格式是否正确
        if(!is_Array($rolePurview)){
            echo &#39;权限数据格式有错误！&#39;;exit();
        }else{
            foreach ($rolePurview as $controller =&gt; $actionArray){
                //controller资源
                $resource = ucfirst($controller);

                //判断是否拥有资源
                if(!$this -&gt; has($resource)){//没有资源
                    $this -&gt; add(new Zend_Acl_Resource($resource));//增加资源
                }

                //判断资源数据格式是否正确
                if(!is_Array($actionArray) || empty($actionArray)){
                    echo &#39;资源数据格式有错误！&#39;;exit();
                }else{
                    foreach ($actionArray as $action){
                        $this -&gt; allow($role, $resource, $action);//允许角色访问资源
                    }
                }
            }
        }
    }
}

/**
 * 获取用户的角色名
 * @return string
 */
public function getRole()
{
    $ns = Zend_Auth::getInstance() -&gt; getStorage() -&gt; getNamespace();

    //有session信息
    if(isset($_SESSION[$ns])) {//有登录
        if(isset($_SESSION[$ns][&#39;role&#39;])){//判断有没有登录用户的角色信息
            $role = $_SESSION[$ns][&#39;role&#39;];
        }else {
            $role = &#39;guest&#39;;
        }
    }else {
        $role = &#39;guest&#39;;
    }
    return $role;
}

/**
 * 获得登录用户的数据数据
 *
 */
public function getUserInfo()
{
    $namespace = Zend_Auth::getInstance() -&gt; getStorage() -&gt; getNamespace();
    //用户认证失败则返回false
    if(isset($_SESSION[$namespace][&#39;userInfo&#39;])) {
        return $_SESSION[$namespace][&#39;userInfo&#39;];
    }else{
        return false;
    }
}
/**
 * 获得权限数据 
 * @return Array   成功返回
 * @return Array   失败返回
 * @todo 只有成功登陆页面的情况下才有数据
 */
public function getUserPermission()
{
    $namespace = Zend_Auth::getInstance() -&gt; getStorage() -&gt; getNamespace();
    if(isset($_SESSION[$namespace][&#39;resourcesPurview&#39;])){
        return $_SESSION[$namespace][&#39;resourcesPurview&#39;];
    }else{
        return false;
    }
}    
/**
 * 根据角色获取权限（获取指定角色的访问控制列表）
 *
 * @param Array $role
 * @return unknown
 */
public function getRolePurview($role)
{
    if(!is_string($role)){
        return false;
    }else {
        $rolePurview = $this -&gt; getAllPurview();
        return $rolePurview[$role];
    }
}    
/**
 * 获取所有角色的权限（访问控制列表）
 *
 * @return Array
 */
public function getAllPurview()
{
    $rolePurview = Array();
    //判断缓存是否存在，有则从缓存中取,否则从数据库中取
    if (!empty($_SESSION[&#39;allRolePurviews&#39;])) {
        $rolePurview = $_SESSION[&#39;allRolePurviews&#39;];
    }else{
        $roleDao = Base_Dao_Factory::getObject(&#39;Admin_Models_Authgroup&#39;);
        $result  = $roleDao -&gt; getAllGroup(Array(&#39;id&#39;, &#39;group_purview&#39;));

        if(!empty($result)){
            foreach ($result as $key =&gt; $value){
                $purview[$value[&#39;id&#39;]] = Zend_Json::decode($value[&#39;group_purview&#39;]);
            }
        }
        $rolePurview = $purview;
        $_SESSION[&#39;allRolePurviews&#39;] = $purview;
    }
    return $rolePurview;
}    
</code></pre>

<p>}</p>

<p>解释：自定义的Acl类中，我们首先要判断当前登录用户是访客还是系统用户，从而针对不同的用户角色给予不同的权限。<br/>
通过allow()我们可以很容易的针对不同的角色给予不同的权限控制。<br/>
注：对于出“访客”外的其他所有用户角色，都有一些默认的权限<br/>
现在我抛出一个问题：系统用户肯定有多个分组（比如：超级管理员和普通用户的权限定然不一样）那如何针对不同的用户组分配不同的权限呢？<br/>
这个容易，可以将不同组的权限存到数据库中，要用到的时候，根据不同的用户角色查得其所有的访问权限，在循环遍历下，通过allow将角色权限添加到acl中即可，也就是以上的代码片段：<br/>
[PHP] 纯文本查看 复制代码</p>

<p>//判断资源数据格式是否正确<br/>
if(!is_Array(\(actionArray) || empty(\)actionArray)){<br/>
    echo &#39;资源数据格式有错误！&#39;;exit();<br/>
}else{<br/>
    foreach (\(actionArray as \)action){<br/>
        \(this -&gt; allow(\)role, \(resource, \)action);//允许角色访问资源<br/>
    }<br/>
}</p>

<p>(<br/>
    [admin] =&gt; Array<br/>
        (<br/>
            [Login] =&gt; Array<br/>
                (<br/>
                    [0] =&gt; index<br/>
                    [1] =&gt; admin<br/>
                    [2] =&gt; top<br/>
                    [3] =&gt; left<br/>
                    [4] =&gt; view<br/>
                    [5] =&gt; welcome<br/>
                )</p>

<pre><code class="language-text">        [Authgroup] =&gt; Array
            (
                [0] =&gt; index
                [1] =&gt; getpermission
                [2] =&gt; edit
            )

        [Order] =&gt; Array
            (
                [0] =&gt; orderhistory
                [1] =&gt; allorders
                [2] =&gt; delorder
                [3] =&gt; latestorders
                [4] =&gt; nopayorders
                [5] =&gt; changepaystate
                [6] =&gt; ordersbyrestaurant
            )

        [Shopping] =&gt; Array
            (
                [0] =&gt; showmenu
                [1] =&gt; uploadimage
                [2] =&gt; showshop
                [3] =&gt; showfood
                [4] =&gt; addshop
                [5] =&gt; delshop
                [6] =&gt; editshop
                [7] =&gt; updateshop
                [8] =&gt; changestate
                [9] =&gt; addfood
                [10] =&gt; editfood
                [11] =&gt; delfood
                [12] =&gt; updatefood
            )

        [User] =&gt; Array
            (
                [0] =&gt; 
            )

        [System] =&gt; Array
            (
                [0] =&gt; 
            )

        [Dep] =&gt; Array
            (
                [0] =&gt; showdep
                [1] =&gt; adddep
                [2] =&gt; deldep
                [3] =&gt; viewusersbydep
            )

    )
</code></pre>

<p>)</p>

<p>以上是“超级管理员”所拥有的权限<br/>
注意一点：在用户登录成功后，可以讲当前用户角色所拥有的权限信息存储到session变量中，这样以后就不必每次都查询数据库去获取了<br/>
至于，如何编辑用户组的权限，将其保存到数据库中，可以有多种方法。<br/>
我是将权限以json的格式形式存入数据库中的，而在服务器上创建一个Permission.php文件，以二维数组的形式进行保存，每当需要添加权限时，得手动编辑该文件，而要给不同的用户组分配不同的权限的时候，采用复选框的方式进行勾选即可。<br/>
<a href="http://framework.zend.com/manual/1.12/zh/zend.acl.introduction.html">http://framework.zend.com/manual/1.12/zh/zend.acl.introduction.html</a></p>

    </div>
    <footer class="post-footer clearfix">
      
           
      
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  













<script src="asset/prism.js"></script>

        
      
  
    


    </body>
</html>

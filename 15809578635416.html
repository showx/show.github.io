

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    --- - shengsheng的博客
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="shengsheng的博客" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">---</h1>
        <p class="post-date">
                <span>Posted <time datetime="2020/02/06" itemprop="datePublished">2020/02/06</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<p>layout: post<br/>
title: linux 内存耗尽的分析<br/>
date: 2015-08-12 17:31<br/>
author: admin<br/>
comments: true</p>

<h2 id="toc_0">categories: []</h2>

<p>在测试NAS性能，用fstest长时间写，分析性能变差的原因，发现server主机内存使用率很高。</p>

<p>1．首先查看内存<br/>
<div><br/>
<div id="highlighter_19313" class="syntaxhighlighter  shell"><br/>
<div class="toolbar"><a class="toolbar_item command_help help" href="http://my.oschina.net/hanhanztj/blog/490308#">?</a></div><br/>
<table border="0" cellspacing="0" cellpadding="0"><br/>
<tbody><br/>
<tr><br/>
<td class="gutter"><br/>
<div class="line number1 index0 alt2">1</div><br/>
<div class="line number2 index1 alt1">2</div><br/>
<div class="line number3 index2 alt2">3</div><br/>
<div class="line number4 index3 alt1">4</div><br/>
<div class="line number5 index4 alt2">5</div><br/>
<div class="line number6 index5 alt1">6</div><br/>
<div class="line number7 index6 alt2">7</div><br/>
<div class="line number8 index7 alt1">8</div><br/>
<div class="line number9 index8 alt2">9</div><br/>
<div class="line number10 index9 alt1">10</div><br/>
<div class="line number11 index10 alt2">11</div><br/>
<div class="line number12 index11 alt1">12</div><br/>
<div class="line number13 index12 alt2">13</div><br/>
<div class="line number14 index13 alt1">14</div></td><br/>
<td class="code"><br/>
<div class="container"><br/>
<div class="line number1 index0 alt2"><code class="shell comments"># top -M </code></div><br/>
<div class="line number2 index1 alt1"><code class="shell spaces"> </code><code class="shell functions">top</code> <code class="shell plain">- 14:43:12 up 14 days, 6 min,  1 user,  load average: 8.36, 8.38, 8.41</code></div><br/>
<div class="line number3 index2 alt2"><code class="shell spaces"> </code><code class="shell plain">Tasks: 419 total,   1 running, 418 sleeping,   0 stopped,   0 zombie</code></div><br/>
<div class="line number4 index3 alt1"><code class="shell spaces"> </code><code class="shell plain">Cpu(s):  0.0%us,  0.2%sy,  0.0%ni, 99.0%</code><code class="shell functions">id</code><code class="shell plain">,  0.7%wa,  0.0%hi,  0.0%si,  0.0%st</code></div><br/>
<div class="line number5 index4 alt2"><code class="shell spaces"> </code></div><br/>
<div class="line number6 index5 alt1"><code class="shell plain">Mem:    63.050G total,   62.639G used,  420.973M </code><code class="shell functions">free</code><code class="shell plain">,   33.973M buffers</code></div><br/>
<div class="line number7 index6 alt2"><code class="shell spaces"> </code><code class="shell plain">Swap: 4095.996M total,    0.000k used, 4095.996M </code><code class="shell functions">free</code><code class="shell plain">,   48.889G cached</code></div><br/>
<div class="line number8 index7 alt1"><code class="shell spaces">   </code><code class="shell plain">PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                                                         </code></div><br/>
<div class="line number9 index8 alt2"><code class="shell spaces">   </code><code class="shell plain">111 root      20   0     0    0    0 S  2.0  0.0   0:25.52 ksoftirqd</code><code class="shell plain">/11</code></div><br/>
<div class="line number10 index9 alt1"><code class="shell spaces">  </code><code class="shell plain">5968 root      20   0 15352 1372  828 R  2.0  0.0   0:00.01 </code><code class="shell functions">top</code></div><br/>
<div class="line number11 index10 alt2"><code class="shell spaces"> </code><code class="shell plain">13273 root      20   0     0    0    0 D  2.0  0.0  25:54.02 nfsd                                                                                                                            </code></div><br/>
<div class="line number12 index11 alt1"><code class="shell spaces"> </code><code class="shell plain">17765 root       0 -20     0    0    0 S  2.0  0.0   0:11.89 kworker</code><code class="shell plain">/5</code><code class="shell plain">:1H                                                                                                                    </code></div><br/>
<div class="line number13 index12 alt2"><code class="shell spaces">     </code><code class="shell plain">1 root      20   0 19416 1436 1136 S  0.0  0.0   0:01.88 init </code></div><br/>
<div class="line number14 index13 alt1"><code class="shell spaces"> </code><code class="shell plain">.....</code></div><br/>
</div></td><br/>
</tr><br/>
</tbody><br/>
</table><br/>
</div><br/>
</div><br/>
发现内存基本用完，究竟是什么进程占用？top命令发现排名第一的%MEM才零点几。</p>

<p>2.通过 vmstat -m命令查看内核空间的内存使用。<br/>
<div><br/>
<div id="highlighter_129489" class="syntaxhighlighter  shell"><br/>
<div class="toolbar"><a class="toolbar_item command_help help" href="http://my.oschina.net/hanhanztj/blog/490308#">?</a></div><br/>
<table border="0" cellspacing="0" cellpadding="0"><br/>
<tbody><br/>
<tr><br/>
<td class="gutter"><br/>
<div class="line number1 index0 alt2">1</div><br/>
<div class="line number2 index1 alt1">2</div><br/>
<div class="line number3 index2 alt2">3</div><br/>
<div class="line number4 index3 alt1">4</div><br/>
<div class="line number5 index4 alt2">5</div><br/>
<div class="line number6 index5 alt1">6</div><br/>
<div class="line number7 index6 alt2">7</div><br/>
<div class="line number8 index7 alt1">8</div><br/>
<div class="line number9 index8 alt2">9</div><br/>
<div class="line number10 index9 alt1">10</div><br/>
<div class="line number11 index10 alt2">11</div><br/>
<div class="line number12 index11 alt1">12</div><br/>
<div class="line number13 index12 alt2">13</div><br/>
<div class="line number14 index13 alt1">14</div><br/>
<div class="line number15 index14 alt2">15</div><br/>
<div class="line number16 index15 alt1">16</div><br/>
<div class="line number17 index16 alt2">17</div><br/>
<div class="line number18 index17 alt1">18</div><br/>
<div class="line number19 index18 alt2">19</div><br/>
<div class="line number20 index19 alt1">20</div><br/>
<div class="line number21 index20 alt2">21</div><br/>
<div class="line number22 index21 alt1">22</div><br/>
<div class="line number23 index22 alt2">23</div><br/>
<div class="line number24 index23 alt1">24</div><br/>
<div class="line number25 index24 alt2">25</div><br/>
<div class="line number26 index25 alt1">26</div><br/>
<div class="line number27 index26 alt2">27</div><br/>
<div class="line number28 index27 alt1">28</div><br/>
<div class="line number29 index28 alt2">29</div><br/>
<div class="line number30 index29 alt1">30</div><br/>
<div class="line number31 index30 alt2">31</div><br/>
<div class="line number32 index31 alt1">32</div><br/>
<div class="line number33 index32 alt2">33</div><br/>
<div class="line number34 index33 alt1">34</div><br/>
<div class="line number35 index34 alt2">35</div><br/>
<div class="line number36 index35 alt1">36</div><br/>
<div class="line number37 index36 alt2">37</div><br/>
<div class="line number38 index37 alt1">38</div><br/>
<div class="line number39 index38 alt2">39</div><br/>
<div class="line number40 index39 alt1">40</div><br/>
<div class="line number41 index40 alt2">41</div><br/>
<div class="line number42 index41 alt1">42</div><br/>
<div class="line number43 index42 alt2">43</div><br/>
<div class="line number44 index43 alt1">44</div><br/>
<div class="line number45 index44 alt2">45</div><br/>
<div class="line number46 index45 alt1">46</div><br/>
<div class="line number47 index46 alt2">47</div><br/>
<div class="line number48 index47 alt1">48</div><br/>
<div class="line number49 index48 alt2">49</div><br/>
<div class="line number50 index49 alt1">50</div><br/>
<div class="line number51 index50 alt2">51</div></td><br/>
<td class="code"><br/>
<div class="container"><br/>
<div class="line number1 index0 alt2"><code class="shell comments"># vmstat -m</code></div><br/>
<div class="line number2 index1 alt1"><code class="shell spaces"> </code><code class="shell plain">Cache                       Num  Total   Size  Pages</code></div><br/>
<div class="line number3 index2 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_dqtrx                     0      0    384     10</code></div><br/>
<div class="line number4 index3 alt1"><code class="shell spaces"> </code><code class="shell plain">xfs_dquot                     0      0    504      7</code></div><br/>
<div class="line number5 index4 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_buf                   91425 213300    384     10</code></div><br/>
<div class="line number6 index5 alt1"><code class="shell spaces"> </code><code class="shell plain">fstrm_item                    0      0     24    144</code></div><br/>
<div class="line number7 index6 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_mru_cache_elem            0      0     32    112</code></div><br/>
<div class="line number8 index7 alt1"><code class="shell spaces"> </code></div><br/>
<div class="line number9 index8 alt2"><code class="shell plain">xfs_ili                  7564110 8351947    224     17</code></div><br/>
<div class="line number10 index9 alt1"><code class="shell spaces"> </code><code class="shell plain">xfs_inode                7564205 8484180   1024      4</code></div><br/>
<div class="line number11 index10 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_efi_item                257    390    400     10</code></div><br/>
<div class="line number12 index11 alt1"><code class="shell spaces"> </code><code class="shell plain">xfs_efd_item                237    380    400     10</code></div><br/>
<div class="line number13 index12 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_buf_item               1795   2414    232     17</code></div><br/>
<div class="line number14 index13 alt1"><code class="shell spaces"> </code><code class="shell plain">xfs_log_item_desc           830   1456     32    112</code></div><br/>
<div class="line number15 index14 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_trans                   377    490    280     14</code></div><br/>
<div class="line number16 index15 alt1"><code class="shell spaces"> </code><code class="shell plain">xfs_ifork                     0      0     64     59</code></div><br/>
<div class="line number17 index16 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_da_state                  0      0    488      8</code></div><br/>
<div class="line number18 index17 alt1"><code class="shell spaces"> </code><code class="shell plain">xfs_btree_cur               342    437    208     19</code></div><br/>
<div class="line number19 index18 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_bmap_free_item           89    288     24    144</code></div><br/>
<div class="line number20 index19 alt1"><code class="shell spaces"> </code><code class="shell plain">xfs_log_ticket              717    966    184     21</code></div><br/>
<div class="line number21 index20 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_ioend                   726    896    120     32</code></div><br/>
<div class="line number22 index21 alt1"><code class="shell spaces"> </code><code class="shell plain">rbd_segment_name            109    148    104     37</code></div><br/>
<div class="line number23 index22 alt2"><code class="shell spaces"> </code><code class="shell plain">rbd_obj_request            1054   1452    176     22</code></div><br/>
<div class="line number24 index23 alt1"><code class="shell spaces"> </code><code class="shell plain">rbd_img_request            1037   1472    120     32</code></div><br/>
<div class="line number25 index24 alt2"><code class="shell spaces"> </code><code class="shell plain">ceph_osd_request            548    693    872      9</code></div><br/>
<div class="line number26 index25 alt1"><code class="shell spaces"> </code><code class="shell plain">ceph_msg_data              1041   1540     48     77</code></div><br/>
<div class="line number27 index26 alt2"><code class="shell spaces"> </code><code class="shell plain">ceph_msg                   1197   1632    232     17</code></div><br/>
<div class="line number28 index27 alt1"><code class="shell spaces"> </code><code class="shell plain">nfsd_drc                  19323  33456    112     34</code></div><br/>
<div class="line number29 index28 alt2"><code class="shell spaces"> </code><code class="shell plain">nfsd4_delegations             0      0    368     10</code></div><br/>
<div class="line number30 index29 alt1"><code class="shell spaces"> </code><code class="shell plain">nfsd4_stateids              855   1024    120     32</code></div><br/>
<div class="line number31 index30 alt2"><code class="shell spaces"> </code><code class="shell plain">nfsd4_files                 802   1050    128     30</code></div><br/>
<div class="line number32 index31 alt1"><code class="shell spaces"> </code><code class="shell plain">nfsd4_lockowners              0      0    384     10</code></div><br/>
<div class="line number33 index32 alt2"><code class="shell spaces"> </code><code class="shell plain">nfsd4_openowners             15     50    392     10</code></div><br/>
<div class="line number34 index33 alt1"><code class="shell spaces"> </code><code class="shell plain">rpc_inode_cache              27     30    640      6</code></div><br/>
<div class="line number35 index34 alt2"><code class="shell spaces"> </code><code class="shell plain">rpc_buffers                   8      8   2048      2</code></div><br/>
<div class="line number36 index35 alt1"><code class="shell spaces"> </code><code class="shell plain">rpc_tasks                     8     15    256     15</code></div><br/>
<div class="line number37 index36 alt2"><code class="shell spaces"> </code><code class="shell plain">fib6_nodes                   22     59     64     59</code></div><br/>
<div class="line number38 index37 alt1"><code class="shell spaces"> </code><code class="shell plain">pte_list_desc                 0      0     32    112</code></div><br/>
<div class="line number39 index38 alt2"><code class="shell spaces"> </code><code class="shell plain">ext4_groupinfo_4k           722    756    136     28</code></div><br/>
<div class="line number40 index39 alt1"><code class="shell spaces"> </code><code class="shell plain">ext4_inode_cache           3362   3728    968      4</code></div><br/>
<div class="line number41 index40 alt2"><code class="shell spaces"> </code><code class="shell plain">ext4_xattr                    0      0     88     44</code></div><br/>
<div class="line number42 index41 alt1"><code class="shell spaces"> </code><code class="shell plain">ext4_free_data                0      0     64     59</code></div><br/>
<div class="line number43 index42 alt2"><code class="shell spaces"> </code><code class="shell plain">ext4_allocation_context       0      0    136     28</code></div><br/>
<div class="line number44 index43 alt1"><code class="shell spaces"> </code><code class="shell plain">ext4_prealloc_space          42     74    104     37</code></div><br/>
<div class="line number45 index44 alt2"><code class="shell spaces"> </code><code class="shell plain">ext4_system_zone              0      0     40     92</code></div><br/>
<div class="line number46 index45 alt1"><code class="shell spaces"> </code><code class="shell plain">Cache                       Num  Total   Size  Pages</code></div><br/>
<div class="line number47 index46 alt2"><code class="shell spaces"> </code><code class="shell plain">ext4_io_end                   0      0     64     59</code></div><br/>
<div class="line number48 index47 alt1"><code class="shell spaces"> </code><code class="shell plain">ext4_extent_status         1615   5704     40     92</code></div><br/>
<div class="line number49 index48 alt2"><code class="shell spaces"> </code><code class="shell plain">jbd2_transaction_s           30     30    256     15</code></div><br/>
<div class="line number50 index49 alt1"><code class="shell spaces"> </code><code class="shell plain">jbd2_inode                  254    539     48     77</code></div><br/>
<div class="line number51 index50 alt2"><code class="shell spaces"> </code><code class="shell plain">........</code></div><br/>
</div></td><br/>
</tr><br/>
</tbody><br/>
</table><br/>
</div><br/>
</div><br/>
发现这两项值很高： xfs_ili    xfs_inode  占用了大量的内存。</p>

<p>3.使用slabtop命令查看内核slab 缓冲区信息<br/>
<div><br/>
<div id="highlighter_639419" class="syntaxhighlighter  shell"><br/>
<div class="toolbar"><a class="toolbar_item command_help help" href="http://my.oschina.net/hanhanztj/blog/490308#">?</a></div><br/>
<table border="0" cellspacing="0" cellpadding="0"><br/>
<tbody><br/>
<tr><br/>
<td class="gutter"><br/>
<div class="line number1 index0 alt2">1</div><br/>
<div class="line number2 index1 alt1">2</div><br/>
<div class="line number3 index2 alt2">3</div><br/>
<div class="line number4 index3 alt1">4</div><br/>
<div class="line number5 index4 alt2">5</div><br/>
<div class="line number6 index5 alt1">6</div><br/>
<div class="line number7 index6 alt2">7</div><br/>
<div class="line number8 index7 alt1">8</div><br/>
<div class="line number9 index8 alt2">9</div><br/>
<div class="line number10 index9 alt1">10</div><br/>
<div class="line number11 index10 alt2">11</div><br/>
<div class="line number12 index11 alt1">12</div><br/>
<div class="line number13 index12 alt2">13</div></td><br/>
<td class="code"><br/>
<div class="container"><br/>
<div class="line number1 index0 alt2"><code class="shell comments">#slabtop -s c | head</code></div><br/>
<div class="line number2 index1 alt1"><code class="shell spaces">   </code><code class="shell plain">Active / Total Objects (% used)    : 31807723 / 35664583 (89.2%)</code></div><br/>
<div class="line number3 index2 alt2"><code class="shell spaces">  </code><code class="shell plain">Active / Total Slabs (% used)      : 3259180 / 3259251 (100.0%)</code></div><br/>
<div class="line number4 index3 alt1"><code class="shell spaces">  </code><code class="shell plain">Active / Total Caches (% used)     : 139 / 227 (61.2%)</code></div><br/>
<div class="line number5 index4 alt2"><code class="shell spaces">  </code><code class="shell plain">Active / Total Size (% used)       : 11242773.43K / 12756788.05K (88.1%)</code></div><br/>
<div class="line number6 index5 alt1"><code class="shell spaces">  </code><code class="shell plain">Minimum / Average / Maximum Object : 0.02K / 0.36K / 4096.00K</code></div><br/>
<div class="line number7 index6 alt2"><code class="shell spaces">   </code><code class="shell plain">OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ</code><code class="shell plain">/SLAB</code> <code class="shell plain">CACHE SIZE NAME                   </code></div><br/>
<div class="line number8 index7 alt1"><code class="shell spaces"> </code><code class="shell plain">8480676 7565420  89%    1.00K 2120169        4   </code></div><br/>
<div class="line number9 index8 alt2"><code class="shell plain">8480676K </code></div><br/>
<div class="line number10 index9 alt1"><code class="shell plain">xfs_inode</code></div><br/>
<div class="line number11 index10 alt2"><code class="shell spaces"> </code><code class="shell plain">8351794 7565375  90%    0.22K 491282       17   </code></div><br/>
<div class="line number12 index11 alt1"><code class="shell plain">1965128K </code></div><br/>
<div class="line number13 index12 alt2"><code class="shell plain">xfs_ili</code></div><br/>
</div></td><br/>
</tr><br/>
</tbody><br/>
</table><br/>
</div><br/>
</div><br/>
&nbsp;</p>

<p>&nbsp;</p>

<p>xfs_ili 占用1965128k  xfs_inode占用8480676K，但他们究竟是什么东东？猜测是nas/rbd 卷的文件系统缓存信息。xfs_inode看字面意思是xfs文件系统的inode信息。</p>

<p>搜了下xfs_ili，只搜到内核代码片段。</p>

<p>&nbsp;<br/>
<div><br/>
<div id="highlighter_495101" class="syntaxhighlighter  shell"><br/>
<div class="toolbar"><a class="toolbar_item command_help help" href="http://my.oschina.net/hanhanztj/blog/490308#">?</a></div><br/>
<table border="0" cellspacing="0" cellpadding="0"><br/>
<tbody><br/>
<tr><br/>
<td class="gutter"><br/>
<div class="line number1 index0 alt2">1</div><br/>
<div class="line number2 index1 alt1">2</div><br/>
<div class="line number3 index2 alt2">3</div><br/>
<div class="line number4 index3 alt1">4</div><br/>
<div class="line number5 index4 alt2">5</div><br/>
<div class="line number6 index5 alt1">6</div><br/>
<div class="line number7 index6 alt2">7</div><br/>
<div class="line number8 index7 alt1">8</div><br/>
<div class="line number9 index8 alt2">9</div><br/>
<div class="line number10 index9 alt1">10</div><br/>
<div class="line number11 index10 alt2">11</div><br/>
<div class="line number12 index11 alt1">12</div><br/>
<div class="line number13 index12 alt2">13</div><br/>
<div class="line number14 index13 alt1">14</div><br/>
<div class="line number15 index14 alt2">15</div><br/>
<div class="line number16 index15 alt1">16</div><br/>
<div class="line number17 index16 alt2">17</div><br/>
<div class="line number18 index17 alt1">18</div><br/>
<div class="line number19 index18 alt2">19</div><br/>
<div class="line number20 index19 alt1">20</div><br/>
<div class="line number21 index20 alt2">21</div><br/>
<div class="line number22 index21 alt1">22</div><br/>
<div class="line number23 index22 alt2">23</div><br/>
<div class="line number24 index23 alt1">24</div><br/>
<div class="line number25 index24 alt2">25</div><br/>
<div class="line number26 index25 alt1">26</div><br/>
<div class="line number27 index26 alt2">27</div></td><br/>
<td class="code"><br/>
<div class="container"><br/>
<div class="line number1 index0 alt2"><code class="shell spaces"> </code><code class="shell plain">xfs_inode_zone =</code></div><br/>
<div class="line number2 index1 alt1"><code class="shell plain">1636                 kmem_zone_init_flags(sizeof(xfs_inode_t), </code><code class="shell string">&quot;xfs_inode&quot;</code><code class="shell plain">,</code></div><br/>
<div class="line number3 index2 alt2"><code class="shell plain">1637                         KM_ZONE_HWALIGN | KM_ZONE_RECLAIM | KM_ZONE_SPREAD,</code></div><br/>
<div class="line number4 index3 alt1"><code class="shell plain">1638                         xfs_fs_inode_init_once);</code></div><br/>
<div class="line number5 index4 alt2"><code class="shell plain">1639         </code><code class="shell keyword">if</code> <code class="shell plain">(!xfs_inode_zone)</code></div><br/>
<div class="line number6 index5 alt1"><code class="shell plain">1640                 goto out_destroy_efi_zone;</code></div><br/>
<div class="line number7 index6 alt2"><code class="shell plain">1641 </code></div><br/>
<div class="line number8 index7 alt1"><code class="shell plain">1642         xfs_ili_zone =</code></div><br/>
<div class="line number9 index8 alt2"><code class="shell plain">1643                 kmem_zone_init_flags(sizeof(xfs_inode_log_item_t), </code><code class="shell string">&quot;xfs_ili&quot;</code><code class="shell plain">,</code></div><br/>
<div class="line number10 index9 alt1"><code class="shell plain">1644                                         KM_ZONE_SPREAD, NULL);</code></div><br/>
<div class="line number11 index10 alt2"></div><br/>
<div class="line number12 index11 alt1"></div><br/>
<div class="line number13 index12 alt2"><code class="shell spaces"> </code><code class="shell plain">28 typedef struct xfs_inode_log_item {</code></div><br/>
<div class="line number14 index13 alt1"><code class="shell spaces"> </code><code class="shell plain">29         xfs_log_item_t          ili_item;          /<em> common portion </em>/</code></div><br/>
<div class="line number15 index14 alt2"><code class="shell spaces"> </code><code class="shell plain">30         struct xfs_inode        <em>ili_inode;        /</em> inode ptr <em>/</code></div><br/>
<div class="line number16 index15 alt1"><code class="shell spaces"> </code><code class="shell plain">31         xfs_lsn_t               ili_flush_lsn;     /</em> lsn at last flush <em>/</code></div><br/>
<div class="line number17 index16 alt2"><code class="shell spaces"> </code><code class="shell plain">32         xfs_lsn_t               ili_last_lsn;      /</em> lsn at last transaction <em>/</code></div><br/>
<div class="line number18 index17 alt1"><code class="shell spaces"> </code><code class="shell plain">33         unsigned short          ili_lock_flags;    /</em> lock flags <em>/</code></div><br/>
<div class="line number19 index18 alt2"><code class="shell spaces"> </code><code class="shell plain">34         unsigned short          ili_logged;        /</em> flushed logged data <em>/</code></div><br/>
<div class="line number20 index19 alt1"><code class="shell spaces"> </code><code class="shell plain">35         unsigned int            ili_last_fields;   /</em> fields when flushed <em>/</code></div><br/>
<div class="line number21 index20 alt2"><code class="shell spaces"> </code><code class="shell plain">36         unsigned int            ili_fields;        /</em> fields to be logged <em>/</code></div><br/>
<div class="line number22 index21 alt1"><code class="shell spaces"> </code><code class="shell plain">37         struct xfs_bmbt_rec     </em>ili_extents_buf;  /<em> array of logged</code></div><br/>
<div class="line number23 index22 alt2"><code class="shell spaces"> </code><code class="shell plain">38                                                       data exts </em>/</code></div><br/>
<div class="line number24 index23 alt1"><code class="shell spaces"> </code><code class="shell plain">39         struct xfs_bmbt_rec     <em>ili_aextents_buf; /</em> array of logged</code></div><br/>
<div class="line number25 index24 alt2"><code class="shell spaces"> </code><code class="shell plain">40                                                       attr exts <em>/</code></div><br/>
<div class="line number26 index25 alt1"><code class="shell spaces"> </code><code class="shell plain">41         xfs_inode_log_format_t  ili_format;        /</em> logged structure <em>/</code></div><br/>
<div class="line number27 index26 alt2"><code class="shell spaces"> </code><code class="shell plain">42 } xfs_inode_log_item_t;</code></div><br/>
</div></td><br/>
</tr><br/>
</tbody><br/>
</table><br/>
</div><br/>
</div><br/>
分析加估计是文件系统的日志缓存。究竟是不是？目前nfs-server有14个卷，每个卷的在格式化xfs的时指定的参数(即日志大小)-l=128m    14</em>128*1024 约等于1965128。</p>

<p>4.但是xfs_ili xfs_inode两者加起来才10G，还有50G去哪儿了呢？查资料说linux将用过的文件缓存到内存中。</p>

<p>执行下面的命令就释放了内存<br/>
<div><br/>
<div id="highlighter_588566" class="syntaxhighlighter  shell"><br/>
<div class="toolbar"><a class="toolbar_item command_help help" href="http://my.oschina.net/hanhanztj/blog/490308#">?</a></div><br/>
<table border="0" cellspacing="0" cellpadding="0"><br/>
<tbody><br/>
<tr><br/>
<td class="gutter"><br/>
<div class="line number1 index0 alt2">1</div><br/>
<div class="line number2 index1 alt1">2</div><br/>
<div class="line number3 index2 alt2">3</div></td><br/>
<td class="code"><br/>
<div class="container"><br/>
<div class="line number1 index0 alt2"><code class="shell comments">#sync      #</code></div><br/>
<div class="line number2 index1 alt1"><code class="shell plain">刷到磁盘</code></div><br/>
<div class="line number3 index2 alt2"><code class="shell spaces"> </code><code class="shell comments">#echo 3 &gt; /proc/sys/vm/drop_caches</code></div><br/>
</div></td><br/>
</tr><br/>
</tbody><br/>
</table><br/>
</div><br/>
</div><br/>
5.总结：是不是由于内存少导致的性能变差，还在测试。不过以后在优化nfs-server端有一定的指导意义。卷越多，必然占用的内存越多。做机头的内存配置要高。</p>

<p>&nbsp;</p>

    </div>
    <footer class="post-footer clearfix">
      
           
      
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        <a class="button-square" href="https://github.com/showx" target="_blank" title="github">
                               <svg class="svg-inline--fa fa-github fa-w-16" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="fab fa-github fa-lg"></i> -->
                          </a>
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



  













        
      
  
    


    </body>
</html>
